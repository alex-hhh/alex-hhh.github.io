<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <title>Timezone Visualization</title>
    <meta name="description" content="The timezone-boundary-builder project publishes GeoJSON files with timezone boundaries based on OpenStreetMap data, and I though it would be an interesting project to load this data in Racket, build some map visualizations with it and explore some of the ...">
    <meta name="author"      content="Alex Harsányi">
    <meta name="keywords"    content="racket, data visualization">
    <meta name="viewport"    content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/img/favicon.svg">
    <link rel="canonical" href="https://alex-hhh.github.io/2019/05/timezone-visualization.html">
    <link rel="next" href="/2019/04/build-racket-packages-with-azure-pipelines.html">
    <link rel="prev" href="/2019/08/timezone-lookup.html">
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css/pygments.css">
    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Condensed|Roboto+Mono&display=swap" rel="stylesheet">
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml"
          href="/feeds/all.atom.xml" title="Atom Feed">
    <link rel="alternate" type="application/rss+xml"
          href="/feeds/all.rss.xml" title="RSS Feed">
    <!-- JS -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-110325732-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-110325732-1');
    </script>
  </head>
  <body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
      <div class="container">
        <a href="/index.html" class="navbar-brand">Alex Harsányi</a>

        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
                data-target="#navbar_collapse" aria-controls="navbar_collapse"
                aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbar_collapse">
          <ul class="navbar-nav mr-auto">

            <li class="nav-item dropdown">
              <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">
                Tags <b class="caret"></b></a>
              <ul class="dropdown-menu" role="menu" id="tags-menu-content">
                <!-- will be filled in dynamically by custom.js -->
              </ul>
            </li>
            <li>
              <a class="nav-link" href="/About.html">About</a>
            </li> 
            <li>
              <a class="nav-link" href="/tags/arduino.html">Arduino</a>
            </li> 
            <li>
              <a class="nav-link" href="/tags/racket.html">Racket</a>
            </li> 
            <li>
              <a class="nav-link" href="/tags/activitylog2.html">ActivityLog2</a>
            </li> 
          </ul>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="row">

        <!-- Main column -->
        <!-- NOTE: there is a bug in the web server template renderer which
             indents all items inside if blocks.  This means that we cannot
             put the contents inside an if block, as all the <pre> tags will
             be indented.
          -->
        <div id="content" class=col-md-9>





          <article>
  <header>
    <h1>Timezone Visualization</h1>
    <p class='date-and-tags'>
<time datetime="2019-05-18" pubdate="true">2019-05-18</time> :: <span class="tags"><a href="/tags/racket.html">racket</a>, <a href="/tags/data-visualization.html">data visualization</a></span></p>
  </header>

<p>The <a href="https://github.com/evansiroky/timezone-boundary-builder">timezone-boundary-builder</a> project publishes <a href="https://en.wikipedia.org/wiki/GeoJSON">GeoJSON</a> files with timezone boundaries based on <a href="https://www.openstreetmap.org">OpenStreetMap</a> data, and I though it would be an interesting project to load this data in Racket, build some map visualizations with it and explore some of the Racket drawing facilities.</p>
<!-- more-->

<div class="figure"><img src="/img/a026/timezone-map.png" alt="" />
 <p class="caption"></p></div>

<p>The GeoJSON files can be downloaded from the <a href="https://github.com/evansiroky/timezone-boundary-builder/releases">releases section</a> section of the timezone-boundary-builder project. There are two sets of files: one contains timezone data for the oceans and one only contains timezone data for the countries. In the examples below, I used the country data only, as this produces nicer maps. Besides, on the oceans, the timezones match the longitude boundaries of the globe.</p>

<h2 id="loading-and-inspecting-the-geojson-file">Loading and inspecting the GeoJSON file</h2>

<p>The GeoJSON timezone data can be loaded into Racket using <code>read-json</code>, and it takes about 25 seconds to load the 127Mb JSON file when using Racket 7.3 &mdash; this actually is a huge improvement over the previous Racket version which needed about 130 seconds to load the same file.</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="kn">#lang </span><span class="nn">racket</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" style="color: inherit">require</a></span><span class="w"> </span><span class="n">json</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">timezone-data</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/file-ports.html#(def._((lib._racket/private/base..rkt)._call-with-input-file))" style="color: inherit">call-with-input-file</a></span><span class="w"> </span><span class="s2">"./combined.json"</span><span class="w"> </span><span class="n"><a href="http://docs.racket-lang.org/json/index.html#(def._((lib._json/main..rkt)._read-json))" style="color: inherit">read-json</a></span><span class="p">))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>The JSON object is represented in Racket as a hash table for the key/value mappings and as a list for the arrays and this means that the object could be printed directly in the Racket REPL. However, this is a large object containing a lot of data so printing it will take a lot of time and, with a lot of data points printed, it will be difficult to see its structure. It is helpful to write a function to simplify the JSON object, discarding most of the data, so only a subset is shown &mdash; this will not be useful for processing the actual data, but it will help with having a smaller data structure on which to test the processing functions defined later. The function <code>random-sample</code> defined below does this: it creates a copy of its input object, but only keeps <code>max-size</code> items from the sublists inside the object:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/random..rkt)._random-sample))" style="color: inherit">random-sample</a></span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="p">[</span><span class="n">max-size</span><span class="w"> </span><span class="mi">5</span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._cond))" style="color: inherit">cond</a></span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash~3f))" style="color: inherit">hash?</a></span><span class="w"> </span><span class="n">object</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/hash))" style="color: inherit">for/hash</a></span><span class="w"> </span><span class="p">([(</span><span class="n">k</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-hash))" style="color: inherit">in-hash</a></span><span class="w"> </span><span class="n">object</span><span class="p">)])</span><span class="w"></span>
<span class="w">       </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._values))" style="color: inherit">values</a></span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/random..rkt)._random-sample))" style="color: inherit">random-sample</a></span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="n">max-size</span><span class="p">))))</span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list~3f))" style="color: inherit">list?</a></span><span class="w"> </span><span class="n">object</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span><span class="w"> </span><span class="p">([</span><span class="n">len</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._length))" style="color: inherit">length</a></span><span class="w"> </span><span class="n">object</span><span class="p">)])</span><span class="w"></span>
<span class="w">       </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="n">max-size</span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span><span class="w"> </span><span class="p">([</span><span class="n">samples</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/list..rkt)._sort))" style="color: inherit">sort</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/list..rkt)._build-list))" style="color: inherit">build-list</a></span><span class="w"> </span><span class="n">max-size</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" style="color: inherit">lambda</a></span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/private/base..rkt)._random))" style="color: inherit">random</a></span><span class="w"> </span><span class="n">len</span><span class="p">)))</span><span class="w"> </span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span><span class="p">)])</span><span class="w"></span>
<span class="w">             </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" style="color: inherit">for/list</a></span><span class="w"> </span><span class="p">([(</span><span class="n">x</span><span class="w"> </span><span class="n">position</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-indexed))" style="color: inherit">in-indexed</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span><span class="w"> </span><span class="n">object</span><span class="p">))]</span><span class="w"></span>
<span class="w">                        </span><span class="kd">#:when</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/base..rkt)._member))" style="color: inherit">member</a></span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="n">samples</span><span class="p">))</span><span class="w"></span>
<span class="w">               </span><span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/random..rkt)._random-sample))" style="color: inherit">random-sample</a></span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">max-size</span><span class="p">)))</span><span class="w"></span>
<span class="w">           </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" style="color: inherit">for/list</a></span><span class="w"> </span><span class="p">([</span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span><span class="w"> </span><span class="n">object</span><span class="p">)])</span><span class="w"></span>
<span class="w">             </span><span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/random..rkt)._random-sample))" style="color: inherit">random-sample</a></span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">max-size</span><span class="p">)))))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="no">#t</span><span class="w"></span>
<span class="w">     </span><span class="n">object</span><span class="p">)))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>Running the code on the timezone data produces the output below, which is easier to follow when trying to write data manipulation functions for the timezone data:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span><span class="w"> </span><span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/random..rkt)._random-sample))" style="color: inherit">random-sample</a></span><span class="w"> </span><span class="n">timezone-data</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="o">'#hash</span><span class="p">((</span><span class="ss">features</span><span class="w"></span>
<span class="w">        </span><span class="o">.</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="o">#hash</span><span class="p">((</span><span class="ss">geometry</span><span class="w"></span>
<span class="w">                </span><span class="o">.</span><span class="w"></span>
<span class="w">                </span><span class="o">#hash</span><span class="p">((</span><span class="ss">coordinates</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="p">(((</span><span class="mf">31.5209</span><span class="w"> </span><span class="mf">-27.31543</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mf">30.91294</span><span class="w"> </span><span class="mf">-26.86306</span><span class="p">))))</span><span class="w"></span>
<span class="w">                      </span><span class="p">(</span><span class="ss">type</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s2">"Polygon"</span><span class="p">)))</span><span class="w"></span>
<span class="w">               </span><span class="p">(</span><span class="ss">properties</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="o">#hash</span><span class="p">((</span><span class="ss">tzid</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s2">"Africa/Mbabane"</span><span class="p">)))</span><span class="w"></span>
<span class="w">               </span><span class="p">(</span><span class="ss">type</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s2">"Feature"</span><span class="p">))</span><span class="w"></span>
<span class="w">         </span><span class="o">#hash</span><span class="p">((</span><span class="ss">geometry</span><span class="w"></span>
<span class="w">                </span><span class="o">.</span><span class="w"></span>
<span class="w">                </span><span class="o">#hash</span><span class="p">((</span><span class="ss">coordinates</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="p">((((</span><span class="mf">72.452033</span><span class="w"> </span><span class="mf">-5.430984</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mf">71.531301</span><span class="w"> </span><span class="mf">-5.286587</span><span class="p">)))</span><span class="w"></span>
<span class="w">                                      </span><span class="p">(((</span><span class="mf">72.531264</span><span class="w"> </span><span class="mf">-7.062455</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mf">72.153049</span><span class="w"> </span><span class="mf">-7.249701</span><span class="p">)))))</span><span class="w"></span>
<span class="w">                      </span><span class="p">(</span><span class="ss">type</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s2">"MultiPolygon"</span><span class="p">)))</span><span class="w"></span>
<span class="w">               </span><span class="p">(</span><span class="ss">properties</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="o">#hash</span><span class="p">((</span><span class="ss">tzid</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s2">"Indian/Chagos"</span><span class="p">)))</span><span class="w"></span>
<span class="w">               </span><span class="p">(</span><span class="ss">type</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s2">"Feature"</span><span class="p">))))</span><span class="w"></span>
<span class="w">       </span><span class="p">(</span><span class="ss">type</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s2">"FeatureCollection"</span><span class="p">))</span><span class="w"></span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>The <code>json-write</code> function can be used to write out the result in JSON format, and this can be used to generate smaller subsets of the data, after all, it takes about half a minute to load the actual data, which can be too much when the program is evaluated repeatedly during development.</p>

<div class="brush: json">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">"type"</span><span class="p">:</span><span class="s2">"FeatureCollection"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">"features"</span><span class="p">:[</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">"type"</span><span class="p">:</span><span class="s2">"Feature"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"geometry"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">"type"</span><span class="p">:</span><span class="s2">"Polygon"</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">"coordinates"</span><span class="p">:[[[</span><span class="mf">31.5209</span><span class="p">,</span><span class="mf">-27.31543</span><span class="p">],[</span><span class="mf">30.91294</span><span class="p">,</span><span class="mf">-26.86306</span><span class="p">]]]</span><span class="w"></span>
<span class="w">            </span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="nt">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">"tzid"</span><span class="p">:</span><span class="s2">"Africa/Mbabane"</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">"type"</span><span class="p">:</span><span class="s2">"Feature"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"geometry"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">"type"</span><span class="p">:</span><span class="s2">"MultiPolygon"</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">"coordinates"</span><span class="p">:[[[[</span><span class="mf">72.452033</span><span class="p">,</span><span class="mf">-5.430984</span><span class="p">],[</span><span class="mf">71.531301</span><span class="p">,</span><span class="mf">-5.286587</span><span class="p">]]],</span><span class="w"></span>
<span class="w">                               </span><span class="p">[[[</span><span class="mf">72.531264</span><span class="p">,</span><span class="mf">-7.062455</span><span class="p">],[</span><span class="mf">72.153049</span><span class="p">,</span><span class="mf">-7.249701</span><span class="p">]]]]</span><span class="w"></span>
<span class="w">            </span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="nt">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">"tzid"</span><span class="p">:</span><span class="s2">"Indian/Chagos"</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>With the simplified version, it is easy to follow the structure of the JSON file. The <a href="https://en.wikipedia.org/wiki/GeoJSON">Wikipedia GeoJSON</a> article explains the overall structure of a GeoJSON document, but here is a summary:</p>

<ul>
 <li>all GeoJSON objects have a <code>type</code> key describing their type</li>
 <li>the toplevel object is a &ldquo;FeatureCollection&rdquo; with the <code>features</code> key mapping  to a list of GeoJSON objects, each feature defining a time zone boundary.</li>
 <li>each feature has a <code>type</code> of &ldquo;Feature&rdquo;, a <code>geometry</code> defining the boundary  of the timezone and a <code>properties</code> key which contains the timezone name in  the <code>tzid</code> property. The name of the timezones are the same as the <a href="https://www.iana.org/time-zones">IANA  Timezones</a>.</li>
 <li>The geometry of each time zone is a list of GPS points defining the contour  the zone. Sometimes a time zone is defined by multiple contours, and this  is shown by a &ldquo;MultiPolygon&rdquo; geometry type.</li></ul>

<p>Since Racket represents a JSON object using hash tables and lists, it is easy to write functions which manipulate the data. For example, to find out how many timezones there are, we can count the number of features in the object:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._length))" style="color: inherit">length</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash-ref))" style="color: inherit">hash-ref</a></span><span class="w"> </span><span class="n">timezone-data</span><span class="w"> </span><span class="o">'</span><span class="ss">features</span><span class="p">))</span><span class="w"></span>
<span class="mi">426</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>As an exercise, I wrote some functions to count the number of points in the database as well as in all the timezones. The program is available in <a href="https://gist.github.com/alex-hhh/cdedfb550bb68411bd2331c8f4d2c421">this github gist</a> (the &ldquo;example0.rkt&rdquo; file), and here is a summary of its findings: there are 426 timezones and all of them are defined using 5&prime;728&prime;474 GPS points. Here is a list of the timezones defined by the largest number of points &mdash; the number of points does not seem to correlate with the actual size of the timezone:</p>

<div class="table-responsive">
 <table class="table table-striped table-hover">
  <thead>
   <tr>
    <td><strong>TimeZone</strong></td>
    <td style="text-align: right"><strong>Point Count</strong></td>
    <td><strong>TimeZone</strong></td>
    <td style="text-align: right"><strong>PointCount</strong></td></tr></thead>
  <tbody>
   <tr>
    <td>Europe/Berlin</td>
    <td style="text-align: right">142&prime;178</td>
    <td>Asia/Shanghai</td>
    <td style="text-align: right">123&prime;836</td></tr>
   <tr>
    <td>America/Santiago</td>
    <td style="text-align: right">118&prime;996</td>
    <td>Europe/Vienna</td>
    <td style="text-align: right">110&prime;643</td></tr>
   <tr>
    <td>Asia/Kolkata</td>
    <td style="text-align: right">94&prime;538</td>
    <td>Europe/Prague</td>
    <td style="text-align: right">92&prime;587</td></tr>
   <tr>
    <td>Europe/Moscow</td>
    <td style="text-align: right">90&prime;441</td>
    <td>Asia/Karachi</td>
    <td style="text-align: right">75&prime;744</td></tr>
   <tr>
    <td>Asia/Krasnoyarsk</td>
    <td style="text-align: right">73&prime;401</td>
    <td>Asia/Bangkok</td>
    <td style="text-align: right">73&prime;017</td></tr>
   <tr>
    <td>Asia/Yakutsk</td>
    <td style="text-align: right">70&prime;839</td>
    <td>Asia/Vladivostok</td>
    <td style="text-align: right">70&prime;588</td></tr>
   <tr>
    <td>Africa/Johannesburg</td>
    <td style="text-align: right">61&prime;474</td>
    <td>Asia/Yekaterinburg</td>
    <td style="text-align: right">57&prime;482</td></tr>
   <tr>
    <td>Asia/Tehran</td>
    <td style="text-align: right">56&prime;481</td>
    <td>Europe/Paris</td>
    <td style="text-align: right">56&prime;370</td></tr>
   <tr>
    <td>Africa/Lubumbashi</td>
    <td style="text-align: right">55&prime;929</td>
    <td>Asia/Irkutsk</td>
    <td style="text-align: right">54&prime;693</td></tr>
   <tr>
    <td>Europe/Rome</td>
    <td style="text-align: right">54&prime;293</td>
    <td>Asia/Urumqi</td>
    <td style="text-align: right">52&prime;500</td></tr></tbody></table></div>

<h2 id="drawing-the-timezone-boundaries-as-a-map">Drawing the timezone boundaries as a map</h2>

<p>The best way to look at GeoJSON data is to draw it on a map, so in the next section we&rsquo;ll explore how to draw these timezones using Racket and will produce the picture shown at the top of the blog post. However, this task requires some more advanced use of Racket&rsquo;s drawing capabilities and before we can look at it, it is worth refreshing some of the more important concepts.</p>

<h3 id="racket-drawing-toolkit-refresher">Racket Drawing Toolkit Refresher</h3>

<h4 id="drawing-contexts">Drawing Contexts</h4>

<p>Drawing in Racket is done using a <a href="https://docs.racket-lang.org/draw/dc___.html">drawing context</a>, which is an abstract interface for drawing commands. A drawing context can be created for a <a href="https://docs.racket-lang.org/gui/canvas_.html">canvas%</a> for drawing in a GUI application or a bitmap for drawing on a bitmap, and, regardless of where the drawing will be displayed, the drawing commands are the same. Here is an example on how to create a bitmap containing a red rectangle:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="kn">#lang </span><span class="nn">racket</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" style="color: inherit">require</a></span><span class="w"> </span><span class="n">racket/draw</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">bitmap-dc%</span><span class="w"> </span><span class="p">[</span><span class="n">bitmap</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objcreation.html#(def._((lib._racket/private/class-internal..rkt)._make-object))" style="color: inherit">make-object</a></span><span class="w"> </span><span class="n">bitmap%</span><span class="w"> </span><span class="mi">250</span><span class="w"> </span><span class="mi">250</span><span class="p">)]))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send*))" style="color: inherit">send*</a></span><span class="w"> </span><span class="n">dc</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">set-pen</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">the-pen-list</span><span class="w"> </span><span class="n">find-or-create-pen</span><span class="w"> </span><span class="s2">"black"</span><span class="w"> </span><span class="mf">5.0</span><span class="w"> </span><span class="o">'</span><span class="ss">solid</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">set-brush</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">the-brush-list</span><span class="w"> </span><span class="n">find-or-create-brush</span><span class="w"> </span><span class="s2">"red"</span><span class="w"> </span><span class="o">'</span><span class="ss">solid</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">draw-rectangle</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="mi">250</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="mi">250</span><span class="w"> </span><span class="mi">20</span><span class="p">)))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">bm</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">get-bitmap</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">bm</span><span class="w"> </span><span class="n">save-file</span><span class="w"> </span><span class="s2">"example1.png"</span><span class="w"> </span><span class="o">'</span><span class="ss">png</span><span class="p">)</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>In the example above, the <code>bitmap-dc%</code> is a concrete device context implementing the <code>dc&lt;%&gt;</code> interface and drawing onto a bitmap and once created it is sent three commands: <code>set-pen</code>, <code>set-brush</code> and <code>draw-rectangle</code>. The drawing commands, such as <code>draw-rectangle</code> will use the currently set pen for the outline of the drawing and the currently set brush for the &ldquo;fill&rdquo;. Pen and Brush objects use up drawing resources and to avoid unnecessary creation of identical pen and brushes, <code>the-pen-list</code> and <code>the-brush-list</code> databases can be used: they will create a new resource if needed, but otherwise just return a previously created one. Finally, a bitmap object can be saved into a file using <code>save-file</code>. The result is not very exciting yet:</p>

<div class="figure"><img src="/img/a026/example1.png" alt="" />
 <p class="caption"></p></div>

<h4 id="context-scale-and-offset">Context Scale and Offset</h4>

<p>By default, a device context has the origin (0, 0) in the top left corner and its size is the same as the underlying target bitmap or canvas. Drawing commands must take these into account if they want to draw things relative to some anchor points: for example, to draw a vertical line in the middle of the device context, its size must be retrieved, and the middle point calculated, as it will be different depending on the size of the canvas. An alternative is to change the coordinate system and scale of the device context to known values, so that drawing commands are always done in known coordinates. In the example below, the origin of the device context is moved to its middle and the device is scaled such that the device context coordinates are always between &ndash;1 and 1. With this setup, the drawing commands are now independent of the size of the bitmap, and drawing a vertical line in the middle is always done using <code>draw-line 0 -1 0 1</code>:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="kn">#lang </span><span class="nn">racket</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" style="color: inherit">require</a></span><span class="w"> </span><span class="n">racket/draw</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">bitmap-dc%</span><span class="w"> </span><span class="p">[</span><span class="n">bitmap</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objcreation.html#(def._((lib._racket/private/class-internal..rkt)._make-object))" style="color: inherit">make-object</a></span><span class="w"> </span><span class="n">bitmap%</span><span class="w"> </span><span class="mi">250</span><span class="w"> </span><span class="mi">250</span><span class="p">)]))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send*))" style="color: inherit">send*</a></span><span class="w"> </span><span class="n">dc</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">set-origin</span><span class="w"> </span><span class="m">250/2</span><span class="w"> </span><span class="m">250/2</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">set-scale</span><span class="w"> </span><span class="m">250/2</span><span class="w"> </span><span class="m">250/2</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">set-pen</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">the-pen-list</span><span class="w"> </span><span class="n">find-or-create-pen</span><span class="w"> </span><span class="s2">"black"</span><span class="w"> </span><span class="mf">0.00001</span><span class="w"> </span><span class="o">'</span><span class="ss">solid</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">set-brush</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">the-brush-list</span><span class="w"> </span><span class="n">find-or-create-brush</span><span class="w"> </span><span class="s2">"black"</span><span class="w"> </span><span class="o">'</span><span class="ss">transparent</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">draw-rectangle</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">set-brush</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">the-brush-list</span><span class="w"> </span><span class="n">find-or-create-brush</span><span class="w"> </span><span class="s2">"red"</span><span class="w"> </span><span class="o">'</span><span class="ss">solid</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">draw-line</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">draw-line</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">bm</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">get-bitmap</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">bm</span><span class="w"> </span><span class="n">save-file</span><span class="w"> </span><span class="s2">"example2.png"</span><span class="w"> </span><span class="o">'</span><span class="ss">png</span><span class="p">)</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<div class="figure"><img src="/img/a026/example2.png" alt="" />
 <p class="caption"></p></div>

<h4 id="dc-paths">DC paths</h4>

<p>The device context interface provides primitives for drawing basic shapes, such as lines, rectangles and ellipses, but for more complex shapes, a <a href="https://docs.racket-lang.org/draw/dc-path_.html">dc-path%</a> can be used, this is an object holding a set of lines and curves. A <code>dc-path%</code> can be open or closed, and a closed dc path will have its interior filled with the current brush color. Below is an example of drawing a pentagon using a <code>dc-path%</code>, since we use device scaling, the points for the shape can be defined on the unit circle:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="kn">#lang </span><span class="nn">racket</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" style="color: inherit">require</a></span><span class="w"> </span><span class="n">racket/draw</span><span class="p">)</span><span class="w"></span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">dc-path%</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="n">move-to</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span><span class="w"> </span><span class="p">([</span><span class="n">p</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-range))" style="color: inherit">in-range</a></span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._pi))" style="color: inherit">pi</a></span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._pi))" style="color: inherit">pi</a></span><span class="p">)</span><span class="w"> </span><span class="mi">5</span><span class="p">))])</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._cos))" style="color: inherit">cos</a></span><span class="w"> </span><span class="n">p</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sin))" style="color: inherit">sin</a></span><span class="w"> </span><span class="n">p</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="n">line-to</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="n">close</span><span class="p">)</span><span class="w"></span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">bitmap-dc%</span><span class="w"> </span><span class="p">[</span><span class="n">bitmap</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objcreation.html#(def._((lib._racket/private/class-internal..rkt)._make-object))" style="color: inherit">make-object</a></span><span class="w"> </span><span class="n">bitmap%</span><span class="w"> </span><span class="mi">250</span><span class="w"> </span><span class="mi">250</span><span class="p">)]))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send*))" style="color: inherit">send*</a></span><span class="w"> </span><span class="n">dc</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">set-smoothing</span><span class="w"> </span><span class="o">'</span><span class="ss">smoothed</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">set-scale</span><span class="w"> </span><span class="m">250/2</span><span class="w"> </span><span class="m">250/2</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">set-origin</span><span class="w"> </span><span class="m">250/2</span><span class="w"> </span><span class="m">250/2</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">set-pen</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">the-pen-list</span><span class="w"> </span><span class="n">find-or-create-pen</span><span class="w"> </span><span class="s2">"black"</span><span class="w"> </span><span class="mf">0.01</span><span class="w"> </span><span class="o">'</span><span class="ss">solid</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">set-brush</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">the-brush-list</span><span class="w"> </span><span class="n">find-or-create-brush</span><span class="w"> </span><span class="s2">"red"</span><span class="w"> </span><span class="o">'</span><span class="ss">solid</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">draw-path</span><span class="w"> </span><span class="n">path</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">bm</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">get-bitmap</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">bm</span><span class="w"> </span><span class="n">save-file</span><span class="w"> </span><span class="s2">"example3.png"</span><span class="w"> </span><span class="o">'</span><span class="ss">png</span><span class="p">)</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<div class="figure"><img src="/img/a026/example3.png" alt="" />
 <p class="caption"></p></div>

<h3 id="drawing-the-timezone-map">Drawing the timezone map</h3>

<p>The overall process for drawing the timezones is straightforward: for each time zone (which is a feature in the GeoJSON file), construct a <code>dc-path%</code> with all the points that are part of its definition, than render the path using a distinct color. There are, however, a few details to discuss.</p>

<p>The toplevel function for drawing the bitmap takes as parameters the timezone GeoJSON data and the width and height of the desired bitmap. It sets up a bitmap device context, and sets its scale such that the entire drawing area is from 0 to 1, it than iterates over the features in the GeoJSON file (each feature is a timezone shape definition), it assigns a brush color for filling in the area, than calls <code>draw-feature</code> to draw the actual timezone shape.</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">make-timezone-bitmap</span><span class="w"> </span><span class="n">tzdata</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">bitmap-dc%</span><span class="w"> </span><span class="p">[</span><span class="n">bitmap</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objcreation.html#(def._((lib._racket/private/class-internal..rkt)._make-object))" style="color: inherit">make-object</a></span><span class="w"> </span><span class="n">bitmap%</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="n">height</span><span class="p">)]))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send*))" style="color: inherit">send*</a></span><span class="w"> </span><span class="n">dc</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">set-scale</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">set-smoothing</span><span class="w"> </span><span class="o">'</span><span class="ss">smoothed</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">set-pen</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">the-pen-list</span><span class="w"> </span><span class="n">find-or-create-pen</span><span class="w"> </span><span class="s2">"black"</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">width</span><span class="p">))</span><span class="w"> </span><span class="o">'</span><span class="ss">solid</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="c1">;; Iterate over each feature (timezone) and render it</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span><span class="w"> </span><span class="p">([</span><span class="n">feature</span><span class="w">  </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash-ref))" style="color: inherit">hash-ref</a></span><span class="w"> </span><span class="n">tzdata</span><span class="w"> </span><span class="o">'</span><span class="ss">features</span><span class="p">))]</span><span class="w"></span>
<span class="w">          </span><span class="p">[</span><span class="n">color</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-cycle))" style="color: inherit">in-cycle</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span><span class="w"> </span><span class="n">color-map</span><span class="p">))])</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">set-brush</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">the-brush-list</span><span class="w"> </span><span class="n">find-or-create-brush</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">'</span><span class="ss">solid</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">draw-feature</span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">feature</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">get-bitmap</span><span class="p">))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>Ideally, we would like to render each time zone in a distinct color, but for now, the code just cycles through a palette of colors, which means that some timezones will share the same color. For completeness, here is the color table, which is a list of <code>color%</code> objects:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">color-map</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objcreation.html#(def._((lib._racket/private/class-internal..rkt)._make-object))" style="color: inherit">make-object</a></span><span class="w"> </span><span class="n">color%</span><span class="w"> </span><span class="mi">78</span><span class="w"> </span><span class="mi">121</span><span class="w"> </span><span class="mi">165</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objcreation.html#(def._((lib._racket/private/class-internal..rkt)._make-object))" style="color: inherit">make-object</a></span><span class="w"> </span><span class="n">color%</span><span class="w"> </span><span class="mi">241</span><span class="w"> </span><span class="mi">143</span><span class="w"> </span><span class="mi">59</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objcreation.html#(def._((lib._racket/private/class-internal..rkt)._make-object))" style="color: inherit">make-object</a></span><span class="w"> </span><span class="n">color%</span><span class="w"> </span><span class="mi">224</span><span class="w"> </span><span class="mi">88</span><span class="w"> </span><span class="mi">91</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objcreation.html#(def._((lib._racket/private/class-internal..rkt)._make-object))" style="color: inherit">make-object</a></span><span class="w"> </span><span class="n">color%</span><span class="w"> </span><span class="mi">119</span><span class="w"> </span><span class="mi">183</span><span class="w"> </span><span class="mi">178</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objcreation.html#(def._((lib._racket/private/class-internal..rkt)._make-object))" style="color: inherit">make-object</a></span><span class="w"> </span><span class="n">color%</span><span class="w"> </span><span class="mi">90</span><span class="w"> </span><span class="mi">161</span><span class="w"> </span><span class="mi">85</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objcreation.html#(def._((lib._racket/private/class-internal..rkt)._make-object))" style="color: inherit">make-object</a></span><span class="w"> </span><span class="n">color%</span><span class="w"> </span><span class="mi">237</span><span class="w"> </span><span class="mi">201</span><span class="w"> </span><span class="mi">88</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objcreation.html#(def._((lib._racket/private/class-internal..rkt)._make-object))" style="color: inherit">make-object</a></span><span class="w"> </span><span class="n">color%</span><span class="w"> </span><span class="mi">175</span><span class="w"> </span><span class="mi">122</span><span class="w"> </span><span class="mi">160</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objcreation.html#(def._((lib._racket/private/class-internal..rkt)._make-object))" style="color: inherit">make-object</a></span><span class="w"> </span><span class="n">color%</span><span class="w"> </span><span class="mi">254</span><span class="w"> </span><span class="mi">158</span><span class="w"> </span><span class="mi">168</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objcreation.html#(def._((lib._racket/private/class-internal..rkt)._make-object))" style="color: inherit">make-object</a></span><span class="w"> </span><span class="n">color%</span><span class="w"> </span><span class="mi">156</span><span class="w"> </span><span class="mi">117</span><span class="w"> </span><span class="mi">97</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objcreation.html#(def._((lib._racket/private/class-internal..rkt)._make-object))" style="color: inherit">make-object</a></span><span class="w"> </span><span class="n">color%</span><span class="w"> </span><span class="mi">186</span><span class="w"> </span><span class="mi">176</span><span class="w"> </span><span class="mi">172</span><span class="p">)))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>The <code>draw-feature</code> function will retrieve the coordinates for the timezone and call <code>draw-polygon</code>, or if the feature is a multi-polygon, it will call <code>draw-polygon</code> for each polygon in the timezone definition, since a timezone can be defined by multiple polygons.</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">draw-feature</span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">feature</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let*))" style="color: inherit">let*</a></span><span class="w"> </span><span class="p">([</span><span class="n">geometry</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash-ref))" style="color: inherit">hash-ref</a></span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="o">'</span><span class="ss">geometry</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" style="color: inherit">lambda</a></span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash))" style="color: inherit">hash</a></span><span class="p">)))]</span><span class="w"></span>
<span class="w">         </span><span class="p">[</span><span class="n">data</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash-ref))" style="color: inherit">hash-ref</a></span><span class="w"> </span><span class="n">geometry</span><span class="w"> </span><span class="o">'</span><span class="ss">coordinates</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" style="color: inherit">lambda</a></span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._null))" style="color: inherit">null</a></span><span class="p">))])</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/case.html#(form._((lib._racket/private/more-scheme..rkt)._case))" style="color: inherit">case</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash-ref))" style="color: inherit">hash-ref</a></span><span class="w"> </span><span class="n">geometry</span><span class="w"> </span><span class="o">'</span><span class="ss">type</span><span class="w"> </span><span class="no">#f</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">((</span><span class="s2">"Polygon"</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">draw-polygon</span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">data</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="p">((</span><span class="s2">"MultiPolygon"</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span><span class="w"> </span><span class="p">([</span><span class="n">polygon</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span><span class="w"> </span><span class="n">data</span><span class="p">)])</span><span class="w"> </span><span class="p">(</span><span class="n">draw-polygon</span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">polygon</span><span class="p">)))</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._else))" style="color: inherit">else</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._printf))" style="color: inherit">printf</a></span><span class="w"> </span><span class="s2">"Skipping <a href="http://docs.racket-lang.org/reference/strings.html#(def._((lib._racket/format..rkt)._~7ea))" style="color: inherit">~a</a> geometry"</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash-ref))" style="color: inherit">hash-ref</a></span><span class="w"> </span><span class="n">geometry</span><span class="w"> </span><span class="o">'</span><span class="ss">type</span><span class="w"> </span><span class="no">#f</span><span class="p">))))))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>The <code>draw-polygon</code> function receives a polygon, which is a list of GPS coordinates, constructs a closed <code>dc-path%</code> from them and draws it onto the device context. A GeoJSON polygon is actually defined as a list of lists, the first list being the &ldquo;outside&rdquo; polygon, and the remaining one are the &ldquo;holes&rdquo; inside the main shape. The code below uses sub-paths of the main <code>dc-path%</code> to create these holes.</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">draw-polygon</span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">polygons</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">path</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/fold))" style="color: inherit">for/fold</a></span><span class="w"> </span><span class="p">([</span><span class="n">path</span><span class="w"> </span><span class="no">#f</span><span class="p">])</span><span class="w"> </span><span class="p">([</span><span class="n">polygon</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span><span class="w"> </span><span class="n">polygons</span><span class="p">)]</span><span class="w"> </span><span class="kd">#:unless</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._null~3f))" style="color: inherit">null?</a></span><span class="w"> </span><span class="n">polygon</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">sub-path</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">dc-path%</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send/apply))" style="color: inherit">send/apply</a></span><span class="w"> </span><span class="n">sub-path</span><span class="w"> </span><span class="n">move-to</span><span class="w"> </span><span class="p">(</span><span class="n">lat-lon-&gt;map-point</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._car))" style="color: inherit">car</a></span><span class="w"> </span><span class="n">polygon</span><span class="p">)))</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span><span class="w"> </span><span class="p">([</span><span class="n">point</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cdr))" style="color: inherit">cdr</a></span><span class="w"> </span><span class="n">polygon</span><span class="p">))])</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send/apply))" style="color: inherit">send/apply</a></span><span class="w"> </span><span class="n">sub-path</span><span class="w"> </span><span class="n">line-to</span><span class="w"> </span><span class="p">(</span><span class="n">lat-lon-&gt;map-point</span><span class="w"> </span><span class="n">point</span><span class="p">)))</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">sub-path</span><span class="w"> </span><span class="n">close</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" style="color: inherit">begin</a></span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._append))" style="color: inherit">append</a></span><span class="w"> </span><span class="n">sub-path</span><span class="p">)</span><span class="w"> </span><span class="n">path</span><span class="p">)</span><span class="w"> </span><span class="n">sub-path</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">draw-path</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>Finally, the <code>lat-lon-&gt;map-point</code> function takes a pair of GPS coordinates (latitude, longitude) and converts them into normalized coordinates which are values between 0 and 1, where 0 and 1 are the edges of the map. The projection we use here is Mercator, which is what is used by most maps, but any projection would be adequate for the task. Note that the device context scale shows its usefulness here: since the device is scaled, the normalized coordinates can be drawn directly onto the device context, without having to worry about adjusting them. Also, changing the rest of the code does not need to worry about changing the size of the bitmap.</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">lat-lon-&gt;map-point</span><span class="w"> </span><span class="n">coordinates</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match-define))" style="color: inherit">match-define</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span><span class="w"> </span><span class="n">lon</span><span class="w"> </span><span class="n">lat</span><span class="w"> </span><span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span><span class="w"> </span><span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" style="color: inherit">...</a></span><span class="p">)</span><span class="w"> </span><span class="n">coordinates</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((quote._~23~25kernel)._define-values))" style="color: inherit">define-values</a></span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._values))" style="color: inherit">values</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._degrees-~3eradians))" style="color: inherit">degrees-&gt;radians</a></span><span class="w"> </span><span class="n">lon</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">asinh</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._tan))" style="color: inherit">tan</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._degrees-~3eradians))" style="color: inherit">degrees-&gt;radians</a></span><span class="w"> </span><span class="n">lat</span><span class="p">)))))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._pi))" style="color: inherit">pi</a></span><span class="p">))</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._pi))" style="color: inherit">pi</a></span><span class="p">))</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>You can find the entire program as a <a href="https://gist.github.com/alex-hhh/cdedfb550bb68411bd2331c8f4d2c421">github gist</a> (the "example4.rkt file), and the output is shown below. The entire program is less than 100 lines long and only uses standard Racket libraries and no external packages.</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">timezone-data</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/file-ports.html#(def._((lib._racket/private/base..rkt)._call-with-input-file))" style="color: inherit">call-with-input-file</a></span><span class="w"> </span><span class="s2">"./combined.json"</span><span class="w"> </span><span class="n"><a href="http://docs.racket-lang.org/json/index.html#(def._((lib._json/main..rkt)._read-json))" style="color: inherit">read-json</a></span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">bm</span><span class="w"> </span><span class="p">(</span><span class="n">make-timezone-bitmap</span><span class="w"> </span><span class="n">timezone-data</span><span class="w"> </span><span class="mi">800</span><span class="w"> </span><span class="mi">500</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">bm</span><span class="w"> </span><span class="n">save-file</span><span class="w"> </span><span class="s2">"timezone-map.png"</span><span class="w"> </span><span class="o">'</span><span class="ss">png</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="kd">#:unscaled?</span><span class="w"> </span><span class="no">#t</span><span class="p">)</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>The final result is shown below, but the map requires some explanations. First, the Mercator projection used for the map does not work very well at high latitudes and breaks down at extreme ones, so Antarctica looks unfamiliar, this is not helped by the fact that parts of Antarctica are not covered by any timezones. Second, the white area of the map represents oceans, where no specific timezones are defined &mdash; in these area, the timezone can be directly determined from the longitude &mdash; the <a href="https://github.com/evansiroky/timezone-boundary-builder/releases">timezone-boundary-builder</a> project also provides GeoJSON files with timezones for the ocean areas. Finally, these are timezone boundaries, not country boundaries, and, while some countries can be recognizable, other are not.</p>

<div class="figure"><img src="/img/a026/timezone-map.png" alt="" />
 <p class="caption"></p></div>

<h3 id="unique-timezone-colors">Unique timezone colors</h3>

<p>The code above cycled through a color map containing only 10 unique colors. While it produced a pleasing result, many timezones share the same colors, including sometimes neighboring colors. While 4 colors are sufficient to color any map, such that no adjacent regions have the same color, it is much simpler to just assign a unique color to each time zone.</p>

<p>The idea behind this is to allocate a unique ID to each time zone, than allocate colors for each of these IDs. The <code>tzdata</code> structure keeps information about a time zone, its ID and color. The <code>allocate-tzdata</code> will create a list of <code>tzdata</code> structures, assign an unique ID by incrementing a counter and creating a <code>color%</code> object for it:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define-struct.html#(form._((lib._racket/private/base..rkt)._struct))" style="color: inherit">struct</a></span><span class="w"> </span><span class="n">tzdata</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n"><a href="http://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#(form._((lib._syntax/parse..rkt)._id))" style="color: inherit">id</a></span><span class="w"> </span><span class="n">color</span><span class="p">)</span><span class="w"> </span><span class="kd">#:transparent</span><span class="p">)</span><span class="w"></span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">allocate-tzdata</span><span class="w"> </span><span class="n">node</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">next-id</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="c1">; start at 1, 0 is reserved for "no tz data", the oceans</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" style="color: inherit">for/list</a></span><span class="w"> </span><span class="p">([</span><span class="n">tznode</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash-ref))" style="color: inherit">hash-ref</a></span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">'</span><span class="ss">features</span><span class="p">))])</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="p">(</span><span class="n">tz-name</span><span class="w"> </span><span class="n">tznode</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n"><a href="http://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#(form._((lib._syntax/parse..rkt)._id))" style="color: inherit">id</a></span><span class="w"> </span><span class="n">next-id</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span><span class="w"> </span><span class="n">next-id</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span><span class="w"> </span><span class="n">next-id</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="p">(</span><span class="n">allocate-color</span><span class="w"> </span><span class="n"><a href="http://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#(form._((lib._syntax/parse..rkt)._id))" style="color: inherit">id</a></span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">tzdata</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n"><a href="http://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#(form._((lib._syntax/parse..rkt)._id))" style="color: inherit">id</a></span><span class="w"> </span><span class="n">color</span><span class="p">)))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>There are multiple ways to generate colors from integer identifiers, but the simplest method is to treat each digit in the number as one of the R, G, B channels, since there are 426 time zones, this seems sufficient. In addition to that, to separate the colors a bit more, each digit in the channel will be multiplied by 28, so each color channel is used evenly. I.e, rather than using 0, 1, &hellip; 9 for the red channel, we&rsquo;ll use 0 * 28, 1 * 28, &hellip; 9 * 28 for these values, and since 9 * 28 is 252, all values will be below the maximum 255 value:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">allocate-color</span><span class="w"> </span><span class="n"><a href="http://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#(form._((lib._syntax/parse..rkt)._id))" style="color: inherit">id</a></span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let*))" style="color: inherit">let*</a></span><span class="w"> </span><span class="p">((</span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._exact-floor))" style="color: inherit">exact-floor</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="n"><a href="http://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#(form._((lib._syntax/parse..rkt)._id))" style="color: inherit">id</a></span><span class="w"> </span><span class="mi">100</span><span class="p">)))</span><span class="w"></span>
<span class="w">         </span><span class="p">(</span><span class="n">g</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._exact-floor))" style="color: inherit">exact-floor</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="n"><a href="http://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#(form._((lib._syntax/parse..rkt)._id))" style="color: inherit">id</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="mi">100</span><span class="p">))</span><span class="w"> </span><span class="mi">10</span><span class="p">)))</span><span class="w"></span>
<span class="w">         </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._exact-floor))" style="color: inherit">exact-floor</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="n"><a href="http://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#(form._((lib._syntax/parse..rkt)._id))" style="color: inherit">id</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="mi">10</span><span class="p">)))))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objcreation.html#(def._((lib._racket/private/class-internal..rkt)._make-object))" style="color: inherit">make-object</a></span><span class="w"> </span><span class="n">color%</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="mi">28</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="mi">28</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="mi">28</span><span class="p">))))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>By the way, the <code>tz-name</code> is just a helper function which retrieves the <code>tzid</code> property of a timezone GeoJSON feature:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">tz-name</span><span class="w"> </span><span class="n">node</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span><span class="w"> </span><span class="p">((</span><span class="n">properties</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash-ref))" style="color: inherit">hash-ref</a></span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">'</span><span class="ss">properties</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash-ref))" style="color: inherit">hash-ref</a></span><span class="w"> </span><span class="n">properties</span><span class="w"> </span><span class="o">'</span><span class="ss">tzid</span><span class="w"> </span><span class="no">#f</span><span class="p">)))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>Finally, the <code>make-timezone-bitmap</code> toplevel function will need to be updated to allocate colors for the timezones and use them for rendering:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">make-timezone-bitmap</span><span class="w"> </span><span class="n">tzdata</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">tz-data</span><span class="w"> </span><span class="p">(</span><span class="n">allocate-tzdata</span><span class="w"> </span><span class="n">timezone-data</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">bitmap-dc%</span><span class="w"> </span><span class="p">[</span><span class="n">bitmap</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objcreation.html#(def._((lib._racket/private/class-internal..rkt)._make-object))" style="color: inherit">make-object</a></span><span class="w"> </span><span class="n">bitmap%</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="n">height</span><span class="p">)]))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send*))" style="color: inherit">send*</a></span><span class="w"> </span><span class="n">dc</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">set-scale</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">set-smoothing</span><span class="w"> </span><span class="o">'</span><span class="ss">smoothed</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">set-pen</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">the-pen-list</span><span class="w"> </span><span class="n">find-or-create-pen</span><span class="w"> </span><span class="s2">"black"</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">width</span><span class="p">))</span><span class="w"> </span><span class="o">'</span><span class="ss">solid</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="c1">;; Iterate over each feature (timezone) and render it</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span><span class="w"> </span><span class="p">([</span><span class="n">feature</span><span class="w">  </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash-ref))" style="color: inherit">hash-ref</a></span><span class="w"> </span><span class="n">tzdata</span><span class="w"> </span><span class="o">'</span><span class="ss">features</span><span class="p">))])</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="p">(</span><span class="n">time-zone-color</span><span class="w"> </span><span class="n">tz-data</span><span class="w"> </span><span class="p">(</span><span class="n">tz-name</span><span class="w"> </span><span class="n">feature</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">set-brush</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">the-brush-list</span><span class="w"> </span><span class="n">find-or-create-brush</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">'</span><span class="ss">solid</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">draw-feature</span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">feature</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">get-bitmap</span><span class="p">))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>The result is shown below. The code does not make use of all colors, since it only uses about half of the colors that could be allocated using our strategy:</p>

<div class="figure"><img src="/img/a026/timezone-map-2.png" alt="" />
 <p class="caption"></p></div>

<h3 id="rendering-a-subset-of-the-map">Rendering a subset of the map</h3>

<p>The <code>set-origin</code> and <code>set-scale</code> methods of a device context can be used to render a subset of the map, without having to change the rest of the rendering code. To render the map between two GPS coordinates, <em>min-coord</em> and <em>max-coord</em>, we&rsquo;ll first have to convert them into normalized coordinates (between 0 and 1) using <code>lat-lon-&gt;map-point</code>, than calculate scaling values such that the X and Y coordinates between the two points correspond to the actual <em>width</em> and <em>height</em> of the bitmap. The origin will have to be translated such that the point at <em>min-coord</em> is at (0,0) &mdash; this has to be a negative adjustment. The <code>setup-dc</code> function below does all this, preparing a device context to render a subset of the map between two GPS locations:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">setup-dc</span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">min-coord</span><span class="w"> </span><span class="n">max-coord</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((quote._~23~25kernel)._define-values))" style="color: inherit">define-values</a></span><span class="w"> </span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">get-size</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match-define))" style="color: inherit">match-define</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span><span class="w"> </span><span class="n">xmin</span><span class="w"> </span><span class="n">ymin</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">lat-lon-&gt;map-point</span><span class="w"> </span><span class="n">min-coord</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match-define))" style="color: inherit">match-define</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span><span class="w"> </span><span class="n">xmax</span><span class="w"> </span><span class="n">ymax</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">lat-lon-&gt;map-point</span><span class="w"> </span><span class="n">max-coord</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((quote._~23~25kernel)._define-values))" style="color: inherit">define-values</a></span><span class="w"> </span><span class="p">(</span><span class="n">xscale</span><span class="w"> </span><span class="n">yscale</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._values))" style="color: inherit">values</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="n">xmax</span><span class="w"> </span><span class="n">xmin</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="n">ymax</span><span class="w"> </span><span class="n">ymin</span><span class="p">))))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((quote._~23~25kernel)._define-values))" style="color: inherit">define-values</a></span><span class="w"> </span><span class="p">(</span><span class="n">xorigin</span><span class="w"> </span><span class="n">yorigin</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._values))" style="color: inherit">values</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="n">xmin</span><span class="w"> </span><span class="n">xscale</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="n">ymin</span><span class="w"> </span><span class="n">yscale</span><span class="p">))))</span><span class="w"></span>

<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send*))" style="color: inherit">send*</a></span><span class="w"> </span><span class="n">dc</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">set-origin</span><span class="w"> </span><span class="n">xorigin</span><span class="w"> </span><span class="n">yorigin</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">set-scale</span><span class="w"> </span><span class="n">xscale</span><span class="w"> </span><span class="n">yscale</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">set-smoothing</span><span class="w"> </span><span class="o">'</span><span class="ss">smoothed</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">set-pen</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">the-pen-list</span><span class="w"> </span><span class="n">find-or-create-pen</span><span class="w"> </span><span class="s2">"black"</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">xscale</span><span class="p">))</span><span class="w"> </span><span class="o">'</span><span class="ss">solid</span><span class="p">))))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>The main rendering function, <code>make-timezone-bitmap</code> remains largely the same, except it now calls <code>setup-dc</code> to prepare the bitmap and the rest of the drawing functions remain completely unchanged, as the drawing code will keep track of the current target bitmap size an clipping regions:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">make-timezone-bitmap</span><span class="w"> </span><span class="n">tzdata</span><span class="w"> </span><span class="n">min-coord</span><span class="w"> </span><span class="n">max-coord</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">bitmap-dc%</span><span class="w"> </span><span class="p">[</span><span class="n">bitmap</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objcreation.html#(def._((lib._racket/private/class-internal..rkt)._make-object))" style="color: inherit">make-object</a></span><span class="w"> </span><span class="n">bitmap%</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="n">height</span><span class="p">)]))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">setup-dc</span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">min-coord</span><span class="w"> </span><span class="n">max-coord</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">;; Iterate over each feature (timezone) and render it</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span><span class="w"> </span><span class="p">([</span><span class="n">feature</span><span class="w">  </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash-ref))" style="color: inherit">hash-ref</a></span><span class="w"> </span><span class="n">tzdata</span><span class="w"> </span><span class="o">'</span><span class="ss">features</span><span class="p">))]</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="n">color</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-cycle))" style="color: inherit">in-cycle</a></span><span class="w"> </span><span class="n">color-map</span><span class="p">)])</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">set-brush</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">the-brush-list</span><span class="w"> </span><span class="n">find-or-create-brush</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">'</span><span class="ss">solid</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">draw-feature</span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">feature</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">get-bitmap</span><span class="p">))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>To test this code, I visited <a href="https://www.openstreetmap.org">openstreetmap.org</a> and obtained two GPS coordinates for the rough bounding box of Europe. To render the European timezones I used the following call:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">timezone-data</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/file-ports.html#(def._((lib._racket/private/base..rkt)._call-with-input-file))" style="color: inherit">call-with-input-file</a></span><span class="w"> </span><span class="s2">"./combined.json"</span><span class="w"> </span><span class="n"><a href="http://docs.racket-lang.org/json/index.html#(def._((lib._json/main..rkt)._read-json))" style="color: inherit">read-json</a></span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">bm</span><span class="w"> </span><span class="p">(</span><span class="n">make-timezone-bitmap</span><span class="w"> </span><span class="n">timezone-data</span><span class="w"></span>
<span class="w">                                 </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span><span class="w"> </span><span class="mf">-13.008</span><span class="w"> </span><span class="mf">61.481</span><span class="p">)</span><span class="w"></span>
<span class="w">                                 </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span><span class="w"> </span><span class="mf">33.02</span><span class="w"> </span><span class="mf">30.894</span><span class="p">)</span><span class="w"></span>
<span class="w">                                 </span><span class="mi">500</span><span class="w"> </span><span class="mi">500</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">bm</span><span class="w"> </span><span class="n">save-file</span><span class="w"> </span><span class="s2">"timezone-map-3.png"</span><span class="w"> </span><span class="o">'</span><span class="ss">png</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="kd">#:unscaled?</span><span class="w"> </span><span class="no">#t</span><span class="p">)</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<div class="figure"><img src="/img/a026/timezone-map-3.png" alt="" />
 <p class="caption"></p></div>

<h2 id="conclusions">Conclusions</h2>

<p>The Racket program used to generate these maps has less than 100 lines of code and only uses features from a standard Racket installation, I suppose this is an example of what &ldquo;batteries included&rdquo; means.</p>

<p>I was also pleasantly surprised that the Racket drawing library can handle large drawing requests: some of the <code>dc-path%</code> objects have in excess of 100&prime;000 lines and most of them have more than 50&prime;000, with most of the lines being less than the pixel size of the resulting bitmap. Without any optimizations, the code above loads a huge JSON file and renders a map with a total of 5 million lines in just over a minute on my machine &mdash; when I started working on this code, I expected I will need to run some line simplification algorithms for the timezone boundaries, but this proved unnecessary. There are several optimizations that could be done to make the rendering faster, but since timezone boundaries change less often than the 1 &ndash; 2 minute rendering time, it is simpler to just keep the generated image around.</p>

<p>I uploaded all the programs used to generate the maps in this blog post to this <a href="https://gist.github.com/alex-hhh/cdedfb550bb68411bd2331c8f4d2c421">GitHub Gist</a>, you can run them directly and further experiment with them.</p>

<hr />
  <footer>
    <div class="fine-print">© Alex Harsányi, licensed under
      <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>
      , and there's a <a href="/Cookies.html">cookie policy</a>.
    </div>
    <div class="row justify-content-center">
      <nav aria-label="Page Navigation">
        <ul class="pagination">
          <li class="page-item">
            <a class="page-link" href="/2019/04/build-racket-packages-with-azure-pipelines.html"
               aria-label="Previous">
              <span aria-hidden="true">&larr; Build Racket Packages with Azure Pipelines</span>
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="/2019/08/timezone-lookup.html"
               aria-label="Next">
              <span aria-hidden="true">Timezone Lookup (an adventure in program optimization) &rarr;</span>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </footer>
</article>
        </div>
        <div id="sidebar-content" class="col-md-3">
          <!-- will be filled in dynamically by custom.js -->
        </div>

      </div>

    </div>
    <!-- </body> JS -->
  <!-- NOTE: jQuery must be loaded first -->
  <script type="text/javascript" src="/js/jquery-3.4.1.min.js"></script>
  <script type="text/javascript" src="/js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="/js/custom.js"></script>
  </body>
</html>