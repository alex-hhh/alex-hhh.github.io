<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <title>Timezone Aware Local Time</title>
    <meta name="description" content="I wanted ActivityLog2 to show that my New Zealand skiing run started at 10am, rather than showing 6am, which is the local time in Western Australia, where I live. This feature took a long time to implement, plus it required a surprising amount of effort, ...">
    <meta name="author"      content="Alex Harsányi">
    <meta name="keywords"    content="activitylog2, racket">
    <meta name="viewport"    content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/img/favicon.svg">
    <link rel="canonical" href="https://alex-hhh.github.io/2019/10/local-time.html">
    <link rel="next" href="/2019/09/interactive-heat-maps.html">

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css/pygments.css">
    <link rel="stylesheet" type="text/css" href="/css/scribble.css">
    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Condensed|Roboto+Mono&display=swap" rel="stylesheet">
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml"
          href="/feeds/all.atom.xml" title="Atom Feed">
    <link rel="alternate" type="application/rss+xml"
          href="/feeds/all.rss.xml" title="RSS Feed">
    <!-- JS -->
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-110325732-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
      <div class="container">
        <a href="/index.html" class="navbar-brand">Alex Harsányi</a>

        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
                data-target="#navbar_collapse" aria-controls="navbar_collapse"
                aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbar_collapse">
          <ul class="navbar-nav mr-auto">

            <li class="nav-item dropdown">
              <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">
                Tags <b class="caret"></b></a>
              <ul class="dropdown-menu" role="menu" id="tags-menu-content">
                <!-- will be filled in dynamically by custom.js -->
              </ul>
            </li>
            <li>
              <a class="nav-link" href="/About.html">About</a>
            </li> 
            <li>
              <a class="nav-link" href="/tags/arduino.html">Arduino</a>
            </li> 
            <li>
              <a class="nav-link" href="/tags/racket.html">Racket</a>
            </li> 
            <li>
              <a class="nav-link" href="/tags/activitylog2.html">ActivityLog2</a>
            </li> 
          </ul>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="row">

        <!-- Main column -->
        <!-- NOTE: there is a bug in the web server template renderer which
             indents all items inside if blocks.  This means that we cannot
             put the contents inside an if block, as all the <pre> tags will
             be indented.
          -->
        <div id="content" class=col-md-9>





          <article>
  <header>
    <h1>Timezone Aware Local Time</h1>
    <p class='date-and-tags'>
<time datetime="2019-10-26" pubdate="true">2019-10-26</time> :: <span class="tags"><a href="/tags/activitylog2.html">activitylog2</a>, <a href="/tags/racket.html">racket</a></span></p>
  </header>

<p>I wanted <a href="https://github.com/alex-hhh/ActivityLog2">ActivityLog2</a> to show that my New Zealand skiing run started at 10am, rather than showing 6am, which is the local time in Western Australia, where I live. This feature took a long time to implement, plus it required a surprising amount of effort, and this blog post describes some of the implementation details.</p>
<!-- more-->

<p>The user visible changes are very modest and almost unnoticeable: all the timestamps display the time where an activity took place, rather than the local time where the activity is viewed. In the screen-shot below, the start time for the skiing run is shown as 9:48am, even though it would have been 5:48am in Western Australia where I live. The only &ldquo;hint&rdquo; is a time zone abbreviation in the session inspector:</p>

<div class="figure"><img src="/img/a032/local-time.png" alt="" />
 <p class="caption"></p></div>

<p>All the other places where timestamps are shown, such as the activity list or the lap viewer will display the time relative to the destination location and in addition to that, the user can edit the time zone for an activity, although for activities with GPS data this is automatically detected on import.</p>

<p>Implementing this &ldquo;simple&rdquo; feature took about two years of calendar time and many weekends of actual work, doubled the size of the application installer and increased the complexity of the build process. Looking at the 1300 lines of changes, one could wonder if the feature was worth it. On the other hand, I did learn a few things during this process and I no longer have to wonder why my activities recorded in Europe or New Zealand show up at such strange times of day.</p>

<h2 id="time-zone-aware-time-display">Time-zone Aware Time Display</h2>

<p><a href="https://github.com/alex-hhh/ActivityLog2">ActivityLog2</a> stores times for activities as UTC seconds, which is are integers representing the number of seconds since January 1st 1970. The Racket libraries can convert this into a <code><a href="http://docs.racket-lang.org/reference/time.html#(def._((lib._racket/private/base..rkt)._date))" style="color: inherit">date</a></code> structure using <code><a href="http://docs.racket-lang.org/reference/time.html#(def._((quote._~23~25kernel)._seconds-~3edate))" style="color: inherit">seconds-&gt;date</a></code>. This conversion can be done in two ways: either show the UTC time or the local time on the computer where the code runs:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">now</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/time.html#(def._((quote._~23~25kernel)._current-seconds))" style="color: inherit">current-seconds</a></span><span class="p">))</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="n">now</span>
<span class="mi">1571464832</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/time.html#(def._((quote._~23~25kernel)._seconds-~3edate))" style="color: inherit">seconds-&gt;date</a></span> <span class="n">now</span> <span class="no">#f</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/time.html#(def._((lib._racket/private/base..rkt)._date*))" style="color: inherit">date*</a></span> <span class="mi">32</span> <span class="mi">0</span> <span class="mi">6</span> <span class="mi">19</span> <span class="mi">10</span> <span class="mi">2019</span> <span class="mi">6</span> <span class="mi">291</span> <span class="no">#f</span> <span class="mi">0</span> <span class="mi">0</span> <span class="s2">"UTC"</span><span class="p">)</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/time.html#(def._((quote._~23~25kernel)._seconds-~3edate))" style="color: inherit">seconds-&gt;date</a></span> <span class="n">now</span> <span class="no">#t</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/time.html#(def._((lib._racket/private/base..rkt)._date*))" style="color: inherit">date*</a></span> <span class="mi">32</span> <span class="mi">0</span> <span class="mi">14</span> <span class="mi">19</span> <span class="mi">10</span> <span class="mi">2019</span> <span class="mi">6</span> <span class="mi">291</span> <span class="no">#f</span> <span class="mi">28800</span> <span class="mi">0</span> <span class="s2">"W. Australia Standard Time"</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>In the example above, the same number, 1571464832, can be converted to show either 6am in UTC or 2pm in Western Australia where I run the code. There is no built-in way to use the local time in another place, such as Auckland. We can however use the <a href="https://pkgs.racket-lang.org/package/tzinfo">tzinfo</a> package to determine the timezone offset for another time zone, such as &ldquo;Pacific/Auckland&rdquo;, apply the offset to the time stamp than convert it to a date structure. All this would show us that it is 7pm in Auckland as I write this:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" style="color: inherit">require</a></span> <span class="n">tzinfo</span><span class="p">)</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">utc-seconds-&gt;tzoffset</span> <span class="s2">"Pacific/Auckland"</span> <span class="n">now</span><span class="p">)</span>
<span class="p">(</span><span class="n">tzoffset</span> <span class="mi">46800</span> <span class="no">#t</span> <span class="s2">"NZDT"</span><span class="p">)</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/time.html#(def._((quote._~23~25kernel)._seconds-~3edate))" style="color: inherit">seconds-&gt;date</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">now</span> <span class="mi">46800</span><span class="p">)</span> <span class="no">#f</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/time.html#(def._((lib._racket/private/base..rkt)._date*))" style="color: inherit">date*</a></span> <span class="mi">32</span> <span class="mi">0</span> <span class="mi">19</span> <span class="mi">19</span> <span class="mi">10</span> <span class="mi">2019</span> <span class="mi">6</span> <span class="mi">291</span> <span class="no">#f</span> <span class="mi">0</span> <span class="mi">0</span> <span class="s2">"UTC"</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>It is perhaps worth clarifying that a time zone name such as &ldquo;Pacific/Auckland&rdquo; refers to a set of rules for determining the local time, and we need to call <code>utc-seconds-&gt;tzoffset</code> for every time stamp, as the offset itself might be different during daylight saving.</p>

<p>The <code><a href="http://docs.racket-lang.org/reference/time.html#(def._((lib._racket/private/base..rkt)._date))" style="color: inherit">date</a></code> structure as obtained above can than be passed to various date and time formating functions, which produce the strings to be displayed to the user.</p>

<h2 id="automatic-time-zone-detection">Automatic Time Zone Detection</h2>

<p>All that is required to display the local time is to store a time zone name for each session and use it when formatting times. The simplest solution is to prompt the user to update the time zone manually for every activity they import, and the <a href="https://pkgs.racket-lang.org/package/tzinfo">tzinfo</a> package does provide an <code>all-tzids</code> function to list all time zone names and construct a GUI drop down control, but it is impolite for the application to ask the user for information that it can determine by itself. Besides, I have 2524 activities in the data base, and 1349 of them have GPS information &mdash; I am the main user of ActivityLog2 and I was not going to manually update all of them.</p>

<p>The solution is to have a function which can determine the time zone name from GPS location data, since most of the activities already have location data. There are several packages that do this, here is <a href="https://github.com/MrMinimal64/timezonefinder">one</a> for Python and <a href="https://github.com/darkskyapp/tz-lookup">one</a> for JavaScript. Unfortunately, pkgs.racket-lang.org didn&rsquo;t have one for Racket.</p>

<p>I could have just copied the implementation of one of these libraries, the <a href="https://github.com/darkskyapp/tz-lookup">tz-lookup</a> one in particular is relatively simple, but instead I decided to try to understand the underlying mechanism for determining a time zone from latitude and longitude so I came up with my own implementation. After several failed starts, which I kept to myself, I produced the <a href="https://pkgs.racket-lang.org/package/tzgeolookup">tzgeolookup</a> package along with a few blog posts describing how it works, <a href="/2019/08/timezone-lookup.html">here</a>, <a href="/2019/08/timezone-lookup-2.html">here</a> and <a href="/2019/05/timezone-visualization.html">here</a>. The end result is that I now have a function which can determine the time zone from a GPS coordinate and this can be used to determine the time zone when an activity is imported.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" style="color: inherit">require</a></span> <span class="n">tzgeolookup</span><span class="p">)</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">lookup-timezone</span> <span class="mf">-45.06357632</span>	<span class="mf">168.8221158</span><span class="p">)</span>
<span class="s2">"Pacific/Auckland"</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h2 id="database-schema-updates">Database schema updates</h2>

<p>The <a href="https://pkgs.racket-lang.org/package/tzinfo">tzinfo</a> and <a href="https://pkgs.racket-lang.org/package/tzgeolookup">tzgeolookup</a> packages provide the building blocks for formatting timestamps in local time, the next issue to address was storing the time zone information in the database. The time zone could be determined at runtime using <code>lookup-timezone</code>, but this can only be done for activities which have GPS information; for other activities, such as Lap Swimming, this information has to me manually entered by the user and stored in the database.</p>

<p>The session information is stored in a <a href="https://sqlite.org/index.html">SQLite</a> database, so I needed to (1) update the database schema and (2) ensure that databases already created using previous versions are upgraded as needed. Since this is not the first time I had to update the database schema, this process is fairly mature by now: the <a href="https://github.com/alex-hhh/ActivityLog2/blob/master/sql/db-schema.sql">main database schema</a> was updated to add a time zone to the <code>A_SESSION</code> table and a <a href="https://github.com/alex-hhh/ActivityLog2/blob/master/sql/migrations/p32-time-zone.sql">migration script</a> was written to update an existing database to the new version and registered with the application:</p>

<div class="brush: sql">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="k">create</span> <span class="k">table</span> <span class="n">E_TIME_ZONE</span><span class="p">(</span>
  <span class="n">id</span> <span class="nb">integer</span> <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span> <span class="n">autoincrement</span><span class="p">,</span>
  <span class="n">name</span> <span class="nb">text</span> <span class="k">unique</span> <span class="k">not</span> <span class="k">null</span><span class="p">);</span>

<span class="k">create</span> <span class="k">unique</span> <span class="k">index</span> <span class="n">IX0_E_TIME_ZONE</span> <span class="k">on</span> <span class="n">E_TIME_ZONE</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">E_TIME_ZONE</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="k">values</span> <span class="p">(</span><span class="s1">&#39;Africa/Abidjan&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Africa/Accra&#39;</span><span class="p">),</span> <span class="p">...;</span> <span class="c1">-- all time zones listed here</span>

<span class="k">alter</span> <span class="k">table</span> <span class="n">A_SESSION</span> <span class="k">add</span> <span class="n">time_zone_id</span> <span class="nb">integer</span> <span class="k">references</span> <span class="n">E_TIME_ZONE</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

<span class="k">update</span> <span class="n">SCHEMA_VERSION</span> <span class="k">set</span> <span class="k">version</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Rather than storing the time zone by name in the <code>A_SESSION</code> table, a separate table <code>E_TIME_ZONE</code> is used to store the time zone names and the <code>A_SESSION</code> table references these using a foreign key. This design makes selection queries more complex, but it tries to minimize the chance that a non-existent time zone is stored in the database: a non-existent time zone cannot be just inserted into the <code>A_SESSION</code> table, instead the <code>E_TIME_ZONE</code> table has to be updated first.</p>

<p>The <a href="https://github.com/alex-hhh/ActivityLog2">ActivityLog2</a> application uses a somewhat unusual database upgrade mechanism, where an initial database is always created from a full database schema file, while previous versions are updated using migration scripts. This creates some potential for mistakes, since a new database schema might not be identical to an upgraded one, but there are extensive tests, run during CI builds, which ensure that (1) new databases can be created without error, (2) existing databases can be upgraded without error, and (3) activities can be imported into the database.</p>

<p>One limitation for this <a href="https://github.com/alex-hhh/ActivityLog2/blob/250bb47d2959a07abd74b475f6b240c69e4fd8cb/rkt/dbapp.rkt#L38">upgrade mechanism</a> is that it is only able to run SQL scripts, so anything that cannot be expressed in SQL, cannot be part of a database upgrade. For the first time for an upgrade, and this is number 32, I wanted to update the time zone for activities already in the database, but this is not possible using just SQL statements.</p>

<p>Rather than spending even more time on implementing a Racket migration mechanism, I opted for the simpler route of providing an &ldquo;Update time zones&hellip;&rdquo; tool, available in the Tools menu, which runs the update code on all activities in the database. The code is small and simple: an SQL query retrieves the list of sessions which have GPS information, along with the coordinates of their start location:</p>

<div class="brush: sql">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8
9</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="k">select</span> <span class="n">P</span><span class="p">.</span><span class="n">session_id</span><span class="p">,</span>
       <span class="n">T</span><span class="p">.</span><span class="n">position_lat</span> <span class="k">as</span> <span class="n">lat</span><span class="p">,</span>
       <span class="n">T</span><span class="p">.</span><span class="n">position_long</span> <span class="k">as</span> <span class="n">lon</span>
 <span class="k">from</span> <span class="n">A_TRACKPOINT</span> <span class="n">T</span><span class="p">,</span> <span class="n">A_LENGTH</span> <span class="n">L</span><span class="p">,</span> <span class="n">A_LAP</span> <span class="n">P</span>
<span class="k">where</span> <span class="n">T</span><span class="p">.</span><span class="n">length_id</span> <span class="o">=</span> <span class="n">L</span><span class="p">.</span><span class="n">id</span>
  <span class="k">and</span> <span class="n">L</span><span class="p">.</span><span class="n">lap_id</span> <span class="o">=</span> <span class="n">P</span><span class="p">.</span><span class="n">id</span>
  <span class="k">and</span> <span class="n">T</span><span class="p">.</span><span class="n">position_lat</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span>
  <span class="k">and</span> <span class="n">T</span><span class="p">.</span><span class="n">position_long</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">P</span><span class="p">.</span><span class="n">session_id</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>A small racket program iterates over the result set from this query, determines the time zone using <code>lookup-timezone</code> and updates the <code>A_SESSION</code> table:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="c1">;; Prepare a hash to map timezone names to their id</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">tzids</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/hash))" style="color: inherit">for/hash</a></span> <span class="p">([</span><span class="n">data</span> <span class="p">(</span><span class="n">query-rows</span> <span class="n">database</span> <span class="s2">"select id, name from E_TIME_ZONE"</span><span class="p">)])</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match-define))" style="color: inherit">match-define</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector))" style="color: inherit">vector</a></span> <span class="n"><a href="http://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#(form._((lib._syntax/parse..rkt)._id))" style="color: inherit">id</a></span> <span class="n">name</span><span class="p">)</span> <span class="n">data</span><span class="p">)</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._values))" style="color: inherit">values</a></span> <span class="n">name</span> <span class="n"><a href="http://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#(form._((lib._syntax/parse..rkt)._id))" style="color: inherit">id</a></span><span class="p">)))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">session-data</span> <span class="p">(</span><span class="n">query-rows</span> <span class="n">database</span> <span class="s2">"***SQL QUERY HERE***"</span><span class="p">))</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span> <span class="p">([</span><span class="n">data</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span> <span class="n">session-data</span><span class="p">)])</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match-define))" style="color: inherit">match-define</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector))" style="color: inherit">vector</a></span> <span class="n">sid</span> <span class="n">lat</span> <span class="n">lon</span><span class="p">)</span> <span class="n">data</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">timezone</span> <span class="p">(</span><span class="n">lookup-timezone</span> <span class="n">lat</span> <span class="n">lon</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="n">timezone</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="p">([</span><span class="n">tzid</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash-ref))" style="color: inherit">hash-ref</a></span> <span class="n">tzids</span> <span class="n">timezone</span> <span class="no">#f</span><span class="p">)])</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="n">tzid</span>
            <span class="p">(</span><span class="n">query-exec</span> <span class="n">database</span> <span class="s2">"update A_SESSION <a href="http://docs.racket-lang.org/reference/sets.html#(def._((lib._racket/set..rkt)._set))" style="color: inherit">set</a> time_zone_id <a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3d))" style="color: inherit">=</a> ? where <a href="http://docs.racket-lang.org/syntax/Library_Syntax_Classes_and_Literal_Sets.html#(form._((lib._syntax/parse..rkt)._id))" style="color: inherit">id</a> <a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3d))" style="color: inherit">=</a> ?"</span> <span class="n">tzid</span> <span class="n">sid</span><span class="p">)</span>
            <span class="c1">;; This might indicate that the time zones in E_TIME_ZONE are</span>
            <span class="c1">;; outdated and need updating...</span>
            <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._printf))" style="color: inherit">printf</a></span> <span class="s2">"Could <a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._not))" style="color: inherit">not</a> find E_TIME_ZONE.id <a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a> <a href="http://docs.racket-lang.org/reference/time.html#(form._((lib._racket/private/more-scheme..rkt)._time))" style="color: inherit">time</a> zone ~a"</span> <span class="n">timezone</span><span class="p">)))</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._printf))" style="color: inherit">printf</a></span> <span class="s2">"Could <a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._not))" style="color: inherit">not</a> find timezone <a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a> <a href="http://docs.racket-lang.org/xml/index.html#(def._((lib._xml/main..rkt)._location))" style="color: inherit">location</a> lat <a href="http://docs.racket-lang.org/reference/strings.html#(def._((lib._racket/format..rkt)._~7ea))" style="color: inherit">~a</a> lon ~a"</span> <span class="n">lat</span> <span class="n">lon</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The application already had a mechanism of running a batch task against the database, together with a progress bar and a mechanism to cancel the jobs, so it was easy to add this upgrade code to the application GUI:</p>

<div class="figure"><img src="/img/a032/update-time-zones.png" alt="" />
 <p class="caption"></p></div>

<h2 id="allowing-the-user-to-edit-the-time-zone">Allowing the User to Edit the Time Zone</h2>

<p>Automatic time zone detection is convenient, but it is not always possible, as not all activities have GPS information. The two major types of such activities (that I have anyway) are Lap Swimming sessions and bike sessions done on an internal trainer. This means that the application must allow the user to edit the time zone for an activity. There are two places where this can be done: the first one is the session inspector headline which allows switching to &ldquo;Edit&rdquo; mode, to allow the user to quickly adjust the title, sport and now time zone:</p>

<div class="figure"><img src="/img/a032/edit-headline.png" alt="" />
 <p class="caption"></p></div>

<p>The second place is the dialog where the full activity details can be edited. As a side note, the activity editor was one of the first things I wrote for ActivityLog2, doing it while still learning Racket, and the code base was &ldquo;less than ideal&rdquo;, I would probably approach the task differently if I had to do it again, but my opportunities to do things a second time are limited&hellip;</p>

<div class="figure"><img src="/img/a032/activity-edit.png" alt="" />
 <p class="caption"></p></div>

<h2 id="package-dependency-management">Package Dependency Management</h2>

<p>Perhaps it would be a surprise to many, but ActivityLog2 used only packages that are part of the main Racket distribution, with no external packages needed. I always liked the fact that one could just install Racket, clone the ActivityLog2 repository and run the application&rsquo;s <code>run.rkt</code> file.</p>

<p>This has changed now: the <a href="https://pkgs.racket-lang.org/package/tzinfo">tzinfo</a> and <a href="https://pkgs.racket-lang.org/package/tzgeolookup">tzgeolookup</a> packages, plus their dependencies, must be installed for the application to build and run. These dependencies have created a few problems related to package management. For a simple use case, one can install the dependent packages from the default Racket package catalog using a single <code>raco</code> command:</p>

<pre><code>raco pkg install --auto tzinfo tzgeolookup</code></pre>

<p>Alternatively, the dependencies can be added to an <code>info.rkt</code> file and converting ActivityLog2 into a pseudo-packages, so the dependencies are installed when the user runs <code>rack pkg install</code> in the application directory.</p>

<p>However, the problem with this approach is that these package dependencies are not versioned: <code>raco pkg install</code> will always install the latest package available in the catalog server, and this is not what is intended if an older version of the application is checked out. Also, and more importantly for my use case, some of the packages might contain bugs which are not yet fixed. An example is the <code>tzinfo</code> package which has a bug preventing its installation on Windows. While I submitted a pull request for <a href="https://github.com/97jaz/tzinfo/pull/10">this issue</a>, I wanted to be able to use the fixed version until this issue is fixed and an update is available on the official package server.</p>

<p>The solution was to add all dependent packages as git submodules to the source repository of the application, and let git manage the versions of these packages. During the build, a new package catalog is created using the <code>pkg/dirs-catalog</code> command, and this is added to the list of package catalogs:</p>

<div class="brush: sh">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="c1"># Go to the direcory containing the packages</span>
<span class="nb">cd</span> pkgs
<span class="c1"># Index the directory as a package catalog</span>
racket -l- pkg/dirs-catalog --link catalog .
<span class="c1"># Add the location for this catalog to catalog-locations.txt</span>
<span class="nb">echo</span> <span class="s2">"file://`pwd`/catalog"</span> &gt; ./catalog-locations.txt
<span class="c1"># Also add existing catalogs to the same file</span>
raco pkg config catalogs &gt;&gt; ./catalogs-locations.txt
<span class="c1"># Set the new list of catalog locations (note that the pkgs catalog is first)</span>
raco pkg config --set catalogs <span class="sb">`</span>cat ./catalog-locations.txt<span class="sb">`</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The actual <strong>script</strong> run by the build is a bit more complex, but once the catalog is set up, the packages can be installed using:</p>

<pre><code>raco pkg install --auto tzinfo tzgeolookup</code></pre>

<p>Why not just link the packages in place? After all, the build script could have just ran a <code>raco pkg install</code> in each package folder. The &ldquo;catalog&rdquo; mechanism solves additional problems:</p>

<ul>
 <li>
  <p>the package dependencies are also resolved from this catalog and don&rsquo;t have  to be manually installed in the correct order. The build script needs to  install only the direct dependencies of ActivityLog2</p></li>
 <li>
  <p>on CI build pipeline, the catalog setup will <em>replace</em> the existing catalogs  with this directory based catalog. This ensures that any package  dependencies can only be resolved through this catalog and a package install  will fail if a dependent package is not version controlled &mdash; this is a  simple mechanism to ensure that all package dependencies are under version  control.</p></li>
 <li>
  <p>the source location for the packages is disconnected from the installation  process: if the catalog setup is skipped, packages will be installed from  the usual Racket catalog, which might come in handy.</p></li></ul>

<p>This mechanism offers flexibility but also has some limitations, as the package installation is global, meaning that any program which wants to use the <code>tzinfo</code> or <code>tzgeolookup</code> packages will use the ones installed from the ActivityLog2 &ldquo;pkgs&rdquo; folder. It would be great if the packages could be installed for a specific application only, but I could not find a way to do that.</p>

<h2 id="final-thoughts">Final Thoughts</h2>

<p>This was a large task to implement: it took me two years since I recorded this as an <a href="https://github.com/alex-hhh/ActivityLog2/issues/11">issue</a>, the commit is <a href="https://github.com/alex-hhh/ActivityLog2/commit/250bb47d2959a07abd74b475f6b240c69e4fd8cb">over 1500 lines of code</a>, the resulting binary application size increased by about 25Mb, and I quite possibly introduced some bugs along the way. As I look back, I question if it was worth it. Well, as far as usefulness goes, the answer is probably no, since I only have a few activities which were recorded out of my regular time zone, I could have lived without this feature. On the other hand, I did learn a wide variety of things, from working with git submodules, setting up custom package catalogs, and implementing efficient lookup algorithms for geographic location lookup, and I think this aspect made the task worth it.</p>
  <footer>
    <div class="row justify-content-center">
      <nav aria-label="Page Navigation">
        <ul class="pagination">
          <li class="page-item">
            <a class="page-link" href="/2019/09/interactive-heat-maps.html"
               aria-label="Previous">
              <span aria-hidden="true">&larr; Interactive Heat Maps</span>
            </a>
          </li>

        </ul>
      </nav>
    </div>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.identifier = undefined;
        this.page.url = undefined;
        this.page.title = undefined;
        this.page.category_id = undefined;
      };
      var disqus_shortname = 'alex-hhh-github-com';
      (function() {
          var dsq = document.createElement('script');
          dsq.type = 'text/javascript';
          dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          dsq.setAttribute('data-timestamp', +new Date());
          (document.head || document.body).appendChild(dsq);
      })();
    </script>
    <noscript>
      Please enable JavaScript to view the
      <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
  </footer>
</article>
        </div>
        <div id="sidebar-content" class="col-md-3">
          <!-- will be filled in dynamically by custom.js -->
        </div>
      </div>
      <footer>
        <hr />
        <!-- <p><a href="https://twitter.com/racketlang"
                   class="twitter-follow-button"
                   data-show-count="false"
                   data-lang="en">
                  "Follow RacketLang"
                </a>
                <script type="text/javascript">
                  !function(d,s,id){
                      var js,fjs=d.getElementsByTagName(s)[0];
                      if(!d.getElementById(id)){
                          js=d.createElement(s);
                          js.id=id;
                          js.src="//platform.twitter.com/widgets.js";
                          fjs.parentNode.insertBefore(js,fjs);
                      }
                  }(document,"script","twitter-wjs");
                </script></p> -->
        <p>Site generated
          by <a href="https://github.com/greghendershott/frog">Frog</a>,
          the <strong>fr</strong>ozen bl<strong>og</strong>
          tool. Using <a href="http://twitter.github.com/bootstrap/index.html">Bootstrap</a>. Also
          available as <a href="/feeds/all.atom.xml">Atom</a>
          and <a href="/feeds/all.rss.xml">RSS</a> feeds. . There is also
          a <a href="/Cookies.html">cookie policy</a>.</p>
        <!-- <p><em>Your legal notice here</em>.</p> -->
      </footer>
    </div>
    <!-- </body> JS -->
  <!-- NOTE: jQuery must be loaded first -->
  <script type="text/javascript" src="/js/jquery-3.4.1.min.js"></script>
  <script type="text/javascript" src="/js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="/js/custom.js"></script>
  </body>
</html>