<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <title>Asteroids (Game Engine)</title>
    <meta name="description" content="in which we look how we can implement the classic Asteroids game game using only the Racket language and its graphics facilities. We'll implement a basic game engine, a basic physics engine and the game itself, and manage to do it in about 1000 lines of c...">
    <meta name="author"      content="Alex Harsányi">
    <meta name="keywords"    content="racket, games in racket">
    <meta name="viewport"    content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/img/favicon.svg">
    <link rel="canonical" href="https://alex-hhh.github.io/2021/10/asteroids-part-1.html">
    <link rel="next" href="/2021/09/screenshots.html">
    <link rel="prev" href="/2021/10/asteroids-part-2.html">
    <link href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Condensed|Roboto+Mono&display=swap" rel="stylesheet">
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml"
          href="/feeds/all.atom.xml" title="Atom Feed">
    <link rel="alternate" type="application/rss+xml"
          href="/feeds/all.rss.xml" title="RSS Feed">
    <!-- JS -->
    <script src="/main.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-110325732-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-110325732-1');
    </script>
  </head>
  <body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
      <div class="container">
        <a href="/index.html" class="navbar-brand">Alex Harsányi</a>

        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
                data-target="#navbar_collapse" aria-controls="navbar_collapse"
                aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbar_collapse">
          <ul class="navbar-nav mr-auto">

            <li class="nav-item dropdown">
              <a href="#"
                 class="nav-link dropdown-toggle"
                 data-bs-toggle="dropdown"
                 aria-expanded="false">
                Tags <b class="caret"></b></a>
              <ul class="dropdown-menu" role="menu" id="tags-menu-content">
                <!-- will be filled in dynamically by custom.js -->
              </ul>
            </li>
            <li>
              <a class="nav-link" href="/About.html">About</a>
            </li> 
            <li>
              <a class="nav-link" href="/tags/arduino.html">Arduino</a>
            </li> 
            <li>
              <a class="nav-link" href="/tags/racket.html">Racket</a>
            </li> 
            <li>
              <a class="nav-link" href="/tags/activitylog2.html">ActivityLog2</a>
            </li> 
          </ul>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="row">

        <!-- Main column -->
        <!-- NOTE: there is a bug in the web server template renderer which
             indents all items inside if blocks.  This means that we cannot
             put the contents inside an if block, as all the <pre> tags will
             be indented.
          -->
        <div id="content" class=col-md-9>





          <article>
  <header>
    <h1>Asteroids (Game Engine)</h1>
    <p class='date-and-tags'>
<time datetime="2021-10-07" pubdate="true">2021-10-07</time> :: <span class="tags"><a href="/tags/racket.html">racket</a>, <a href="/tags/games-in-racket.html">games in racket</a></span></p>
  </header>

<p>&hellip; in which we look how we can implement the classic <a href="https://en.wikipedia.org/wiki/Asteroids_%28video_game%29">Asteroids game</a> game using only the <a href="https://www.racket-lang.org/">Racket</a> language and its graphics facilities. We&rsquo;ll implement a basic game engine, a basic physics engine and the game itself, and manage to do it in about 1000 lines of code.</p>
<!-- more-->

<p>If you are not familiar with the game, the premise is that the player controls a space ship and needs to shoot and destroy asteroids, while avoiding collision with them. The game is more challenging to implement than <a href="/tags/games-in-racket.html">other games</a> we looked at, since it involves moving bodies and bouncing them off each other, which requires simulating a physics model. Still, it can all be implemented in plain Racket, without the use of any external libraries.</p>

<div class="figure"><img src="/img/a051/asteroids.png" alt="" />
 <p class="caption"></p></div>

<h2 id="the-game-engine">The Game Engine</h2>

<p>You don&rsquo;t need a Game Engine to implement a game, but it helps. A game engine allows abstracting away some of the peculiarities of the user interface (GUI) and allows designing the game as a collection of actors which know how to move, paint themselves on the screen and interact with each other.</p>

<h3 id="scene-and-actors">Scene and Actors</h3>

<p>The game engine manages a <strong>scene</strong> which is a collection of <strong>actors</strong>. In complex games, managing a scene is a complex topic in itself, but here we can simply use a list as the scene:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">the-scene</span><span class="w"> </span><span class="o">'</span><span class="p">())</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>Our scene starts empty, but it would be useful to have some functions to add and remove actors from the scene. These are simply operations which add and remove elements from the list:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">add-actor</span><span class="w"> </span><span class="n">actor</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span><span class="w"> </span><span class="n">the-scene</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" style="color: inherit">cons</a></span><span class="w"> </span><span class="n">actor</span><span class="w"> </span><span class="n">the-scene</span><span class="p">)))</span><span class="w"></span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">remove-actor</span><span class="w"> </span><span class="n">actor</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span><span class="w"> </span><span class="n">the-scene</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/list..rkt)._remove))" style="color: inherit">remove</a></span><span class="w"> </span><span class="n">actor</span><span class="w"> </span><span class="n">the-scene</span><span class="p">)))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>What can be done with this scene? Well, we need a way to update the scene as the time passes, a way to show the scene in a GUI window, and tell the scene of any user input, so the user can control some of the actors in the game, such as the ship. Here are the functions which do each of these things, and in our simple game engine, each of these operations means going over the actors in the scene and invoking a method on the actor itself:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">paint-scene</span><span class="w"> </span><span class="n">scene</span><span class="w"> </span><span class="n">canvas</span><span class="w"> </span><span class="n">dc</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span><span class="w"> </span><span class="p">([</span><span class="n">actor</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span><span class="w"> </span><span class="n">scene</span><span class="p">)])</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">actor</span><span class="w"> </span><span class="n">paint</span><span class="w"> </span><span class="n">canvas</span><span class="w"> </span><span class="n">dc</span><span class="p">)))</span><span class="w"></span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">update-scene</span><span class="w"> </span><span class="n">scene</span><span class="w"> </span><span class="n">delta-time</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span><span class="w"> </span><span class="p">([</span><span class="n">actor</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span><span class="w"> </span><span class="n">scene</span><span class="p">)])</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">actor</span><span class="w"> </span><span class="n">update/delta-time</span><span class="w"> </span><span class="n">delta-time</span><span class="p">)))</span><span class="w"></span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">handle-keyboard-event</span><span class="w"> </span><span class="n">scene</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span><span class="w"> </span><span class="p">([</span><span class="n">actor</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span><span class="w"> </span><span class="n">scene</span><span class="p">)])</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">actor</span><span class="w"> </span><span class="n">keyboard-event</span><span class="w"> </span><span class="n">event</span><span class="p">)))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>Now, that we have some operations on the scene itself, we have a better understanding of what each actors needs to provide to work with the game engine:</p>

<ul>
 <li>a <code>paint</code> method, which paints the actor onto the canvas</li>
 <li>an <code>update/delta-time</code> method, which updates the internal state of the actor  (e.g. moving it to a new position, according to its velocity)</li>
 <li>a <code>keyboard-event</code> method, which informs the actor that the user pressed the  key. This allows the actor to take some action on user input &mdash; for  example, the ship will move and turn in response to user input.</li></ul>

<p>Since we know what methods the actors must provide, we can encode this information in an interface, this way we can use the racket contract system to check that our actors implement the correct set of methods, and report an error if they don&rsquo;t:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">actor&lt;%&gt;</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createinterface.html#(form._((lib._racket/private/class-internal..rkt)._interface))" style="color: inherit">interface</a></span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="n">paint</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/Object_and_Class_Contracts.html#(form._((lib._racket/class..rkt)._-~3em))" style="color: inherit">-&gt;m</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Object_and_Class_Contracts.html#(def._((lib._racket/class..rkt)._is-a~3f/c))" style="color: inherit">is-a?/c</a></span><span class="w"> </span><span class="n">canvas%</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Object_and_Class_Contracts.html#(def._((lib._racket/class..rkt)._is-a~3f/c))" style="color: inherit">is-a?/c</a></span><span class="w"> </span><span class="n">dc&lt;%&gt;</span><span class="p">)</span><span class="w"> </span><span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/private/misc..rkt)._any/c))" style="color: inherit">any/c</a></span><span class="p">)]</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="n">update/delta-time</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/Object_and_Class_Contracts.html#(form._((lib._racket/class..rkt)._-~3em))" style="color: inherit">-&gt;m</a></span><span class="w"> </span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._positive~3f))" style="color: inherit">positive?</a></span><span class="w"> </span><span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/private/misc..rkt)._any/c))" style="color: inherit">any/c</a></span><span class="p">)]</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="n">keyboard-event</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/Object_and_Class_Contracts.html#(form._((lib._racket/class..rkt)._-~3em))" style="color: inherit">-&gt;m</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Object_and_Class_Contracts.html#(def._((lib._racket/class..rkt)._is-a~3f/c))" style="color: inherit">is-a?/c</a></span><span class="w"> </span><span class="n">key-event%</span><span class="p">)</span><span class="w"> </span><span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/private/misc..rkt)._any/c))" style="color: inherit">any/c</a></span><span class="p">)]))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>Not all actors will need to implement all these methods. For example, only the ship actor is interested in keyboard input, since the user can only control the ship, yet all actors must implement the <code>keyboard-event</code> method. To simplify things, we can define a &ldquo;root&rdquo; class for all our actors which provides default implementation for all these methods:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">actor%</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class*))" style="color: inherit">class*</a></span><span class="w"> </span><span class="nb"><a href="http://docs.racket-lang.org/reference/createclass.html#(def._((lib._racket/private/class-internal..rkt)._object~25))" style="color: inherit">object%</a></span><span class="w"> </span><span class="p">(</span><span class="n">actor&lt;%&gt;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._init))" style="color: inherit">init</a></span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._super-new))" style="color: inherit">super-new</a></span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span><span class="w"> </span><span class="p">(</span><span class="n">paint</span><span class="w"> </span><span class="n">_canvas</span><span class="w"> </span><span class="n">_dc</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" style="color: inherit">void</a></span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span><span class="w"> </span><span class="p">(</span><span class="n">update/delta-time</span><span class="w"> </span><span class="n">_dt</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" style="color: inherit">void</a></span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span><span class="w"> </span><span class="p">(</span><span class="n">keyboard-event</span><span class="w"> </span><span class="n">_e</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" style="color: inherit">void</a></span><span class="p">))))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>By deriving from the <code>actor%</code> class, other actors will only need to override the methods that they actually need, yet still be able to correctly interface with the game engine.</p>

<hr />

<p><strong>Side Notes</strong></p>

<ul>
 <li>
  <p>The <code>actor&lt;%&gt;</code> interface and <code>actor%</code> base class only provide a sufficient  interface to implement our game, and a more generic game engine would need  to provide additional method. For an alternative implementation of the  actor interface, see <a href="/2020/11/space-invaders.html">the space invaders</a> blog post.</p></li>
 <li>
  <p>Keeping the scene a simple list works remarkably well in Racket, it can  manage scenes of 150 &ndash; 200 actors without a drop in performance, however, it  is inefficient. In particular, only one actor in the scene is interested in  keyboard events, yet all of them will receive them. An alternative  implementation would be for the game engine to keep separate lists for what  types of events each actor wants to receive and allowing actors to register  for these events.</p></li></ul>

<hr />

<h3 id="frame-and-canvas">Frame and Canvas</h3>

<p>The game engine needs to present the game window to the user and this involves implementing the user interface. We&rsquo;ll start with the game window:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">game-outcome</span><span class="w"> </span><span class="o">'</span><span class="ss">not-started</span><span class="p">)</span><span class="w"></span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">game-window%</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span><span class="w"> </span><span class="n">frame%</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._init))" style="color: inherit">init</a></span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._super-new))" style="color: inherit">super-new</a></span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span><span class="w"> </span><span class="p">(</span><span class="n">on-subwindow-char</span><span class="w"> </span><span class="n">receiver</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">handle-keyboard-event</span><span class="w"> </span><span class="n">the-scene</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._super))" style="color: inherit">super</a></span><span class="w"> </span><span class="n">on-subwindow-char</span><span class="w"> </span><span class="n">receiver</span><span class="w"> </span><span class="n">event</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/augride))" style="color: inherit">define/augride</a></span><span class="w"> </span><span class="p">(</span><span class="n">on-close</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span><span class="w"> </span><span class="n">game-outcome</span><span class="w"> </span><span class="o">'</span><span class="ss">abandoned</span><span class="p">))))</span><span class="w"></span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">the-frame</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">game-window%</span><span class="w"> </span><span class="p">[</span><span class="n">label</span><span class="w"> </span><span class="s2">"Asteroids"</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">width</span><span class="w"> </span><span class="mi">800</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">height</span><span class="w"> </span><span class="mi">450</span><span class="p">]))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>The game window will not only hold the view of the game but also receive various events from the system. Here we are interested in two of them: keyboard events are passed on to the actors in the scene by calling <code>handle-keyboard-event</code> and, when the window is closed, we inform the game loop that the game was abandoned by setting the global value <code>game-outcome</code> to <code>'abandoned</code>.</p>

<p>Finally, we create an instance of the <code>game-window%</code> class, which we call <code>the-frame</code> &mdash; this will be the actual game window. Simply creating a window will not show it on the screen, for that to happen, we need to call the <code>show</code> method, but before we do that we have some more work to do.</p>

<p>The canvas object is what allows us to actually draw on the window, so we need to create one as a child of <code>the-frame</code>:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">the-canvas</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">canvas%</span><span class="w"></span>
<span class="w">       </span><span class="p">[</span><span class="n">parent</span><span class="w"> </span><span class="n">the-frame</span><span class="p">]</span><span class="w"></span>
<span class="w">       </span><span class="p">[</span><span class="n">paint-callback</span><span class="w"> </span><span class="n">on-canvas-paint</span><span class="p">]))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>While it may seem counterintuitive, GUI systems (not just Racket), do not allow the application to draw something on the screen at any time it wants to &mdash; instead the application must provide a callback function, which is called by the canvas when it is ready to pain the window. In our case, the paint callback is called <code>on-canvas-paint</code> and it is supplied to the canvas object as the <code>paint-callback</code> field. Here is the implementation:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">transparent-brush</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">the-brush-list</span><span class="w"> </span><span class="n">find-or-create-brush</span><span class="w"> </span><span class="s2">"black"</span><span class="w"> </span><span class="o">'</span><span class="ss">transparent</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">on-canvas-paint</span><span class="w"> </span><span class="n">canvas</span><span class="w"> </span><span class="n">dc</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">set-smoothing</span><span class="w"> </span><span class="o">'</span><span class="ss">smoothed</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">set-brush</span><span class="w"> </span><span class="n">transparent-brush</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">paint-scene</span><span class="w"> </span><span class="n">the-scene</span><span class="w"> </span><span class="n">canvas</span><span class="w"> </span><span class="n">dc</span><span class="p">))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>The callback simply sets the smoothing type for the canvas and sets an initial transparent brush (meaning that objects in the scene will not be filled in with any color), than calls <code>paint-scene</code> which allows each actor to paint itself onto the canvas.</p>

<h3 id="game-loop">Game Loop</h3>

<p>The last piece of the game engine is the game loop itself. This is the function which effectively runs the game. The game loop has a few tasks to do:</p>

<ul>
 <li>Switches garbage collection mode to <code>'incremental</code> this will use fewer  pauses during garbage collection, making the game run smoother</li>
 <li>Shows the frame and transfers focus to it, so the game receives keyboard  events.</li>
 <li>Finally it goes into a loop of repeatedly calling <code>update-scene</code> and telling  the canvas to redraw itself, which will ultimately invoke the paint callback  and call <code>paint-scene</code>. This continues until the <code>game-outcome</code> variable is  set to <code>'abandoned</code> which happens when the user closes the window.</li></ul>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">run-game-loop</span><span class="w"> </span><span class="kd">#:frame-rate</span><span class="w"> </span><span class="p">[</span><span class="n">frame-rate</span><span class="w"> </span><span class="mi">60</span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/garbagecollection.html#(def._((quote._~23~25kernel)._collect-garbage))" style="color: inherit">collect-garbage</a></span><span class="w"> </span><span class="o">'</span><span class="ss">incremental</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span><span class="w"> </span><span class="n">game-outcome</span><span class="w"> </span><span class="o">'</span><span class="ss">in-progress</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span><span class="w"> </span><span class="n">game-score</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">the-frame</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="no">#t</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">the-frame</span><span class="w"> </span><span class="n">focus</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">frame-time</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="n">frame-rate</span><span class="p">)</span><span class="w"> </span><span class="mf">1000.0</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="p">([</span><span class="n">last-game-time</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/time.html#(def._((quote._~23~25kernel)._current-inexact-milliseconds))" style="color: inherit">current-inexact-milliseconds</a></span><span class="p">)]</span><span class="w"></span>
<span class="w">             </span><span class="p">[</span><span class="n">current-game-time</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/time.html#(def._((quote._~23~25kernel)._current-inexact-milliseconds))" style="color: inherit">current-inexact-milliseconds</a></span><span class="p">)])</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="n">current-game-time</span><span class="w"> </span><span class="n">last-game-time</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">update-scene</span><span class="w"> </span><span class="n">the-scene</span><span class="w"> </span><span class="n">the-collision-handlers</span><span class="w"> </span><span class="n">dt</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">the-canvas</span><span class="w"> </span><span class="n">refresh-now</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">update-duration</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/time.html#(def._((quote._~23~25kernel)._current-inexact-milliseconds))" style="color: inherit">current-inexact-milliseconds</a></span><span class="p">)</span><span class="w"> </span><span class="n">current-game-time</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">remaining-time</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="n">frame-time</span><span class="w"> </span><span class="n">update-duration</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">sleep/yield</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">remaining-time</span><span class="p">)</span><span class="w"> </span><span class="mf">1000.0</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._unless))" style="color: inherit">unless</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Equality.html#(def._((quote._~23~25kernel)._equal~3f))" style="color: inherit">equal?</a></span><span class="w"> </span><span class="n">game-outcome</span><span class="w"> </span><span class="o">'</span><span class="ss">abandoned</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="c1">;; NOTE: current-game-time becomes last-game-time next iteration</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">loop</span><span class="w"> </span><span class="n">current-game-time</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/time.html#(def._((quote._~23~25kernel)._current-inexact-milliseconds))" style="color: inherit">current-inexact-milliseconds</a></span><span class="p">)))))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>A game is a real-time program, which means that the program must run at a certain speed, not faster, and preferably not slower. The game loop keeps track of the time it takes to run all the functions in the game and calculates the remaining time such that each loop iteration happens in the same amount of time (this is the game&rsquo;s frame rate). It than waits the remaining time using <code>sleep/yield</code>, so that the next loop iteration starts just in time.</p>

<h2 id="the-physics-engine">The Physics Engine</h2>

<p>Another component in a game is the Physics Engine &mdash; this is responsible for simulating, to various degrees of accuracy, the physical movement of the objects in the game. A physics engine is independent from the Game Engine &mdash; one can swap one physics engine for another, although the two must work closely together.</p>

<p>Simulating accurate real-world physics is a complex topic, but here we&rsquo;ll keep things simple at the expense of accuracy &mdash; our physics engine will be capable of moving objects according to their speed and acceleration as well as handling collisions between them, however it will not fully simulate real world interactions between asteroids in outer space. Still, it will be credible enough for a simple game.</p>

<h3 id="bodies">Bodies</h3>

<p>Our physics engine will deal with a single kind of object: the rigid body. &ldquo;Body&rdquo; is simply another term for object, and we&rsquo;ll use it when referring to objects managed by the physics engine. The term &ldquo;Rigid&rdquo; refers to the fact that the bodies managed by the physics engine will not change shape, that is, they cannot bend or dent.</p>

<p>Our physics engine is responsible for keeping track of the <em>position</em>, <em>speed</em> and <em>acceleration</em> of a body. We also allow bodies to rotate or spin, so we also need to track <em>orientation</em> and <em>angular velocity</em>.</p>

<p>Since we must also check for collisions, we need to keep track of the shape and size of each body &mdash; doing this for bodies of arbitrary shape is complex, so we will assume that all the bodies are circles. This means that, even though asteroids in the game will have an irregular shape, as far as their interaction are concerned, they will behave like balls. Since all physics bodies are circles, their shape is controlled by a single value: the <em>radius</em>.</p>

<p>We can represent bodies as structures, with a slot for each of the properties discussed so far.</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define-struct.html#(form._((lib._racket/private/base..rkt)._struct))" style="color: inherit">struct</a></span><span class="w"> </span><span class="n">body</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">position</span><span class="w"></span>
<span class="w">   </span><span class="n">velocity</span><span class="w"></span>
<span class="w">   </span><span class="n">acceleration</span><span class="w"></span>
<span class="w">   </span><span class="n">radius</span><span class="w"></span>
<span class="w">   </span><span class="n">orientation</span><span class="w">                          </span><span class="c1">; orientation for spinning bodies</span><span class="w"></span>
<span class="w">   </span><span class="n">angular-velocity</span><span class="w"></span>
<span class="w">   </span><span class="n">velocity-damping</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">#:transparent</span><span class="p">)</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>There is an additional structure slot defined above, the <code>velocity-damping</code> &mdash; this will be used to simulate friction for the space ship: normally, in space, once a ship is accelerated, it will continue to maintain its speed, and to slow down a ship, the user would have to spin it 180 degrees and accelerate it in the opposite direction. Since this is too complex for the user, we will introduce friction, so, once acceleration is removed, the body will eventually slow down. A <code>velocity-damping</code> of 1 will mean there is no damping and the body will continue to maintain its current speed indefinitely.</p>

<h3 id="vectors">Vectors</h3>

<p>The <em>radius</em>, <em>orientation</em>, <em>angular-velocity</em> and <em>velocity-damping</em> properties are simple numbers. For example a body might have a radius of 30, an orientation of pi/2 radians and an angular velocity of 0.05 radians/second. But what exactly is the <em>position</em>, <em>velocity</em> and <em>acceleration</em>? This is a two-dimensional game, so they cannot be simple numbers. We could represent positions as 2D coordinates, but the speed needs to encode both how fast an object is moving and in what direction it is going.</p>

<p>There is an elegant solution for this problem: <a href="https://en.wikipedia.org/wiki/Vector_space">vectors</a>. For 2D space, these are structures containing 2 values, along with some mathematical operations that can manipulate these values. A vector can encode a position, but also a direction and a magnitude, and allow us to apply the same math formulas for speed and acceleration from 1D space to 2D space.</p>

<p>We&rsquo;ll represent vectors as a structure, called <code>v2</code> (2 because these are two dimensional vectors), and, since some vectors, such as the left an right directions, are used often, we also define them as global values:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define-struct.html#(form._((lib._racket/private/base..rkt)._struct))" style="color: inherit">struct</a></span><span class="w"> </span><span class="n">v2</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="kd">#:transparent</span><span class="p">)</span><span class="w">         </span><span class="c1">; a vector is a 2D item having an x and y component</span><span class="w"></span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">vzero</span><span class="w"> </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w">                 </span><span class="c1">; a convenient "zero vector"</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">vright</span><span class="w"> </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="c1">; the right unit vector -- a vector pointing to the right</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">vleft</span><span class="w"> </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="c1">; the left unit vector</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">vup</span><span class="w"> </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">-1</span><span class="p">))</span><span class="w">   </span><span class="c1">; the up unit vector</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">vdown</span><span class="w"> </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w">  </span><span class="c1">; the down unit vector</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>We need to define some operations on the 2D vectors: <code>vplus</code>, <code>vminus</code> and <code>vnegate</code> are analogous to the <code>+</code>, <code>-</code> and unary minus (negation) operations on numbers. There are some operations which are specific to vectors:</p>

<ul>
 <li><code>vlength</code> calculates the length of the vector,</li>
 <li><code>vnorm</code> determines the vector of length 1 which has the same direction as the given vector (effectively extracting the direction from the vector)</li>
 <li><code>vscale</code> changes the length of the vector,</li>
 <li><code>vrotate</code> rotates the vector counterclockwise by an angle</li>
 <li><code>vdot</code> calculates the <a href="https://en.wikipedia.org/wiki/Dot_product">dot product</a> of two vectors &mdash; this is a  surprisingly useful operation, if you are not familiar with it, check the  linked Wikipedia article on the topic.</li>
 <li><code>vreflect</code> calculates the &ldquo;reflection&rdquo; vector around a normal &mdash; this can be  used to determine which way a body will bounce if it hits a surface at an  angle.</li></ul>

<p>The implementation of these operations is fairly simple, but you are not familiar with vectors and their operations, you might want to use your favorite search engine to find some good introductions to them.</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">vplus</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w">                     </span><span class="c1">; vector addition</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span><span class="w"> </span><span class="p">(</span><span class="n">v2-x</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">v2-x</span><span class="w"> </span><span class="n">b</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span><span class="w"> </span><span class="p">(</span><span class="n">v2-y</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">v2-y</span><span class="w"> </span><span class="n">b</span><span class="p">))))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">vminus</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w">                    </span><span class="c1">; vector subtraction</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="p">(</span><span class="n">v2-x</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">v2-x</span><span class="w"> </span><span class="n">b</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="p">(</span><span class="n">v2-y</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">v2-y</span><span class="w"> </span><span class="n">b</span><span class="p">))))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">vnegate</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w">                     </span><span class="c1">; vector negation, i.e. (- v)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="p">(</span><span class="n">v2-x</span><span class="w"> </span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="p">(</span><span class="n">v2-y</span><span class="w"> </span><span class="n">a</span><span class="p">))))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">vscale</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w">                    </span><span class="c1">; scaling a vector by a number (Scalar)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="p">(</span><span class="n">v2-x</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="p">(</span><span class="n">v2-y</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">)))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">vdot</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w">                      </span><span class="c1">; dot product (the magic operation)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="p">(</span><span class="n">v2-x</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">v2-x</span><span class="w"> </span><span class="n">b</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="p">(</span><span class="n">v2-y</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">v2-y</span><span class="w"> </span><span class="n">b</span><span class="p">))))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">vlength</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w">                     </span><span class="c1">; the length of a vector</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match-define))" style="color: inherit">match-define</a></span><span class="w"> </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sqrt))" style="color: inherit">sqrt</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">vnorm</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w">                       </span><span class="c1">; normalize: make a unit vector with the same direction as v</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="p">(</span><span class="n">vlength</span><span class="w"> </span><span class="n">v</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="p">(</span><span class="n">v2-x</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="p">(</span><span class="n">v2-y</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="n">l</span><span class="p">)))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">vreflect</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">                  </span><span class="c1">; reflect a vector around a normal &#39;n&#39;</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">vminus</span><span class="w"> </span><span class="p">(</span><span class="n">vscale</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="n">vdot</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="n">n</span><span class="p">)))</span><span class="w"> </span><span class="n">v</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">vrotate</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="n">theta</span><span class="p">)</span><span class="w">               </span><span class="c1">; rotate counter clockwise theta radians</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">cos-theta</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._cos))" style="color: inherit">cos</a></span><span class="w"> </span><span class="n">theta</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">sin-theta</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sin))" style="color: inherit">sin</a></span><span class="w"> </span><span class="n">theta</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match-define))" style="color: inherit">match-define</a></span><span class="w"> </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="n">cos-theta</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="n">sin-theta</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="n">sin-theta</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="n">cos-theta</span><span class="w"> </span><span class="n">y</span><span class="p">))))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<h3 id="movement">Movement</h3>

<p>Finally, we need a function to update a physics body as time passes: the function will receive a body structure and a &ldquo;delta time&rdquo;, <code>dt</code>, which is the time passes since the last update, and will return a new body with an updated position, velocity and orientation, as follows:</p>

<ul>
 <li>the <code>velocity</code> is updated by applying the velocity increase, as defined by  multiplying the <code>acceleration</code> and <code>dt</code>. Also the velocity damping is  applied at this stage.</li>
 <li>the <code>position</code> is updated by applying the movement, which is the <code>velocity</code>  multiplied by the delta time, <code>dt</code>.</li>
 <li>the <code>orientation</code> is updated by applying the amount of movement obtained by  multiplying <code>angular-velocity</code> by the delta time <code>dt</code></li></ul>

<p>The <code>update-body</code> function is shown below, and there are two important things to note: (1), since the position, velocity and acceleration are vectors, the updates will automatically include the direction in which the objects move and (2) if we use zero values for the velocity and acceleration, the body will remain stationary, also a zero angular-velocity value means that the body does not rotate.</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">update-body</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">dt</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match-define))" style="color: inherit">match-define</a></span><span class="w"> </span><span class="p">(</span><span class="n">body</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="n">velocity</span><span class="w"> </span><span class="n">acceleration</span><span class="w"> </span><span class="n">radius</span><span class="w"> </span><span class="n">orientation</span><span class="w"> </span><span class="n">angular-velocity</span><span class="w"> </span><span class="n">velocity-damping</span><span class="p">)</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">new-velocity</span><span class="w"> </span><span class="p">(</span><span class="n">vscale</span><span class="w"> </span><span class="p">(</span><span class="n">vplus</span><span class="w"> </span><span class="n">velocity</span><span class="w"> </span><span class="p">(</span><span class="n">vscale</span><span class="w"> </span><span class="n">acceleration</span><span class="w"> </span><span class="n">dt</span><span class="p">))</span><span class="w"> </span><span class="n">velocity-damping</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">new-position</span><span class="w"> </span><span class="p">(</span><span class="n">vplus</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="p">(</span><span class="n">vscale</span><span class="w"> </span><span class="n">new-velocity</span><span class="w"> </span><span class="n">dt</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">new-orientation</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span><span class="w"> </span><span class="n">orientation</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="n">angular-velocity</span><span class="w"> </span><span class="n">dt</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">body</span><span class="w">               </span><span class="c1">; create and return an updated body</span><span class="w"></span>
<span class="w">   </span><span class="n">new-position</span><span class="w"></span>
<span class="w">   </span><span class="n">new-velocity</span><span class="w"></span>
<span class="w">   </span><span class="n">acceleration</span><span class="w">       </span><span class="c1">; unchanged</span><span class="w"></span>
<span class="w">   </span><span class="n">radius</span><span class="w">             </span><span class="c1">; unchanged</span><span class="w"></span>
<span class="w">   </span><span class="n">new-orientation</span><span class="w"></span>
<span class="w">   </span><span class="n">angular-velocity</span><span class="w">   </span><span class="c1">; unchanged</span><span class="w"></span>
<span class="w">   </span><span class="n">velocity-damping</span><span class="p">))</span><span class="w"> </span><span class="c1">; unchanged</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>The Physics Engine will also be responsible for handling collisions between bodies, but we already wrote a lot of code with little to show, so we&rsquo;ll switch now to writing our fist asteroid actor.</p>

<h2 id="the-asteroids">The Asteroids</h2>

<p>There is now enough functionality in the Game and Physics Engines to start building the first actor of the game: the asteroid. The asteroid will be a class derived from <code>actor%</code> and will have a way to update itself, so it moves around, and can paint itself on the screen. Before we can show the full implementation, we need to discuss how exactly we will draw the asteroid.</p>

<h3 id="models">Models</h3>

<p>All visible elements in our game will be made up from lines which connect a set of points, so each asteroid will be represented as a list of points. The simplest way to design them is to use a square ruled paper notebook to draw some circles and than outline some lines with an irregular shape. These lines must still follow the circle, as all our physics bodies will be circles, so they cannot deviate too much from that shape. Here are some examples, where I drew four asteroid models and the space ship:</p>

<div class="figure"><img src="/img/a051/asteroid-models.png" alt="" />
 <p class="caption"></p></div>

<p>The points along the circle will be scaled up to various sizes when being drawn, so we can have different sizes for the asteroids, but the initial set of points will be stored with the unit circle, that is, the radius is 1. Having the initial models use a unit circle allows us to easily calculate the size, since the scale factor is the only one that contributes to the size of the model.</p>

<p>In the picture above, the circles use 5 squares for the radius, so all coordinates are divided by 5, producing the following result:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">asteroid-path-1</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">points-&gt;dc-path</span><span class="w"></span>
<span class="w">   </span><span class="o">'</span><span class="p">((</span><span class="m">0/5</span><span class="w"> </span><span class="m">5/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">3/5</span><span class="w"> </span><span class="m">4/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">4/5</span><span class="w"> </span><span class="m">3/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">3/5</span><span class="w"> </span><span class="m">1/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">5/5</span><span class="w"> </span><span class="m">0/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">4/5</span><span class="w"> </span><span class="m">-4/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">1/5</span><span class="w"> </span><span class="m">-5/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-2/5</span><span class="w"> </span><span class="m">-4/5</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="m">-4/5</span><span class="w"> </span><span class="m">-4/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-5/5</span><span class="w"> </span><span class="m">-1/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-3/5</span><span class="w"> </span><span class="m">-1/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-5/5</span><span class="w"> </span><span class="m">2/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-3/5</span><span class="w"> </span><span class="m">3/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-2/5</span><span class="w"> </span><span class="m">5/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">0/5</span><span class="w"> </span><span class="m">5/5</span><span class="p">))))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">asteroid-path-2</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">points-&gt;dc-path</span><span class="w"></span>
<span class="w">   </span><span class="o">'</span><span class="p">((</span><span class="mi">0</span><span class="w"> </span><span class="m">-6/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-2/5</span><span class="w"> </span><span class="m">-4/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-4/5</span><span class="w"> </span><span class="m">-4/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-5/5</span><span class="w"> </span><span class="m">-1/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-4/5</span><span class="w"> </span><span class="m">2/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-4/5</span><span class="w"> </span><span class="m">3/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-3/5</span><span class="w"> </span><span class="m">3/5</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="p">(</span><span class="m">-1/5</span><span class="w"> </span><span class="m">5/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">4/5</span><span class="w"> </span><span class="m">3/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">4/5</span><span class="w"> </span><span class="m">1/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">5/5</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">4/5</span><span class="w"> </span><span class="m">-3/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">2/5</span><span class="w"> </span><span class="m">-4/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="m">-6/5</span><span class="p">))))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">asteroid-path-3</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">points-&gt;dc-path</span><span class="w"></span>
<span class="w">   </span><span class="o">'</span><span class="p">((</span><span class="m">1/5</span><span class="w"> </span><span class="m">-4/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-2/5</span><span class="w"> </span><span class="m">-5/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-2/5</span><span class="w"> </span><span class="m">-3/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-4/5</span><span class="w"> </span><span class="m">-4/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-4/5</span><span class="w"> </span><span class="m">-2/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-5/5</span><span class="w"> </span><span class="m">0/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-5/5</span><span class="w"> </span><span class="m">3/5</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="p">(</span><span class="m">-3/5</span><span class="w"> </span><span class="m">4/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-2/5</span><span class="w"> </span><span class="m">3/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">0/5</span><span class="w"> </span><span class="m">5/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">4/5</span><span class="w"> </span><span class="m">3/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">3/5</span><span class="w"> </span><span class="m">2/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">3/5</span><span class="w"> </span><span class="m">1/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">5/5</span><span class="w"> </span><span class="m">1/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">4/5</span><span class="w"> </span><span class="m">-3/5</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="p">(</span><span class="m">3/5</span><span class="w"> </span><span class="m">-5/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">1/5</span><span class="w"> </span><span class="m">-4/5</span><span class="p">))))</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">asteroid-path-4</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">points-&gt;dc-path</span><span class="w"></span>
<span class="w">   </span><span class="o">'</span><span class="p">((</span><span class="m">0/5</span><span class="w"> </span><span class="m">-5/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-2/5</span><span class="w"> </span><span class="m">-4/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-4/5</span><span class="w"> </span><span class="m">-4/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-4/5</span><span class="w"> </span><span class="m">-1/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-5/5</span><span class="w"> </span><span class="m">1/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-3/5</span><span class="w"> </span><span class="m">4/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">-1/5</span><span class="w"> </span><span class="m">5/5</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="p">(</span><span class="m">2/5</span><span class="w"> </span><span class="m">5/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">1/5</span><span class="w"> </span><span class="m">3/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">3/5</span><span class="w"> </span><span class="m">4/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">5/5</span><span class="w"> </span><span class="m">1/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">3/5</span><span class="w"> </span><span class="m">-2/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">3/5</span><span class="w"> </span><span class="m">-4/5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="m">0/5</span><span class="w"> </span><span class="m">-5/5</span><span class="p">))))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>We could have drawn these lines using <code>draw-line</code> calls on the device context of the canvas, but a more efficient way to do it is to construct a <code>dc-path%</code> object &mdash; this is an object which encapsulates several drawing commands into one, making it simpler to draw complex shapes. The <code>points-&gt;dc-path</code> function constructs such a path from our points:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">points-&gt;dc-path</span><span class="w"> </span><span class="n">points</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">dc-path%</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._unless))" style="color: inherit">unless</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._null~3f))" style="color: inherit">null?</a></span><span class="w"> </span><span class="n">points</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match-define))" style="color: inherit">match-define</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._first))" style="color: inherit">first</a></span><span class="w"> </span><span class="n">points</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="n">move-to</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span><span class="w"> </span><span class="p">([</span><span class="n">point</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._rest))" style="color: inherit">rest</a></span><span class="w"> </span><span class="n">points</span><span class="p">))])</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match-define))" style="color: inherit">match-define</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="n">line-to</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="n">path</span><span class="p">)</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>We now have <strong>bodies</strong>, representing the physical locations of our objects as well as <strong>models</strong>, representing their visual look, so we can write a function to draw the models, which is shown below. There are two important points about this function:</p>

<ul>
 <li>the <code>model</code>, which is a <code>dc-path%</code> is always drawn at scale 1 around the  origin (0, 0). To make the object bigger and position it on the screen, the  device context <code>dc</code> itself is scaled, rotated and translated.</li>
 <li>the device context <code>dc</code> is a shared resource and any setting, such as the  pen, will remain in effect until changed. It is a good habit for every draw  function to save the old parameters, change them and restore old draw  parameters before the function returns &mdash; this only needs to be done for the  draw parameters that are actually changed.</li></ul>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">draw-model</span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">pen</span><span class="w"> </span><span class="n">body</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="c1">;; Save parametes we are about to change</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">old-transformation</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">get-transformation</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">old-pen</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">get-pen</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="p">(</span><span class="n">body-position</span><span class="w"> </span><span class="n">body</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="p">(</span><span class="n">body-radius</span><span class="w"> </span><span class="n">body</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">orientation</span><span class="w"> </span><span class="p">(</span><span class="n">body-orientation</span><span class="w"> </span><span class="n">body</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">set-origin</span><span class="w"> </span><span class="p">(</span><span class="n">v2-x</span><span class="w"> </span><span class="n">position</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">v2-y</span><span class="w"> </span><span class="n">position</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">set-scale</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="n">scale</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">set-rotation</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="n">orientation</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">set-pen</span><span class="w"> </span><span class="n">pen</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">draw-path</span><span class="w"> </span><span class="n">model</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">;; restore old parameters</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">set-pen</span><span class="w"> </span><span class="n">old-pen</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">set-transformation</span><span class="w"> </span><span class="n">old-transformation</span><span class="p">))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<h3 id="the-actor">The Actor</h3>

<p>With all this preparation, we are now ready to write our first actor, the asteroid. Apart from the initialization arguments, which are used to create the physics body, the class selects a model from the list of available asteroids, selects a size between 60 and 90 and creates the physics body. The <code>update/delta-time</code> simply calls <code>update-body</code> from the physics engine, while the <code>paint</code> method calls <code>draw-model</code>.</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">asteroid-paths</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span><span class="w"> </span><span class="n">asteroid-path-1</span><span class="w"> </span><span class="n">asteroid-path-2</span><span class="w"> </span><span class="n">asteroid-path-3</span><span class="w"> </span><span class="n">asteroid-path-4</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">asteroid%</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span><span class="w"> </span><span class="n">actor%</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._init-field))" style="color: inherit">init-field</a></span><span class="w"> </span><span class="p">[</span><span class="n">initial-position</span><span class="w"> </span><span class="no">#f</span><span class="p">]</span><span class="w"></span>
<span class="w">                </span><span class="p">[</span><span class="n">initial-direction</span><span class="w"> </span><span class="p">(</span><span class="n">random-direction</span><span class="p">)]</span><span class="w"></span>
<span class="w">                </span><span class="p">[</span><span class="n">initial-speed</span><span class="w"> </span><span class="p">(</span><span class="n">random-around</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)]</span><span class="w"></span>
<span class="w">                </span><span class="p">[</span><span class="n">initial-angular-velocity</span><span class="w"> </span><span class="p">(</span><span class="n">random-around</span><span class="w"> </span><span class="mf">0.0005</span><span class="p">)]</span><span class="w"></span>

<span class="w">                </span><span class="p">[</span><span class="n">model</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/random..rkt)._random-ref))" style="color: inherit">random-ref</a></span><span class="w"> </span><span class="n">asteroid-paths</span><span class="p">)]</span><span class="w"></span>
<span class="w">                </span><span class="p">[</span><span class="n">size</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/private/base..rkt)._random))" style="color: inherit">random</a></span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="mi">90</span><span class="p">)])</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._super-new))" style="color: inherit">super-new</a></span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._unless))" style="color: inherit">unless</a></span><span class="w"> </span><span class="n">initial-position</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/exns.html#(def._((quote._~23~25kernel)._error))" style="color: inherit">error</a></span><span class="w"> </span><span class="s2">"asteroid%: initial position must be specified"</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">the-body</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">body</span><span class="w"></span>
<span class="w">       </span><span class="n">initial-position</span><span class="w"></span>
<span class="w">       </span><span class="p">(</span><span class="n">vscale</span><span class="w"> </span><span class="n">initial-direction</span><span class="w"> </span><span class="n">initial-speed</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="n">vzero</span><span class="w">                </span><span class="c1">; no acceleration</span><span class="w"></span>
<span class="w">       </span><span class="n">size</span><span class="w">                 </span><span class="c1">; radius</span><span class="w"></span>
<span class="w">       </span><span class="mi">0</span><span class="w">                    </span><span class="c1">; orientation</span><span class="w"></span>
<span class="w">       </span><span class="n">initial-angular-velocity</span><span class="w"></span>
<span class="w">       </span><span class="mf">1.0</span><span class="w">                  </span><span class="c1">; no velocity damping</span><span class="w"></span>
<span class="w">       </span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span><span class="w"> </span><span class="p">(</span><span class="n">update/delta-time</span><span class="w"> </span><span class="n">dt</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span><span class="w"> </span><span class="n">the-body</span><span class="w"> </span><span class="p">(</span><span class="n">update-body</span><span class="w"> </span><span class="n">the-body</span><span class="w"> </span><span class="n">dt</span><span class="p">)))</span><span class="w"></span>

<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">pen</span><span class="w"> </span><span class="p">(</span><span class="n">make-scaled-pen</span><span class="w"> </span><span class="s2">"firebrick"</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">size</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span><span class="w"> </span><span class="p">(</span><span class="n">paint</span><span class="w"> </span><span class="n">_canvas</span><span class="w"> </span><span class="n">dc</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">draw-model</span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">pen</span><span class="w"> </span><span class="n">the-body</span><span class="p">))))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>The above definition also makes use of two helper functions, <code>random-direction</code>, which creates a unit vector pointing in a random direction and <code>random-around</code> which generates a random number around a specified value.</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">random-direction</span><span class="p">)</span><span class="w"> </span><span class="c1">; construct a vector pointing into a random direction</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span><span class="w"> </span><span class="mi">10000</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">rnd</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/private/base..rkt)._random))" style="color: inherit">random</a></span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span><span class="w"> </span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">vnorm</span><span class="w"> </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="p">(</span><span class="n">rnd</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">rnd</span><span class="p">))))</span><span class="w"></span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">random-around</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="kd">#:precision</span><span class="w"> </span><span class="p">(</span><span class="n">precision</span><span class="w"> </span><span class="mf">1e4</span><span class="p">)</span><span class="w"> </span><span class="kd">#:nudge</span><span class="w"> </span><span class="p">(</span><span class="n">nudge</span><span class="w"> </span><span class="mf">1e-1</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">nudge</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">half-precision</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._exact-truncate))" style="color: inherit">exact-truncate</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="n">precision</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="n">n</span><span class="w">  </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/private/base..rkt)._random))" style="color: inherit">random</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span><span class="w"> </span><span class="n">half-precision</span><span class="p">)</span><span class="w"> </span><span class="n">half-precision</span><span class="p">)</span><span class="w"> </span><span class="n">precision</span><span class="p">))))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>The last helper function, <code>make-scaled-pen</code> is more subtle: when the device context is scaled up for drawing, it scales up everything, including the width of the lines, so, a pen of width 1 will show up as a line of width 30 if the device context is scaled up by 30. The <code>make-scaled-pen</code> creates pens whose width is scaled down so they show up correctly on such device contexts:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">make-scaled-pen</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="n">scale</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">the-pen-list</span><span class="w"> </span><span class="n">find-or-create-pen</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="n">scale</span><span class="p">)</span><span class="w"> </span><span class="o">'</span><span class="ss">solid</span><span class="p">))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<h3 id="a-demo">A Demo</h3>

<p>We can create a simple scene with three asteroids in, to show how it all works. For the first example, we&rsquo;ll set the initial direction to zero, so the asteroids will not move. The <code>asteroid%</code> class is also set up to pick a random asteroid model and a random angular velocity:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="n">add-actor</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">asteroid%</span><span class="w"></span>
<span class="w">                </span><span class="p">[</span><span class="n">initial-position</span><span class="w"> </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="mi">150</span><span class="w"> </span><span class="mi">200</span><span class="p">)]</span><span class="w"></span>
<span class="w">                </span><span class="p">[</span><span class="n">initial-direction</span><span class="w"> </span><span class="n">vzero</span><span class="p">]))</span><span class="w"></span>
<span class="p">(</span><span class="n">add-actor</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">asteroid%</span><span class="w"></span>
<span class="w">                </span><span class="p">[</span><span class="n">initial-position</span><span class="w"> </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="mi">350</span><span class="w"> </span><span class="mi">200</span><span class="p">)]</span><span class="w"></span>
<span class="w">                </span><span class="p">[</span><span class="n">initial-direction</span><span class="w"> </span><span class="n">vzero</span><span class="p">]))</span><span class="w"></span>
<span class="p">(</span><span class="n">add-actor</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">asteroid%</span><span class="w"></span>
<span class="w">                </span><span class="p">[</span><span class="n">initial-position</span><span class="w"> </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="mi">550</span><span class="w"> </span><span class="mi">200</span><span class="p">)]</span><span class="w"></span>
<span class="w">                </span><span class="p">[</span><span class="n">initial-direction</span><span class="w"> </span><span class="n">vzero</span><span class="p">]))</span><span class="w"></span>
<span class="p">(</span><span class="n">run-game-loop</span><span class="p">)</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<div class="figure"><img src="/img/a051/rotating-asteroids.gif" alt="" />
 <p class="caption"></p></div>

<p>Here is what happens if we assign an initial speed and direction to the asteroids:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="n">add-actor</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">asteroid%</span><span class="w"></span>
<span class="w">                </span><span class="p">[</span><span class="n">initial-position</span><span class="w"> </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="mi">150</span><span class="w"> </span><span class="mi">200</span><span class="p">)]</span><span class="w"></span>
<span class="w">                </span><span class="p">[</span><span class="n">initial-direction</span><span class="w"> </span><span class="p">(</span><span class="n">random-direction</span><span class="p">)]</span><span class="w"></span>
<span class="w">                </span><span class="p">[</span><span class="n">initial-speed</span><span class="w"> </span><span class="mf">0.04</span><span class="p">]))</span><span class="w"></span>
<span class="p">(</span><span class="n">add-actor</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">asteroid%</span><span class="w"></span>
<span class="w">                </span><span class="p">[</span><span class="n">initial-position</span><span class="w"> </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="mi">350</span><span class="w"> </span><span class="mi">200</span><span class="p">)]</span><span class="w"></span>
<span class="w">                </span><span class="p">[</span><span class="n">initial-direction</span><span class="w"> </span><span class="p">(</span><span class="n">random-direction</span><span class="p">)]</span><span class="w"></span>
<span class="w">                </span><span class="p">[</span><span class="n">initial-speed</span><span class="w"> </span><span class="mf">0.04</span><span class="p">]))</span><span class="w"></span>
<span class="p">(</span><span class="n">add-actor</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">asteroid%</span><span class="w"></span>
<span class="w">                </span><span class="p">[</span><span class="n">initial-position</span><span class="w"> </span><span class="p">(</span><span class="n">v2</span><span class="w"> </span><span class="mi">550</span><span class="w"> </span><span class="mi">200</span><span class="p">)]</span><span class="w"></span>
<span class="w">                </span><span class="p">[</span><span class="n">initial-direction</span><span class="w"> </span><span class="p">(</span><span class="n">random-direction</span><span class="p">)]</span><span class="w"></span>
<span class="w">                </span><span class="p">[</span><span class="n">initial-speed</span><span class="w"> </span><span class="mf">0.04</span><span class="p">]))</span><span class="w"></span>
<span class="p">(</span><span class="n">run-game-loop</span><span class="p">)</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<div class="figure"><img src="/img/a051/moving-asteroids.gif" alt="" />
 <p class="caption"></p></div>

<p>The asteroids now start moving, but with nothing to stop them, they just drift off the screen and never return. We need a mechanism to keep the asteroids inside the playing field, perhaps having them bounce off some invisible walls and to do that, we need to update the physics engine to handle collisions.</p>

<p>By the way, <a href="https://gist.github.com/alex-hhh/e242bc81630966af3e58017e19109f6f">here is the program we have so far</a>.</p>

<h2 id="the-physics-engine-again">The Physics Engine Again</h2>

<p>The game requires objects to collide with each other and this is also the responsibility of the physics engine. From a high level point of view, the physics engine will need to check if every pair of actors in the scene collide with each other, but keep the actual handling separate, since actual handling collisions depends on the actual actors (collisions between an asteroid and another is handled differently than collision between an asteroid and the space ship).</p>

<h3 id="collision-handling-mechanism">Collision Handling Mechanism</h3>

<p>The <code>handle-collisions</code> function is the toplevel entry into the collision handling, it receives the scene, which is a list of actors, as well as a list of collision handlers and traverses the scene, calling <code>handle-collisions-between</code> for every pair of actors. The function is careful not to check for collisions between an actor and itself, as well as not to handle collisions twice, since the collision between actors A and B is the same as the collision between the actors B and A:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">handle-collisions</span><span class="w"> </span><span class="n">scene</span><span class="w"> </span><span class="n">collision-handlers</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span><span class="w"> </span><span class="n">outer-loop</span><span class="w"> </span><span class="p">([</span><span class="n">scene</span><span class="w"> </span><span class="n">scene</span><span class="p">])</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._unless))" style="color: inherit">unless</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._null~3f))" style="color: inherit">null?</a></span><span class="w"> </span><span class="n">scene</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">first-actor</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._first))" style="color: inherit">first</a></span><span class="w"> </span><span class="n">scene</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="c1">;; Only check for collisions between FIRST-ACTOR and the remaining</span><span class="w"></span>
<span class="w">      </span><span class="c1">;; actors -- this ensures that we only call collision handling once for</span><span class="w"></span>
<span class="w">      </span><span class="c1">;; each pair.</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span><span class="w"> </span><span class="n">inner-loop</span><span class="w"> </span><span class="p">([</span><span class="n">remaining-actors</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._rest))" style="color: inherit">rest</a></span><span class="w"> </span><span class="n">scene</span><span class="p">)])</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._unless))" style="color: inherit">unless</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._null~3f))" style="color: inherit">null?</a></span><span class="w"> </span><span class="n">remaining-actors</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">second-actor</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._first))" style="color: inherit">first</a></span><span class="w"> </span><span class="n">remaining-actors</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="n">handle-collisions-between</span><span class="w"> </span><span class="n">first-actor</span><span class="w"> </span><span class="n">second-actor</span><span class="w"> </span><span class="n">collision-handlers</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="n">inner-loop</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._rest))" style="color: inherit">rest</a></span><span class="w"> </span><span class="n">remaining-actors</span><span class="p">))))</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">outer-loop</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._rest))" style="color: inherit">rest</a></span><span class="w"> </span><span class="n">scene</span><span class="p">)))))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>The <code>update-scene</code> function will need to be updated to also handle collisions before calling <code>update/delta-time</code> on each actor:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">update-scene</span><span class="w"> </span><span class="n">scene</span><span class="w"> </span><span class="n">collision-handlers</span><span class="w"> </span><span class="n">delta-time</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">handle-collisions</span><span class="w"> </span><span class="n">scene</span><span class="w"> </span><span class="n">collision-handlers</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span><span class="w"> </span><span class="p">([</span><span class="n">actor</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span><span class="w"> </span><span class="n">scene</span><span class="p">)])</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">actor</span><span class="w"> </span><span class="n">update/delta-time</span><span class="w"> </span><span class="n">delta-time</span><span class="p">)))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>The <code>handle-collisions-between</code> is responsible for finding a collision handler for a pair of objects. The <code>collision-handlers</code> is a list where we have associate a handler function for each type of actors in the scene, so it just traverses that list, finding a handler function to invoke:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">handle-collisions-between</span><span class="w"> </span><span class="n">first-actor</span><span class="w"> </span><span class="n">second-actor</span><span class="w"> </span><span class="n">collision-handlers</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/or))" style="color: inherit">for/or</a></span><span class="w"> </span><span class="p">([</span><span class="n">handler</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span><span class="w"> </span><span class="n">collision-handlers</span><span class="p">)])</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match-define))" style="color: inherit">match-define</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span><span class="w"> </span><span class="n">first-object</span><span class="w"> </span><span class="n">second-object</span><span class="w"> </span><span class="n">handler-function</span><span class="p">)</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._cond))" style="color: inherit">cond</a></span><span class="w"> </span><span class="p">((</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objectutils.html#(def._((lib._racket/private/class-internal..rkt)._is-a~3f))" style="color: inherit">is-a?</a></span><span class="w"> </span><span class="n">first-actor</span><span class="w"> </span><span class="n">first-object</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objectutils.html#(def._((lib._racket/private/class-internal..rkt)._is-a~3f))" style="color: inherit">is-a?</a></span><span class="w"> </span><span class="n">second-actor</span><span class="w"> </span><span class="n">second-object</span><span class="p">))</span><span class="w"></span>
<span class="w">           </span><span class="p">(</span><span class="n">handler-function</span><span class="w"> </span><span class="n">first-actor</span><span class="w"> </span><span class="n">second-actor</span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="no">#t</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="p">((</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objectutils.html#(def._((lib._racket/private/class-internal..rkt)._is-a~3f))" style="color: inherit">is-a?</a></span><span class="w"> </span><span class="n">first-actor</span><span class="w"> </span><span class="n">second-object</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objectutils.html#(def._((lib._racket/private/class-internal..rkt)._is-a~3f))" style="color: inherit">is-a?</a></span><span class="w"> </span><span class="n">second-actor</span><span class="w"> </span><span class="n">first-object</span><span class="p">))</span><span class="w"></span>
<span class="w">           </span><span class="p">(</span><span class="n">handler-function</span><span class="w"> </span><span class="n">second-actor</span><span class="w"> </span><span class="n">first-actor</span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="no">#t</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._else))" style="color: inherit">else</a></span><span class="w"></span>
<span class="w">           </span><span class="no">#f</span><span class="p">))))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>Finally, we maintain a global list of collision handlers and a function to add a new handler. This global list is what is passed to <code>update-scene</code> by the game loop.</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">the-collision-handlers</span><span class="w"> </span><span class="o">'</span><span class="p">())</span><span class="w"></span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">add-collision-handler</span><span class="w"> </span><span class="n">object-a</span><span class="w"> </span><span class="n">object-b</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span><span class="w"> </span><span class="n">the-collision-handlers</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" style="color: inherit">cons</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span><span class="w"> </span><span class="n">object-a</span><span class="w"> </span><span class="n">object-b</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="n">the-collision-handlers</span><span class="p">)))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>So far, we have just added a mechanism which allows invoking a handler function for every pair of actors in the scene, we now need to implement our first collision handler.</p>

<h3 id="walls">Walls</h3>

<p>One way to keep asteroids inside the playing field is to introduce some invisible walls that they can collide with. The walls will be invisible (so they will have no <code>paint</code> method) and will also not move (so they don&rsquo;t have an <code>update/delta-time</code> method). In fact a wall is simply a line defined by a normal vector (which is the direction perpendicular to the line) and a distance from the origin.</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">wall%</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span><span class="w"> </span><span class="n">actor%</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._init-field))" style="color: inherit">init-field</a></span><span class="w"> </span><span class="n">normal</span><span class="w"> </span><span class="n">distance</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._super-new))" style="color: inherit">super-new</a></span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span><span class="w"> </span><span class="p">(</span><span class="n">get-normal</span><span class="p">)</span><span class="w"> </span><span class="n">normal</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span><span class="w"> </span><span class="p">(</span><span class="n">get-distance</span><span class="p">)</span><span class="w"> </span><span class="n">distance</span><span class="p">)))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>The &ldquo;normal&rdquo; + &ldquo;distance&rdquo; way of representing lines makes it easy to determine how close a point is to a line, so, the <code>body-wall-collision?</code> function can simply calculate the distance from the centre of the body to the line and check if it is less than the body radius to determine if the body collides with the line:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">body-wall-collision?</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">wall-normal</span><span class="w"> </span><span class="n">wall-distance</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">centre-to-wall-distance</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span><span class="w"> </span><span class="p">(</span><span class="n">vdot</span><span class="w"> </span><span class="n">wall-normal</span><span class="w"> </span><span class="p">(</span><span class="n">body-position</span><span class="w"> </span><span class="n">b</span><span class="p">))</span><span class="w"> </span><span class="n">wall-distance</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span><span class="w"> </span><span class="n">centre-to-wall-distance</span><span class="w"> </span><span class="p">(</span><span class="n">body-radius</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>We can now define an &ldquo;asteroid - wall&rdquo; collision handler which checks if an asteroid is colliding with a wall, than tell the asteroid to reflect by the wall&rsquo;s normal:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">handle-asteroid-wall-collision</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">w</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span><span class="w"> </span><span class="p">(</span><span class="n">body-wall-collision?</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">get-body</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">get-normal</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">get-distance</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">reflect-by-normal</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">get-normal</span><span class="p">))))</span><span class="w"></span>

<span class="p">(</span><span class="n">add-collision-handler</span><span class="w"> </span><span class="n">asteroid%</span><span class="w"> </span><span class="n">wall%</span><span class="w"> </span><span class="n">handle-asteroid-wall-collision</span><span class="p">)</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>The asteroid class will need to be updated to provide a <code>get-body</code> and a <code>reflect-by-normal</code> methods:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">asteroid%</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span><span class="w"> </span><span class="n">actor%</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._init-field))" style="color: inherit">init-field</a></span><span class="w"> </span><span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" style="color: inherit">...</a></span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._super-new))" style="color: inherit">super-new</a></span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">the-body</span><span class="w"> </span><span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" style="color: inherit">...</a></span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span><span class="w"> </span><span class="p">(</span><span class="n">get-body</span><span class="p">)</span><span class="w"> </span><span class="n">the-body</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span><span class="w"> </span><span class="p">(</span><span class="n">reflect-by-normal</span><span class="w"> </span><span class="n">normal</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span><span class="w"> </span><span class="n">the-body</span><span class="w"> </span><span class="p">(</span><span class="n">bounce-body</span><span class="w"> </span><span class="n">the-body</span><span class="w"> </span><span class="n">normal</span><span class="p">)))</span><span class="w"></span>

<span class="w">    </span><span class="c1">;; Rest of the asteroid class unchanged</span><span class="w"></span>
<span class="w">    </span><span class="p">))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>Finally, <code>bounce-body</code> will change a body&rsquo;s direction of travel (velocity) by reflecting it off a normal. To make things a bit more interesting, the function also perturbs the reflection by the body&rsquo;s angular velocity &mdash; this is not realistic physics, but makes the game more interesting:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">bounce-body</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">scale</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span><span class="w"> </span><span class="p">(</span><span class="n">vdot</span><span class="w"> </span><span class="p">(</span><span class="n">vnorm</span><span class="w"> </span><span class="p">(</span><span class="n">body-velocity</span><span class="w"> </span><span class="n">b</span><span class="p">))</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">new-velocity</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">vrotate</span><span class="w"></span>
<span class="w">     </span><span class="p">(</span><span class="n">vreflect</span><span class="w"> </span><span class="p">(</span><span class="n">vscale</span><span class="w"> </span><span class="p">(</span><span class="n">body-velocity</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="n">scale</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span><span class="w"> </span><span class="p">(</span><span class="n">body-angular-velocity</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="mi">16</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/struct-copy.html#(form._((lib._racket/private/base..rkt)._struct-copy))" style="color: inherit">struct-copy</a></span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">[</span><span class="n">velocity</span><span class="w"> </span><span class="n">new-velocity</span><span class="p">]))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<h3 id="bouncing-off-walls">Bouncing off walls</h3>

<p>With these changes, we can add some walls to the scene and have the asteroids bounce off them. It would be more realistic to add the walls outside the scene, so the asteroids move off the screen before bounding back, but this simple example makes them more visible and making that change would mean simply adjusting the <code>distance</code> parameter for the wall:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">the-frame</span><span class="w"> </span><span class="n">reflow-container</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((quote._~23~25kernel)._define-values))" style="color: inherit">define-values</a></span><span class="w"> </span><span class="p">(</span><span class="n">canvas-width</span><span class="w"> </span><span class="n">canvas-height</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">the-canvas</span><span class="w"> </span><span class="n">get-size</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="n">add-actor</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">wall%</span><span class="w"> </span><span class="p">[</span><span class="n">normal</span><span class="w"> </span><span class="n">vright</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">distance</span><span class="w"> </span><span class="mi">0</span><span class="p">]))</span><span class="w"></span>
<span class="p">(</span><span class="n">add-actor</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">wall%</span><span class="w"> </span><span class="p">[</span><span class="n">normal</span><span class="w"> </span><span class="n">vleft</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">distance</span><span class="w"> </span><span class="n">canvas-width</span><span class="p">]))</span><span class="w"></span>
<span class="p">(</span><span class="n">add-actor</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">wall%</span><span class="w"> </span><span class="p">[</span><span class="n">normal</span><span class="w"> </span><span class="n">vdown</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">distance</span><span class="w"> </span><span class="mi">0</span><span class="p">]))</span><span class="w"></span>
<span class="p">(</span><span class="n">add-actor</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span><span class="w"> </span><span class="n">wall%</span><span class="w"> </span><span class="p">[</span><span class="n">normal</span><span class="w"> </span><span class="n">vup</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">distance</span><span class="w"> </span><span class="n">canvas-height</span><span class="p">]))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<div class="figure"><img src="/img/a051/bouncing-asteroids.gif" alt="" />
 <p class="caption"></p></div>

<h3 id="bouncing-off-other-asteroids">Bouncing off other asteroids</h3>

<p>We can easily extend collision handling to handle collision between the asteroids themselves. First, we&rsquo;ll need a function to determine if two bodies collide, this means simply calculating the distance between the positions of the two bodies and comparing it against the sum of their radii:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">bodies-collide?</span><span class="w"> </span><span class="n">b1</span><span class="w"> </span><span class="n">b2</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">center-direction</span><span class="w"> </span><span class="p">(</span><span class="n">vminus</span><span class="w"> </span><span class="p">(</span><span class="n">body-position</span><span class="w"> </span><span class="n">b1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">body-position</span><span class="w"> </span><span class="n">b2</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">distance-between-centres</span><span class="w"> </span><span class="p">(</span><span class="n">vlength</span><span class="w"> </span><span class="n">center-direction</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span><span class="w"> </span><span class="n">distance-between-centres</span><span class="w"> </span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span><span class="w"> </span><span class="p">(</span><span class="n">body-radius</span><span class="w"> </span><span class="n">b1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">body-radius</span><span class="w"> </span><span class="n">b2</span><span class="p">))))</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>The function to handle collisions between asteroids will simply bounce off both asteroids by calling <code>reflect-by-normal</code>:</p>

<div class="brush: racket">
 <div class="source">
  <table class="sourcetable">
   <tbody>
    <tr>
     <td class="linenos">
      <div class="linenodiv">
       <pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td>
     <td class="code">
      <div>
       <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="p">(</span><span class="n">handle-asteroid-asteroid-collision</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">a-body</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">get-body</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">b-body</span><span class="w"> </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">get-body</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span><span class="w"> </span><span class="p">(</span><span class="n">bodies-collide?</span><span class="w"> </span><span class="n">a-body</span><span class="w"> </span><span class="n">b-body</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span><span class="w"> </span><span class="n">collision-direction</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">vnorm</span><span class="w"> </span><span class="p">(</span><span class="n">vminus</span><span class="w"> </span><span class="p">(</span><span class="n">body-position</span><span class="w"> </span><span class="n">a-body</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">body-position</span><span class="w"> </span><span class="n">b-body</span><span class="p">))))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">reflect-by-normal</span><span class="w"> </span><span class="n">collision-direction</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">reflect-by-normal</span><span class="w"> </span><span class="p">(</span><span class="n">vscale</span><span class="w"> </span><span class="n">collision-direction</span><span class="w"> </span><span class="mi">-1</span><span class="p">))))</span><span class="w"></span>

<span class="p">(</span><span class="n">add-collision-handler</span><span class="w"> </span><span class="n">asteroid%</span><span class="w"> </span><span class="n">asteroid%</span><span class="w"> </span><span class="n">handle-asteroid-asteroid-collision</span><span class="p">)</span><span class="w"></span>
</pre></div></td></tr></tbody></table></div>

</div>

<p>This is all that is needed to make the asteroids collide. The updated version of the code so far is available in <a href="https://gist.github.com/alex-hhh/d0bddd800dbe56df31ff661347629bc8">this GitHub Gist</a>.</p>

<div class="figure"><img src="/img/a051/bouncing-asteroids-2.gif" alt="" />
 <p class="caption"></p></div>

<h2 id="final-thoughts">Final Thoughts</h2>

<p>We have spend most of this blog post designing a simple game engine and a physics engine to go with it and, while we have not completed the game yet, the last sections showed how easy it is to add game functionality once the framework is in place. In the next part we&rsquo;ll focus on building the actual actors for the game to make it playable.</p>
  <footer>
    <div class="fine-print">© Alex Harsányi, licensed under
      <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>
      , and there's a <a href="/Cookies.html">cookie policy</a>.
    </div>
    <div class="row justify-content-center">
      <nav aria-label="Page Navigation">
        <ul class="pagination">
          <li class="page-item">
            <a class="page-link" href="/2021/09/screenshots.html"
               aria-label="Previous">
              <span aria-hidden="true">&larr; Screenshots</span>
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="/2021/10/asteroids-part-2.html"
               aria-label="Next">
              <span aria-hidden="true">Asteroids (Gameplay) &rarr;</span>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </footer>
</article>
        </div>
        <div id="sidebar-content" class="col-md-3">
          <!-- will be filled in dynamically by custom.js -->
        </div>

      </div>

    </div>
  </body>
</html>