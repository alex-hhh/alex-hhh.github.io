<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <title>A Game of Tetris (gameplay)</title>
    <meta name="description" content=".. in which we implement a Tetris game step-by-step in Racket, exploring pict graphics, contracts and unit tests....">
    <meta name="author"      content="Alex Harsányi">
    <meta name="keywords"    content="racket">
    <meta name="viewport"    content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/img/favicon.svg">
    <link rel="canonical" href="https://alex-hhh.github.io/2020/03/a-game-of-tetris.html">
    <link rel="next" href="/2020/02/dual-axis-plots.html">
    <link rel="prev" href="/2020/03/a-game-of-tetris-2.html">
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css/pygments.css">
    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Condensed|Roboto+Mono&display=swap" rel="stylesheet">
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml"
          href="/feeds/all.atom.xml" title="Atom Feed">
    <link rel="alternate" type="application/rss+xml"
          href="/feeds/all.rss.xml" title="RSS Feed">
    <!-- JS -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-110325732-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-110325732-1');
    </script>
  </head>
  <body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
      <div class="container">
        <a href="/index.html" class="navbar-brand">Alex Harsányi</a>

        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
                data-target="#navbar_collapse" aria-controls="navbar_collapse"
                aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbar_collapse">
          <ul class="navbar-nav mr-auto">

            <li class="nav-item dropdown">
              <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">
                Tags <b class="caret"></b></a>
              <ul class="dropdown-menu" role="menu" id="tags-menu-content">
                <!-- will be filled in dynamically by custom.js -->
              </ul>
            </li>
            <li>
              <a class="nav-link" href="/About.html">About</a>
            </li> 
            <li>
              <a class="nav-link" href="/tags/arduino.html">Arduino</a>
            </li> 
            <li>
              <a class="nav-link" href="/tags/racket.html">Racket</a>
            </li> 
            <li>
              <a class="nav-link" href="/tags/activitylog2.html">ActivityLog2</a>
            </li> 
          </ul>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="row">

        <!-- Main column -->
        <!-- NOTE: there is a bug in the web server template renderer which
             indents all items inside if blocks.  This means that we cannot
             put the contents inside an if block, as all the <pre> tags will
             be indented.
          -->
        <div id="content" class=col-md-9>





          <article>
  <header>
    <h1>A Game of Tetris (gameplay)</h1>
    <p class='date-and-tags'>
<time datetime="2020-03-05" pubdate="true">2020-03-05</time> :: <span class="tags"><a href="/tags/racket.html">racket</a></span></p>
  </header>

<p>.. in which we implement a Tetris game step-by-step in <a href="https://www.racket-lang.org">Racket</a>, exploring pict graphics, contracts and unit tests.</p>
<!-- more-->

<p>If you are not familiar with the <a href="https://en.wikipedia.org/wiki/Tetris">Tetris</a>, you can watch a (really bad) game play below. In the game, tiles fall from above and accumulate at the bottom of the playing field and any lines that are completely filled will disappear, and all the accumulated squares will collapse below, making room for more pieces. You can play the game forever, assuming you are skilled enough to match and complete full lines to make them disappear.</p>

<div class="figure"><img src="/img/a035/tetris-play.gif" alt="Tetris Gameplay" />
 <p class="caption">Tetris Gameplay</p></div>

<hr />

<p><strong>If you are in a hurry</strong>, and don&rsquo;t want to read through the blog post, the final program is available in <a href="https://gist.github.com/alex-hhh/2ceb76ef29e964ae00e06edaa389b75c">this GitHub Gist</a>.</p>

<hr />

<p>In this blog post we&rsquo;ll build the game from ground up in several increments and we start with the Tetris blocks. Before we begin writing the <a href="https://www.racket-lang.org">racket</a> program, we need to put the following at the beginning of the file:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="kn">#lang </span><span class="nn">racket/gui</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" style="color: inherit">require</a></span> <span class="n">pict</span> <span class="n">racket/draw</span> <span class="n">racket/contract</span><span class="p">)</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._module+))" style="color: inherit">module+</a></span> <span class="n">test</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" style="color: inherit">require</a></span> <span class="n">rackunit</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The "#lang racket/gui" defines this as a Racket GUI program, and <code>pict</code>, <code>racket/draw</code> and <code>racket/contract</code> are libraries that are used by the program, while the <code>rackunit</code> library will be used for the unit tests. All these libraries are part of the standard Racket installation.</p>

<h2 id="the-tetris-blocks">The Tetris Blocks</h2>

<div class="figure"><img src="/img/a035/tetris-blocks.png" alt="The Tetris Blocks" />
 <p class="caption">The Tetris Blocks</p></div>

<p>There are seven shapes that make up the set of blocks used in Tetris, all of them fit into a 4x4 grid. The color of the blocks is not important for the game, except that it makes blocks easier to differentiate. The blocks are named using letters which roughly resemble their shape (from left to right): I, Q (from square), L, J, T, Z and S. In Racket, each block can be defined as a list of strings, with the dot (.) character stating for an empty square and a letter standing for a filled in one:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">I-Block</span>  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">Q-Block</span>  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">L-Block</span>  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">J-Block</span>
  <span class="o">'</span><span class="p">(</span><span class="s2">".I.."</span>         <span class="o">'</span><span class="p">(</span><span class="s2">"...."</span>         <span class="o">'</span><span class="p">(</span><span class="s2">"LL.."</span>         <span class="o">'</span><span class="p">(</span><span class="s2">".JJ."</span>
    <span class="s2">".I.."</span>           <span class="s2">".QQ."</span>           <span class="s2">".L.."</span>           <span class="s2">".J.."</span>
    <span class="s2">".I.."</span>           <span class="s2">".QQ."</span>           <span class="s2">".L.."</span>           <span class="s2">".J.."</span>
    <span class="s2">".I.."</span><span class="p">))</span>         <span class="s2">"...."</span><span class="p">))</span>         <span class="s2">"...."</span><span class="p">))</span>         <span class="s2">"...."</span><span class="p">))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">T-Block</span>  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">Z-Block</span>  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">S-Block</span>
  <span class="o">'</span><span class="p">(</span><span class="s2">".T.."</span>         <span class="o">'</span><span class="p">(</span><span class="s2">".Z.."</span>         <span class="o">'</span><span class="p">(</span><span class="s2">"S..."</span>
    <span class="s2">"TTT."</span>           <span class="s2">"ZZ.."</span>           <span class="s2">"SS.."</span>
    <span class="s2">"...."</span>           <span class="s2">"Z..."</span>           <span class="s2">".S.."</span>
    <span class="s2">"...."</span><span class="p">))</span>         <span class="s2">"...."</span><span class="p">))</span>         <span class="s2">"...."</span><span class="p">))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">all-blocks</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span> <span class="n">I-Block</span> <span class="n">Q-Block</span> <span class="n">L-Block</span> <span class="n">J-Block</span> <span class="n">T-Block</span> <span class="n">Z-Block</span> <span class="n">S-Block</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Using a string representation means that there is a visual cue about the shape of the blocks right in the program source. Racket will also display strings directly, so the results of various functions can be inspected directly into the REPL, without the need to define separate functions to display the data structures.</p>

<p>Using lists of strings for our blocks has some disadvantages, since Racket cannot validate a correct block definition. Before we start writing functions which manipulate these blocks, it is useful to define two validation functions, <code>valid-block-row?</code> will check if a single string is valid for a block definition, while <code>valid-block?</code> will verify that a tetris block definition actually conforms to our conventions:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">valid-block-row?</span> <span class="n">row</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string~3f))" style="color: inherit">string?</a></span> <span class="n">row</span><span class="p">)</span>                     <span class="c1">; a row is a string</span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3d))" style="color: inherit">=</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string-length))" style="color: inherit">string-length</a></span> <span class="n">row</span><span class="p">)</span> <span class="mi">4</span><span class="p">)</span>         <span class="c1">; of 4 characters</span>
       <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/and))" style="color: inherit">for/and</a></span> <span class="p">([</span><span class="n">item</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-string))" style="color: inherit">in-string</a></span> <span class="n">row</span><span class="p">)])</span> <span class="c1">; containing only valid characters</span>
         <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/base..rkt)._member))" style="color: inherit">member</a></span> <span class="n">item</span> <span class="o">'</span><span class="p">(</span><span class="sc">#\.</span> <span class="sc">#\I</span> <span class="sc">#\Q</span> <span class="sc">#\L</span> <span class="sc">#\J</span> <span class="sc">#\T</span> <span class="sc">#\Z</span> <span class="sc">#\S</span><span class="p">))</span> <span class="no">#t</span><span class="p">))))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">valid-block?</span> <span class="n">block</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list~3f))" style="color: inherit">list?</a></span> <span class="n">block</span><span class="p">)</span>                      <span class="c1">; a block is a list</span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3d))" style="color: inherit">=</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._length))" style="color: inherit">length</a></span> <span class="n">block</span><span class="p">)</span> <span class="mi">4</span><span class="p">)</span>               <span class="c1">; ... of 4 items</span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._andmap))" style="color: inherit">andmap</a></span> <span class="n">valid-block-row?</span> <span class="n">block</span><span class="p">)))</span>  <span class="c1">; ... each element is a valid row</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Since we wrote some functions, we might as well write tests for them, so we have some confidence that they work correctly. It is also a good idea to test that our functions can detect invalid cases in addition to the valid ones. The test also verifies that our block definitions are actually correct, this means that these blocks can be updated, or new ones added, and the code will automatically check that they are correct (if you run the code in DrRacket, the tests will run automatically):</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._module+))" style="color: inherit">module+</a></span> <span class="n">test</span>
  <span class="p">(</span><span class="n">check-false</span> <span class="p">(</span><span class="n">valid-block-row?</span> <span class="mi">1</span><span class="p">))</span>        <span class="c1">; not a string</span>
  <span class="p">(</span><span class="n">check-false</span> <span class="p">(</span><span class="n">valid-block-row?</span> <span class="s2">"......"</span><span class="p">))</span> <span class="c1">; more than 4 characters</span>
  <span class="p">(</span><span class="n">check-false</span> <span class="p">(</span><span class="n">valid-block-row?</span> <span class="s2">"X..."</span><span class="p">))</span>   <span class="c1">; containing invalid characters</span>

  <span class="p">(</span><span class="n">check-false</span> <span class="p">(</span><span class="n">valid-block?</span> <span class="s2">"hello"</span><span class="p">))</span>  <span class="c1">; not a list</span>
  <span class="p">(</span><span class="n">check-false</span> <span class="p">(</span><span class="n">valid-block?</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._append))" style="color: inherit">append</a></span> <span class="n">L-Block</span> <span class="n">T-Block</span><span class="p">)))</span> <span class="c1">; more than 4 items</span>
  <span class="p">(</span><span class="n">check-false</span> <span class="p">(</span><span class="n">valid-block?</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span> <span class="s2">"...."</span> <span class="s2">"...."</span> <span class="s2">"...."</span> <span class="mi">1</span><span class="p">)))</span> <span class="c1">; not a list of strings</span>
  <span class="p">(</span><span class="n">check-false</span> <span class="p">(</span><span class="n">valid-block?</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span> <span class="s2">"X..."</span> <span class="s2">"...."</span> <span class="s2">"...."</span> <span class="s2">"...."</span><span class="p">)))</span> <span class="c1">; contains invalid characters</span>

  <span class="c1">;; Verify that all our blocks are correctly defined</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span> <span class="p">([</span><span class="n">block</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span> <span class="n">all-blocks</span><span class="p">)])</span>
    <span class="p">(</span><span class="n">check-pred</span> <span class="n">valid-block?</span> <span class="n">block</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h2 id="graphics-representation-of-blocks">Graphics Representation of Blocks</h2>

<p>If you have some experience with GUI applications, you would think that we need to construct a frame and a canvas before we can draw the tetris blocks, but in Racket all this can be left until later. We will use the <a href="https://docs.racket-lang.org/pict/index.html">pict</a> package for the graphics and have them displayed directly in the DrRacket REPL.</p>

<p>Blocks can be constructed out of squares, an empty one for the spaces in the 4x4 grid and a color square for the filled in squares. The <code>square-size</code> defines the size of each square, it is useful to define it separately, so blocks can be easily made bigger or smaller. We will also define a mapping from the characters used in block strings to actual colors:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">square-size</span> <span class="mi">30</span><span class="p">)</span>                 <span class="c1">; size of a block square in pixels</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">colors</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash))" style="color: inherit">hash</a></span>
   <span class="sc">#\I</span> <span class="p">(</span><span class="n">make-color</span> <span class="mi">0</span> <span class="mi">119</span> <span class="mi">187</span><span class="p">)</span>   <span class="sc">#\Q</span> <span class="p">(</span><span class="n">make-color</span> <span class="mi">51</span> <span class="mi">187</span> <span class="mi">238</span><span class="p">)</span>
   <span class="sc">#\L</span> <span class="p">(</span><span class="n">make-color</span> <span class="mi">0</span> <span class="mi">153</span> <span class="mi">136</span><span class="p">)</span>   <span class="sc">#\J</span> <span class="p">(</span><span class="n">make-color</span> <span class="mi">238</span> <span class="mi">119</span> <span class="mi">51</span><span class="p">)</span>
   <span class="sc">#\T</span> <span class="p">(</span><span class="n">make-color</span> <span class="mi">204</span> <span class="mi">51</span> <span class="mi">17</span><span class="p">)</span>   <span class="sc">#\Z</span> <span class="p">(</span><span class="n">make-color</span> <span class="mi">238</span> <span class="mi">51</span> <span class="mi">119</span><span class="p">)</span>
   <span class="sc">#\S</span> <span class="p">(</span><span class="n">make-color</span> <span class="mi">136</span> <span class="mi">34</span> <span class="mi">85</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The <code>block-&gt;pict</code> function will take a tetris block definition and produce a picture from it. It does that by applying <code>row-&gt;squares</code> to each line in the block and appending the resulting pictures using <code>vc-append</code> (which stands for &ldquo;vertical-center append&rdquo;. The <code>row-&gt;squares</code> function will convert a block row, which is a string, into a picture, with one square for each character in the string. The function looks up the color corresponding to each character and constructs a square of the appropriate color, or an empty one if no corresponding color is found (note that there is no corresponding color for the dot (.) character, which represents the empty space).</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._define/contract))" style="color: inherit">define/contract</a></span> <span class="p">(</span><span class="n">block-&gt;pict</span> <span class="n">block</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">valid-block?</span> <span class="n">pict?</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" style="color: inherit">apply</a></span> <span class="n">vc-append</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._map))" style="color: inherit">map</a></span> <span class="n">row-&gt;squares</span> <span class="n">block</span><span class="p">)))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._define/contract))" style="color: inherit">define/contract</a></span> <span class="p">(</span><span class="n">row-&gt;squares</span> <span class="n">row</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string~3f))" style="color: inherit">string?</a></span> <span class="n">pict?</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">items</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" style="color: inherit">for/list</a></span> <span class="p">([</span><span class="n">char</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-string))" style="color: inherit">in-string</a></span> <span class="n">row</span><span class="p">)])</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">color</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash-ref))" style="color: inherit">hash-ref</a></span> <span class="n">colors</span> <span class="n">char</span> <span class="no">#f</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="n">color</span>
          <span class="p">(</span><span class="n">filled-rectangle</span> <span class="n">square-size</span> <span class="n">square-size</span> <span class="kd">#:color</span> <span class="n">color</span><span class="p">)</span>
          <span class="p">(</span><span class="n">rectangle</span> <span class="n">square-size</span> <span class="n">square-size</span><span class="p">))))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" style="color: inherit">apply</a></span> <span class="n">hc-append</span> <span class="n">items</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Both functions are protected by <a href="https://docs.racket-lang.org/guide/contracts.html">contracts</a>, as indicated by the <code>define/contract</code> form. This ensures that they will check that their arguments are what we expect them to be (e.g. a valid tetris block for the <code>block-&gt;pict</code> function) and they return the expected value, a <code>pict</code> in our case. In addition to tests, contracts are useful in ensuring that defects in the code are detected and reported as early as possible.</p>

<p>The graphics can be inspected directly in the DrRacket REPL, by running <code>(block-&gt;pict T-Block)</code> to display a single block, or building a list of these pictures using <code>(map block-&gt;pict all-blocks)</code>:</p>

<div class="figure"><img src="/img/a035/block-graphics.png" alt="Block Picts in DrRacket REPL" />
 <p class="caption">Block Picts in DrRacket REPL</p></div>

<p>The graphics representation prints out the tetris block using the entire 4x4 grid. This is not desirable in the final game, but it is useful while developing the application, as we can see how each piece aligns with the rest. Once the application is ready, these grid lines can be removed by using the <code>ghost</code> pict constructor on the <code>rectangle</code> one.</p>

<h2 id="block-rotation">Block Rotation</h2>

<div class="figure"><img src="/img/a035/all-tetris-blocks.png" alt="Tetris Blocks And Their Rotations" />
 <p class="caption">Tetris Blocks And Their Rotations</p></div>

<p>Blocks can be rotated clockwise and counter clockwise during the game, in 90 degree increments, so we need to implement a mechanism to rotate the blocks. It is not sufficient to just rotate the graphics representation (the pict library provides a <code>rotate</code> drawing adjuster), instead we need to construct new blocks which are rotated. This is needed because the blocks will also be used to determine if they collide with the bottom of the field or other blocks already at the bottom.</p>

<p>Let&rsquo;s start with the clockwise rotation. To rotate a block clock wise, each column of characters from left to right will become a row from top to bottom. The <code>rotate-clockwise</code> function works by constructing a list of strings (the rows for the new block), where each string has an element from each of the original block&rsquo;s rows. Note that the function is protected by a contract, which will verify that the parameter that the function receives is a valid block and the values that the function returns are valid blocks too:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._define/contract))" style="color: inherit">define/contract</a></span> <span class="p">(</span><span class="n">rotate-clockwise</span> <span class="n">block</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">valid-block?</span> <span class="n">valid-block?</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" style="color: inherit">for/list</a></span> <span class="p">([</span><span class="n">a</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-string))" style="color: inherit">in-string</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._first))" style="color: inherit">first</a></span> <span class="n">block</span><span class="p">))]</span>
             <span class="p">[</span><span class="n">b</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-string))" style="color: inherit">in-string</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._second))" style="color: inherit">second</a></span> <span class="n">block</span><span class="p">))]</span>
             <span class="p">[</span><span class="n">c</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-string))" style="color: inherit">in-string</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._third))" style="color: inherit">third</a></span> <span class="n">block</span><span class="p">))]</span>
             <span class="p">[</span><span class="n">d</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-string))" style="color: inherit">in-string</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._fourth))" style="color: inherit">fourth</a></span> <span class="n">block</span><span class="p">))])</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string))" style="color: inherit">string</a></span> <span class="n">d</span> <span class="n">c</span> <span class="n">b</span> <span class="n">a</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Does this function work? Since the graphics representation of blocks is printed directly in the DrRacket REPL, the function can be tested by evaluating forms like: <code>(block-&gt;pict (rotate-clockwise L-Block))</code>. It is tedious to check all rotations by typing in the REPL, but the <code>all-rotations</code> helper function will build all the rotations of a block and will allow us to visually inspect them for correctness:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._define/contract))" style="color: inherit">define/contract</a></span> <span class="p">(</span><span class="n">all-rotations</span> <span class="n">block</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">valid-block?</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/base..rkt)._listof))" style="color: inherit">listof</a></span> <span class="n">valid-block?</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/list..rkt)._reverse))" style="color: inherit">reverse</a></span>
   <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/fold))" style="color: inherit">for/fold</a></span> <span class="p">([</span><span class="n">rotations</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span> <span class="n">block</span><span class="p">)])</span>
             <span class="p">([</span><span class="n">n</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-range))" style="color: inherit">in-range</a></span> <span class="mi">3</span><span class="p">)])</span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" style="color: inherit">cons</a></span> <span class="p">(</span><span class="n">rotate-clockwise</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._car))" style="color: inherit">car</a></span> <span class="n">rotations</span><span class="p">))</span> <span class="n">rotations</span><span class="p">))))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<div class="figure"><img src="/img/a035/all-j-block-rotations.png" alt="All Rotations of the J Block in the DrRacket REPL" />
 <p class="caption">All Rotations of the J Block in the DrRacket REPL</p></div>

<p>Rotating counter clockwise could also be done using string and list manipulation, but since we already have a function to rotate clockwise, which we now know it works as expected, ca can define counter clockwise rotation simply as rotating a block clockwise 3 times. This is a bit inefficient, but it is fast enough; there will be a discussion on efficiency at the end of this blog post. For now, the aim is to get things working (and working correctly) with a minimum of effort:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._define/contract))" style="color: inherit">define/contract</a></span> <span class="p">(</span><span class="n">rotate-clockwise*</span> <span class="n">block</span> <span class="n">times</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">valid-block?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._exact-nonnegative-integer~3f))" style="color: inherit">exact-nonnegative-integer?</a></span> <span class="n">valid-block?</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="n">times</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="p">([</span><span class="n">rotated</span> <span class="p">(</span><span class="n">rotate-clockwise</span> <span class="n">block</span><span class="p">)])</span>
        <span class="p">(</span><span class="n">rotate-clockwise*</span> <span class="n">rotated</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" style="color: inherit">sub1</a></span> <span class="n">times</span><span class="p">)))</span>
      <span class="n">block</span><span class="p">))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._define/contract))" style="color: inherit">define/contract</a></span> <span class="p">(</span><span class="n">rotate-counter-clockwise</span> <span class="n">block</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">valid-block?</span> <span class="n">valid-block?</span><span class="p">)</span>
  <span class="p">(</span><span class="n">rotate-clockwise*</span> <span class="n">block</span> <span class="mi">3</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>We should also add some tests for the new functions. We&rsquo;ll test that rotating a block clockwise 4 times brings it in the same position and that rotating a block once clockwise once counter-clockwise brings it back into the initial position:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._module+))" style="color: inherit">module+</a></span> <span class="n">test</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span> <span class="p">([</span><span class="n">block</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span> <span class="n">all-blocks</span><span class="p">)])</span>
    <span class="p">(</span><span class="n">check-equal?</span> <span class="p">(</span><span class="n">rotate-clockwise*</span> <span class="n">block</span> <span class="mi">4</span><span class="p">)</span> <span class="n">block</span><span class="p">)</span>
    <span class="p">(</span><span class="n">check-equal?</span> <span class="p">(</span><span class="n">rotate-clockwise</span> <span class="p">(</span><span class="n">rotate-counter-clockwise</span> <span class="n">block</span><span class="p">))</span> <span class="n">block</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h2 id="a-first-interactive-application">A First Interactive Application</h2>

<p>There&rsquo;s now enough functionality implemented that we can start working on the actual game. To put things together, we need a <code>frame%</code> for the toplevel window, a <code>canvas%</code> to draw the playing field, a <code>timer%</code> to update the game state (which in tetris means making the pieces fall) and some mechanism to read keyboard input from the player and move the pieces.</p>

<div class="figure"><img src="/img/a035/tetris-play-0.gif" alt="Falling Blocks with Translation and Rotation" />
 <p class="caption">Falling Blocks with Translation and Rotation</p></div>

<p>Looking through the <a href="https://docs.racket-lang.org/gui/index.html">Racket GUI</a>, one can easily find the documentation for creating frames, various types of widgets, or timers, but it is not immediately obvious how to handle keyboard input. This is because keyboard input is handled by each individual widget itself, usually by overriding the <code>on-subwindow-char</code> method of a relevant widget. In our case, we need to define a game specific frame class to intercept these keyboard events. <code>tetris-frame%</code> acts like a <code>frame%</code> (which are used for toplevel windows), except it overrides the <code>on-subwindow-char</code> method and passes on the keyboard events to <code>on-tetris-event</code> function, which will be defined later. Note that keyboard events are also passed to the super class, failure to do so would make the application unresponsive to usual keyboard events (the same rule applies for mouse events, but mouse events are not used by this application):</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">tetris-frame%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">frame%</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._init))" style="color: inherit">init</a></span><span class="p">)</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._super-new))" style="color: inherit">super-new</a></span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">on-subwindow-char</span> <span class="n">receiver</span> <span class="n">event</span><span class="p">)</span>
      <span class="p">(</span><span class="n">on-tetris-event</span> <span class="n">event</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._super))" style="color: inherit">super</a></span> <span class="n">on-subwindow-char</span> <span class="n">receiver</span> <span class="n">event</span><span class="p">))))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>With the <code>tetris-frame%</code> created, the toplevel frame of the game can be instantiated and, at this stage, we need to decide how big the playing field will be. The playing fiel is defined in squares as <code>field-width</code> and <code>field-height</code>, and from these values, the size of the window itself can be determined:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((quote._~23~25kernel)._define-values))" style="color: inherit">define-values</a></span> <span class="p">(</span><span class="n">field-width</span> <span class="n">field-height</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._values))" style="color: inherit">values</a></span> <span class="mi">12</span> <span class="mi">16</span><span class="p">))</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((quote._~23~25kernel)._define-values))" style="color: inherit">define-values</a></span> <span class="p">(</span><span class="n">window-width</span> <span class="n">window-height</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._values))" style="color: inherit">values</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="n">field-width</span> <span class="n">square-size</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="n">field-height</span> <span class="n">square-size</span><span class="p">)))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">frame</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">tetris-frame%</span> <span class="p">[</span><span class="n">label</span> <span class="s2">"Tetris"</span><span class="p">]</span> <span class="p">[</span><span class="n">width</span> <span class="n">window-width</span><span class="p">]</span> <span class="p">[</span><span class="n">height</span> <span class="n">window-height</span><span class="p">]))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>We can use a <code>canvas%</code> object to display the game and this class can be used directly. When creating a canvas instance, we need to specify a paint function, which draws onto the canvas. This paint function is automatically invoked when the canvas needs to be updated, or a program can request an update by sending the canvas a <code>refresh</code> message. The paint function will currently display the current block at its location. In the application we will use the &ldquo;square coordinates&rdquo;, i.e the dimensions of a bloc are 4x4, but pixels are used when drawing, so the coordinates need to be converted to pixels &mdash; this is done by simply multiplying the coordinates by <code>square-size</code>. The <code>draw-pict</code> function is used to draw a <code>pict</code> onto the canvas:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((quote._~23~25kernel)._define-values))" style="color: inherit">define-values</a></span> <span class="p">(</span><span class="n">current-block</span> <span class="n">block-x</span> <span class="n">block-y</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._values))" style="color: inherit">values</a></span> <span class="n">L-Block</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">on-tetris-paint</span> <span class="n">canvas</span> <span class="n">dc</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">dc</span> <span class="n">clear</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="n">block-x</span> <span class="n">square-size</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">y</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="n">block-y</span> <span class="n">square-size</span><span class="p">))</span>
  <span class="p">(</span><span class="n">draw-pict</span> <span class="p">(</span><span class="n">block-&gt;pict</span> <span class="n">current-block</span><span class="p">)</span> <span class="n">dc</span> <span class="n">x</span> <span class="n">y</span><span class="p">))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">canvas</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">canvas%</span> <span class="p">[</span><span class="n">parent</span> <span class="n">frame</span><span class="p">]</span>
                    <span class="p">[</span><span class="n">min-width</span> <span class="n">window-width</span><span class="p">]</span>
                    <span class="p">[</span><span class="n">min-height</span> <span class="n">window-height</span><span class="p">]</span>
                    <span class="p">[</span><span class="n">stretchable-width</span> <span class="no">#f</span><span class="p">]</span>
                    <span class="p">[</span><span class="n">stretchable-height</span> <span class="no">#f</span><span class="p">]</span>
                    <span class="p">[</span><span class="n">paint-callback</span> <span class="n">on-tetris-paint</span><span class="p">]))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Tetris pieces will fall at a constant speed, and this can be achieved using a <code>timer%</code> which will invoke the <code>on-tetris-tick</code> function at regular intervals. This function will increment the Y position of the current block, and, if the Y position is larger than the field height (meaning that the piece is now below the field), it will create a new block by calling <code>spawn-new-block</code>. Changing the interval of the timer will make pieces fall slower or faster &mdash; in the real game the pieces start falling faster as the game progresses, but here we just use a constant value of 500 milliseconds. Note that the canvas is refreshed at the end of <code>on-tetris-tick</code>, so the updated game state is reflected on the canvas.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">on-tetris-tick</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span> <span class="n">block-y</span> <span class="n">field-height</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">block-y</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">block-y</span><span class="p">))</span>
      <span class="p">(</span><span class="n">spawn-new-block</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">canvas</span> <span class="n">refresh</span><span class="p">))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">timer</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">timer%</span> <span class="p">[</span><span class="n">notify-callback</span> <span class="n">on-tetris-tick</span><span class="p">]</span> <span class="p">[</span><span class="n">interval</span> <span class="mi">500</span><span class="p">]))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p><code>spawn-new-block</code> assigns a new block to <code>current-block</code> and sets the coordinates to the top of the field again. For now, this function just rotates through all blocks, so we can test each one in turn, but in the real game, blocks will be randomly selected:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">block-count</span> <span class="mi">-1</span><span class="p">)</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">spawn-new-block</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">block-count</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">block-count</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">current-block</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list-ref))" style="color: inherit">list-ref</a></span>
                       <span class="n">all-blocks</span>
                       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._modulo))" style="color: inherit">modulo</a></span> <span class="n">block-count</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._length))" style="color: inherit">length</a></span> <span class="n">all-blocks</span><span class="p">))))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">block-y</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">block-x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._exact-truncate))" style="color: inherit">exact-truncate</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="n">field-width</span> <span class="mi">2</span><span class="p">)</span> <span class="mi">2</span><span class="p">))))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Keyboard event handling is done in <code>on-tetris-event</code>, which is called from the frame&rsquo;s <code>on-subwindow-char</code> when a key is pressed. Left and right keys move a piece left or right by adjusting the X position of the block, while the up and down keys rotate the piece clockwise or counter-clockwise by updating the block itself. Note that the canvas is refreshed at the end, so the updated game state is reflected on the canvas.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">on-tetris-event</span> <span class="n">event</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/case.html#(form._((lib._racket/private/more-scheme..rkt)._case))" style="color: inherit">case</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">event</span> <span class="n">get-key-code</span><span class="p">)</span>
    <span class="p">((</span><span class="n">left</span><span class="p">)</span> <span class="p">(</span><span class="n">on-left-right-move</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" style="color: inherit">sub1</a></span><span class="p">))</span>
    <span class="p">((</span><span class="n">right</span><span class="p">)</span> <span class="p">(</span><span class="n">on-left-right-move</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span><span class="p">))</span>
    <span class="p">((</span><span class="n">up</span><span class="p">)</span> <span class="p">(</span><span class="n">on-rotation</span> <span class="n">rotate-clockwise</span><span class="p">))</span>
    <span class="p">((</span><span class="n">down</span><span class="p">)</span> <span class="p">(</span><span class="n">on-rotation</span> <span class="n">rotate-counter-clockwise</span><span class="p">)))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">canvas</span> <span class="n">refresh</span><span class="p">))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">on-rotation</span> <span class="n">rotate-function</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">current-block</span> <span class="p">(</span><span class="n">rotate-function</span> <span class="n">current-block</span><span class="p">)))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">on-left-right-move</span> <span class="n">direction</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">block-x</span> <span class="p">(</span><span class="n">direction</span> <span class="n">block-x</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The last part is a function to start a new game: it spawns a new block, gives the keyboard focus to the canvas and shows the toplevel frame:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">start-game</span><span class="p">)</span>
  <span class="p">(</span><span class="n">spawn-new-block</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">canvas</span> <span class="n">focus</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">frame</span> <span class="n">show</span> <span class="no">#t</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>You can find all the function written so far in <a href="https://gist.github.com/alex-hhh/67d664fb1d5bf5a867ca3fd8b87ebe08">this GitHub Gist</a>, you can load it in DrRacket and experiment with it. The program so far shows the game mechanics, but it is still far from a complete game: pieces can be moved outside the field and back in and they don&rsquo;t accumulate at the bottom. We&rsquo;ll address those tasks next.</p>

<h2 id="keeping-blocks-inside-the-playing-field">Keeping Blocks Inside the Playing Field</h2>

<p>To keep blocks inside the playing field, we need two pieces of functionality: (1) a mechanism to determine if a position is still inside the playing field, which will be used to determine if a piece can be moved left or right, and (2) a mechanism to adjust the position of a piece, to move it back inside the playing field when the piece goes outside because it is rotated. For example, the user is allowed to rotate a vertical I-Block and the block will still remain inside the playing field.</p>

<p>We can write the function <code>inside-playing-field?</code> to test if the block is inside. The function receives the block and the coordinates as parameters, even though the current block and its position is available as a global variable. This is because we need to test if a new position is still inside <em>before</em> updating the global state. The function makes use of a <code>block-bounding-box</code> helper, since we must allow the empty parts of the block to go outside the playing field, so we cannot just test that the 4x4 block is outside.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">inside-playing-field?</span> <span class="n">block</span> <span class="n">x</span> <span class="n">y</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">valid-block?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._boolean~3f))" style="color: inherit">boolean?</a></span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((quote._~23~25kernel)._define-values))" style="color: inherit">define-values</a></span> <span class="p">(</span><span class="n">min-x</span> <span class="n">min-y</span> <span class="n">max-x</span> <span class="n">max-y</span><span class="p">)</span>
    <span class="p">(</span><span class="n">block-bounding-box</span> <span class="n">block</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">x</span> <span class="n">max-x</span><span class="p">)</span> <span class="n">field-width</span><span class="p">)</span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e~3d))" style="color: inherit">&gt;=</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">x</span> <span class="n">min-x</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">y</span> <span class="n">max-y</span><span class="p">)</span> <span class="n">field-height</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Perhaps the most complex function so far is <code>block-bounding-box</code>, which determines the coordinates of the actual piece inside the 4x4 block. The function determines the minimum and maximum X and Y values and returns them as four values:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._define/contract))" style="color: inherit">define/contract</a></span> <span class="p">(</span><span class="n">block-bounding-box</span> <span class="n">block</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">valid-block?</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._values))" style="color: inherit">values</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((quote._~23~25kernel)._define-values))" style="color: inherit">define-values</a></span> <span class="p">(</span><span class="n">min-x</span> <span class="n">max-x</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/fold))" style="color: inherit">for/fold</a></span> <span class="p">([</span><span class="n">min-x</span> <span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="n">max-x</span> <span class="mi">0</span><span class="p">])</span>
              <span class="p">([</span><span class="n">row</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span> <span class="n">block</span><span class="p">)])</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">row-min-x</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/first))" style="color: inherit">for/first</a></span> <span class="p">([(</span><span class="n">item</span> <span class="n">position</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-indexed))" style="color: inherit">in-indexed</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-string))" style="color: inherit">in-string</a></span> <span class="n">row</span><span class="p">))]</span>
                                    <span class="kd">#:unless</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Equality.html#(def._((quote._~23~25kernel)._equal~3f))" style="color: inherit">equal?</a></span> <span class="sc">#\.</span> <span class="n">item</span><span class="p">))</span>
                          <span class="n">position</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">row-max-x</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/last))" style="color: inherit">for/last</a></span> <span class="p">([(</span><span class="n">item</span> <span class="n">position</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-indexed))" style="color: inherit">in-indexed</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-string))" style="color: inherit">in-string</a></span> <span class="n">row</span><span class="p">))]</span>
                                   <span class="kd">#:unless</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Equality.html#(def._((quote._~23~25kernel)._equal~3f))" style="color: inherit">equal?</a></span> <span class="sc">#\.</span> <span class="n">item</span><span class="p">))</span>
                          <span class="n">position</span><span class="p">))</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._values))" style="color: inherit">values</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="n">row-min-x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._min))" style="color: inherit">min</a></span> <span class="n">min-x</span> <span class="n">row-min-x</span><span class="p">)</span> <span class="n">min-x</span><span class="p">)</span>
              <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="n">row-max-x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span> <span class="n">max-x</span> <span class="n">row-max-x</span><span class="p">)</span> <span class="n">max-x</span><span class="p">))))</span>

  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">min-y</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/first))" style="color: inherit">for/first</a></span> <span class="p">([(</span><span class="n">row</span> <span class="n">position</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-indexed))" style="color: inherit">in-indexed</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span> <span class="n">block</span><span class="p">))]</span>
                <span class="kd">#:unless</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Equality.html#(def._((quote._~23~25kernel)._equal~3f))" style="color: inherit">equal?</a></span> <span class="n">row</span> <span class="s2">"...."</span><span class="p">))</span>
      <span class="n">position</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">max-y</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/last))" style="color: inherit">for/last</a></span> <span class="p">([(</span><span class="n">row</span> <span class="n">position</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-indexed))" style="color: inherit">in-indexed</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span> <span class="n">block</span><span class="p">))]</span>
               <span class="kd">#:unless</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Equality.html#(def._((quote._~23~25kernel)._equal~3f))" style="color: inherit">equal?</a></span> <span class="n">row</span> <span class="s2">"...."</span><span class="p">))</span>
      <span class="n">position</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._values))" style="color: inherit">values</a></span> <span class="n">min-x</span> <span class="n">min-y</span> <span class="n">max-x</span> <span class="n">max-y</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>This is a complex function, so can we know that it works correctly? Well, we can prove it by test: since there are only 28 possibilities, (7 blocks, 4 rotations each), we can visually look at every combination, and write a test for it:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._module+))" style="color: inherit">module+</a></span> <span class="n">test</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">bb-helper</span> <span class="n">block</span> <span class="n">rotations</span><span class="p">)</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._call-with-values))" style="color: inherit">call-with-values</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" style="color: inherit">lambda</a></span> <span class="p">()</span> <span class="p">(</span><span class="n">block-bounding-box</span> <span class="p">(</span><span class="n">rotate-clockwise*</span> <span class="n">block</span> <span class="n">rotations</span><span class="p">)))</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span><span class="p">))</span>

  <span class="p">(</span><span class="n">check-equal?</span> <span class="p">(</span><span class="n">bb-helper</span> <span class="n">I-Block</span> <span class="mi">0</span><span class="p">)</span> <span class="o">'</span><span class="p">(</span><span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">3</span><span class="p">))</span>
  <span class="p">(</span><span class="n">check-equal?</span> <span class="p">(</span><span class="n">bb-helper</span> <span class="n">I-Block</span> <span class="mi">1</span><span class="p">)</span> <span class="o">'</span><span class="p">(</span><span class="mi">0</span> <span class="mi">1</span> <span class="mi">3</span> <span class="mi">1</span><span class="p">))</span>
  <span class="p">(</span><span class="n">check-equal?</span> <span class="p">(</span><span class="n">bb-helper</span> <span class="n">I-Block</span> <span class="mi">2</span><span class="p">)</span> <span class="o">'</span><span class="p">(</span><span class="mi">2</span> <span class="mi">0</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">))</span>
  <span class="p">(</span><span class="n">check-equal?</span> <span class="p">(</span><span class="n">bb-helper</span> <span class="n">I-Block</span> <span class="mi">3</span><span class="p">)</span> <span class="o">'</span><span class="p">(</span><span class="mi">0</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">2</span><span class="p">))</span>
  <span class="c1">;; ...</span>
  <span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>To keep the length of this blog post in check, the above code omits most of the tests. The final application (see link below) contains the full set of tests, along with tests for <code>inside-playing-field?</code> and <code>adjust-x-position</code>.</p>

<p>The <code>adjust-x-position</code> is used to move a block left or right if it is outside the playing field, and it is used to move pieces that have been rotated back into the playing field:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._define/contract))" style="color: inherit">define/contract</a></span> <span class="p">(</span><span class="n">adjust-x-position</span> <span class="n">block</span> <span class="n">x</span> <span class="n">y</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">valid-block?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((quote._~23~25kernel)._define-values))" style="color: inherit">define-values</a></span> <span class="p">(</span><span class="n">min-x</span> <span class="n">min-y</span> <span class="n">max-x</span> <span class="n">max-y</span><span class="p">)</span>
    <span class="p">(</span><span class="n">block-bounding-box</span> <span class="n">block</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">y</span> <span class="n">max-y</span><span class="p">)</span> <span class="n">field-height</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="n">loop</span> <span class="p">([</span><span class="n">x</span> <span class="n">x</span><span class="p">])</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="n">inside-playing-field?</span> <span class="n">block</span> <span class="n">x</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">x</span>
            <span class="p">(</span><span class="n">loop</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e~3d))" style="color: inherit">&gt;=</a></span> <span class="n">x</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" style="color: inherit">sub1</a></span> <span class="n">x</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">x</span><span class="p">)))))</span>
      <span class="n">x</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h3 id="updating-the-application">Updating the Application</h3>

<p>To make use of the new functionality, we need to update the <code>on-left-right-move</code> and <code>on-rotation</code> functions: <code>on-left-right-move</code> will check if the new X position is still inside the playing field, and will only update <code>block-x</code> if it is, while <code>on-rotation</code> will check if the block falls outside after the rotation and bring it back inside the playing field:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8
9</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">on-left-right-move</span> <span class="n">direction</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">new-x</span> <span class="p">(</span><span class="n">direction</span> <span class="n">block-x</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="p">(</span><span class="n">inside-playing-field?</span> <span class="n">current-block</span> <span class="n">new-x</span> <span class="n">block-y</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">block-x</span> <span class="n">new-x</span><span class="p">)))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">on-rotation</span> <span class="n">rotate-function</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">current-block</span> <span class="p">(</span><span class="n">rotate-function</span> <span class="n">current-block</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._unless))" style="color: inherit">unless</a></span> <span class="p">(</span><span class="n">inside-playing-field?</span> <span class="n">current-block</span> <span class="n">block-x</span> <span class="n">block-y</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">block-x</span> <span class="p">(</span><span class="n">adjust-x-position</span> <span class="n">current-block</span> <span class="n">block-x</span> <span class="n">block-y</span><span class="p">))))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>This is all that is needed to keep the blocks inside the playing field, next we&rsquo;ll look into making blocks accumulate at the bottom of the field. You can find the updated program at <a href="https://gist.github.com/alex-hhh/c9e1298515a90aa97f9fb140abba5cca">this GitHub Gist</a>.</p>

<div class="figure"><img src="/img/a035/tetris-play-1.gif" alt="Blocks Staying Inside the Playing Field" />
 <p class="caption">Blocks Staying Inside the Playing Field</p></div>

<h2 id="accumulating-blocks-at-the-bottom">Accumulating Blocks at the Bottom</h2>

<p>When a falling piece reaches the bottom of the playing field, it stops there and it does not simply disappear. The next piece will stop on top of the first one and so on. The &ldquo;filled&rdquo; part at bottom part of the field cannot be represented as a collection of blocks, since lines can collapse, leaving partial blocks. Still, we can borrow from the block representation and represent the filled part as a list of strings, each string representing a single row, with characters representing colored blocks. We can even re-use the <code>row-&gt;squares</code> function to prepare the pictures for the lines. Unlike blocks, lines will not be defined by us, but created by the program, as the game progresses. Still, it is useful to have some sample data to experiment with:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">sample-filled-lines</span>
  <span class="o">'</span><span class="p">(</span><span class="s2">"...........I"</span>
    <span class="s2">"LJJJ...J...I"</span>
    <span class="s2">"LZZJ.SSJ.T.I"</span>
    <span class="s2">"LLZZSSJJTTTI"</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The above lines might be harder to visualize than the basic tetris blocks, so let&rsquo;s build a function that constructs a pict out of this data structure:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._define/contract))" style="color: inherit">define/contract</a></span> <span class="p">(</span><span class="n">filled-lines-&gt;pict</span> <span class="n">lines</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/base..rkt)._listof))" style="color: inherit">listof</a></span> <span class="n">valid-filled-line?</span><span class="p">)</span> <span class="n">pict?</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" style="color: inherit">apply</a></span> <span class="n">vc-append</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._map))" style="color: inherit">map</a></span> <span class="n">row-&gt;squares</span> <span class="n">lines</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Just as with blocks, it is useful to define a function which checks if a string is a valid filled line. The full program also has tests for all these functions, but they are omitted from this blog post:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">valid-filled-line?</span> <span class="n">line</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string~3f))" style="color: inherit">string?</a></span> <span class="n">line</span><span class="p">)</span>                   <span class="c1">; a string</span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3d))" style="color: inherit">=</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string-length))" style="color: inherit">string-length</a></span> <span class="n">line</span><span class="p">)</span> <span class="n">field-width</span><span class="p">)</span> <span class="c1">; of the correct length</span>
       <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/and))" style="color: inherit">for/and</a></span> <span class="p">([</span><span class="n">item</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-string))" style="color: inherit">in-string</a></span> <span class="n">line</span><span class="p">)])</span> <span class="c1">; containing only valid characters</span>
         <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/base..rkt)._member))" style="color: inherit">member</a></span> <span class="n">item</span> <span class="o">'</span><span class="p">(</span><span class="sc">#\.</span> <span class="sc">#\I</span> <span class="sc">#\Q</span> <span class="sc">#\L</span> <span class="sc">#\J</span> <span class="sc">#\T</span> <span class="sc">#\Z</span> <span class="sc">#\S</span><span class="p">))</span> <span class="no">#t</span><span class="p">))))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>With <code>filled-lines-&gt;pict</code> it is now easy to visualize how the filled lines look like:</p>

<div class="figure"><img src="/img/a035/filled-lines.png" alt="Inspecting Filled Lines in DrRacket REPL" />
 <p class="caption">Inspecting Filled Lines in DrRacket REPL</p></div>

<p>There are two operations that we need to implement: detecting if a block collides with the existing filled lines, and merging a block into the filled lines. These are relatively complex operations, so we&rsquo;ll define some helper functions first.</p>

<p>A row of a Tetris block is a four character string, while a filled line is a string having <code>field-width</code> characters (12 in this example). Since we need to combine blocks with filled lines, we need a function which expands a four character block row into a filled line, this is done by appending the dot (.) character representing the empty space to the front and back of the block row, according to its X position on the field:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8
9</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._define/contract))" style="color: inherit">define/contract</a></span> <span class="p">(</span><span class="n">block-row-&gt;filled-line</span> <span class="n">row</span> <span class="n">x-position</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">valid-block-row?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span> <span class="n">valid-filled-line?</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">limit</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">x-position</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string-length))" style="color: inherit">string-length</a></span> <span class="n">row</span><span class="p">)))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">items</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" style="color: inherit">for/list</a></span> <span class="p">([</span><span class="n">pos</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-range))" style="color: inherit">in-range</a></span> <span class="n">field-width</span><span class="p">)])</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._or))" style="color: inherit">or</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span> <span class="n">pos</span> <span class="n">x-position</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e~3d))" style="color: inherit">&gt;=</a></span> <span class="n">pos</span> <span class="n">limit</span><span class="p">))</span>
          <span class="sc">#\.</span>
          <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string-ref))" style="color: inherit">string-ref</a></span> <span class="n">row</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">pos</span> <span class="n">x-position</span><span class="p">)))))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" style="color: inherit">apply</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string))" style="color: inherit">string</a></span> <span class="n">items</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>There is a unit test suite for this function, but here are just some examples:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">block-row-&gt;filled-line</span> <span class="s2">".QQ."</span> <span class="mi">0</span><span class="p">)</span>
<span class="s2">".QQ........."</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">block-row-&gt;filled-line</span> <span class="s2">".QQ."</span> <span class="mi">-1</span><span class="p">)</span>
<span class="s2">"QQ.........."</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">block-row-&gt;filled-line</span> <span class="s2">".QQ."</span> <span class="mi">-2</span><span class="p">)</span> 
<span class="s2">"Q..........."</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">block-row-&gt;filled-line</span> <span class="s2">".QQ."</span> <span class="mi">8</span><span class="p">)</span>
<span class="s2">".........QQ."</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Another helper function is <code>merge-lines</code> which combines the colored squares from two lines producing a new line. The function will avoid merging a square position where both lines have a colored squares and report an error:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8
9</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._define/contract))" style="color: inherit">define/contract</a></span> <span class="p">(</span><span class="n">merge-lines</span> <span class="n">line1</span> <span class="n">line2</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">valid-filled-line?</span> <span class="n">valid-filled-line?</span> <span class="n">valid-filled-line?</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">items</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" style="color: inherit">for/list</a></span> <span class="p">([</span><span class="n">a</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-string))" style="color: inherit">in-string</a></span> <span class="n">line1</span><span class="p">)]</span>
               <span class="p">[</span><span class="n">b</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-string))" style="color: inherit">in-string</a></span> <span class="n">line2</span><span class="p">)])</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._cond))" style="color: inherit">cond</a></span> <span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Equality.html#(def._((quote._~23~25kernel)._equal~3f))" style="color: inherit">equal?</a></span> <span class="n">a</span> <span class="sc">#\.</span><span class="p">)</span> <span class="n">b</span><span class="p">)</span>
            <span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Equality.html#(def._((quote._~23~25kernel)._equal~3f))" style="color: inherit">equal?</a></span> <span class="n">b</span> <span class="sc">#\.</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span>
            <span class="p">(</span><span class="no">#t</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/exns.html#(def._((quote._~23~25kernel)._error))" style="color: inherit">error</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._format))" style="color: inherit">format</a></span> <span class="s2">"Line collision: <a href="http://docs.racket-lang.org/reference/strings.html#(def._((lib._racket/format..rkt)._~7ea))" style="color: inherit">~a</a> vs ~a"</span> <span class="n">line1</span> <span class="n">line2</span><span class="p">))))))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" style="color: inherit">apply</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string))" style="color: inherit">string</a></span> <span class="n">items</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Here is some sample use of this function:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">merge-lines</span> <span class="s2">".LL........."</span> <span class="s2">"..........JJ"</span><span class="p">)</span>
<span class="s2">".LL.......JJ"</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">merge-lines</span> <span class="s2">".JJ........."</span> <span class="s2">"QQ.........."</span><span class="p">)</span>
<span class="c1">; Line collision: .JJ......... vs QQ..........</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> 
</pre></div>
</td></tr></tbody></table>
</div>

<p><code>merge-lines</code> will raise an error if squares on the two lines collide, but sometimes it is useful to be able to test if two lines collide, without raising an error. <code>block-row-with-line-collision?</code> is such a function: it wraps <code>merge-lines</code>, traps the and just returns <code>#t</code> if merging cannot happen. The result from <code>merge-lines</code> is also discarded and the function just returns <code>#f</code> if there is no merge failure &mdash; no merge failure means that the block row does not collide with the line:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._define/contract))" style="color: inherit">define/contract</a></span> <span class="p">(</span><span class="n">block-row-with-line-collision?</span> <span class="n">block-row</span> <span class="n">x</span> <span class="n">line</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">valid-block-row?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span> <span class="n">valid-filled-line?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._boolean~3f))" style="color: inherit">boolean?</a></span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">bline</span> <span class="p">(</span><span class="n">block-row-&gt;filled-line</span> <span class="n">block-row</span> <span class="n">x</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/exns.html#(form._((lib._racket/private/more-scheme..rkt)._with-handlers))" style="color: inherit">with-handlers</a></span>
    <span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/exns.html#(def._((quote._~23~25kernel)._exn~3afail~3f))" style="color: inherit">exn:fail?</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" style="color: inherit">lambda</a></span> <span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="no">#t</span><span class="p">)))</span>
    <span class="p">(</span><span class="n">merge-lines</span> <span class="n">bline</span> <span class="n">line</span><span class="p">)</span>
    <span class="no">#f</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>To check that a Tetris Block, which is a list of rows collides with a set of filled lines, which is a list of strings representing each line, we need to recursively check that each row collides with the filled line at the same Y coordinate. The <code>block-collision?</code> does that, making sure that the block rows and filled lines are matched up based on their Y position. The function has unit tests (and it is complex enough to need them), but they are not showed here.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._define/contract))" style="color: inherit">define/contract</a></span> <span class="p">(</span><span class="n">block-collision?</span> <span class="n">block</span> <span class="n">x</span> <span class="n">y</span> <span class="n">filled-lines</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">valid-block?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/base..rkt)._listof))" style="color: inherit">listof</a></span> <span class="n">valid-filled-line?</span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._boolean~3f))" style="color: inherit">boolean?</a></span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="n">loop</span> <span class="p">([</span><span class="n">bdepth</span> <span class="n">y</span><span class="p">]</span>
             <span class="p">[</span><span class="n">block</span> <span class="n">block</span><span class="p">]</span>
             <span class="p">[</span><span class="n">fdepth</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">field-height</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._length))" style="color: inherit">length</a></span> <span class="n">filled-lines</span><span class="p">))]</span>
             <span class="p">[</span><span class="n">filled</span> <span class="n">filled-lines</span><span class="p">])</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._cond))" style="color: inherit">cond</a></span> <span class="p">((</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._or))" style="color: inherit">or</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._null~3f))" style="color: inherit">null?</a></span> <span class="n">block</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._null~3f))" style="color: inherit">null?</a></span> <span class="n">filled</span><span class="p">))</span>
           <span class="no">#f</span><span class="p">)</span>
          <span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span> <span class="n">bdepth</span> <span class="n">fdepth</span><span class="p">)</span>
           <span class="p">(</span><span class="n">loop</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">bdepth</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cdr))" style="color: inherit">cdr</a></span> <span class="n">block</span><span class="p">)</span> <span class="n">fdepth</span> <span class="n">filled</span><span class="p">))</span>
          <span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="n">bdepth</span> <span class="n">fdepth</span><span class="p">)</span>
           <span class="p">(</span><span class="n">loop</span> <span class="n">bdepth</span> <span class="n">block</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">fdepth</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cdr))" style="color: inherit">cdr</a></span> <span class="n">filled</span><span class="p">)))</span>
          <span class="p">(</span><span class="no">#t</span>
           <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="n">block-row-with-line-collision?</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._car))" style="color: inherit">car</a></span> <span class="n">block</span><span class="p">)</span> <span class="n">x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._car))" style="color: inherit">car</a></span> <span class="n">filled</span><span class="p">))</span>
               <span class="no">#t</span>
               <span class="p">(</span><span class="n">loop</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">bdepth</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cdr))" style="color: inherit">cdr</a></span> <span class="n">block</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">fdepth</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cdr))" style="color: inherit">cdr</a></span> <span class="n">filled</span><span class="p">)))))))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Merging blocks is very similar to <code>block-collision?</code> in that block rows and filled lines are paired up and merged, the added complication here is that new lines might have to be created &mdash; the simplest example is when a block is merged onto an empty set, when the playing field is initially empty:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">empty-line</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._make-string))" style="color: inherit">make-string</a></span> <span class="n">field-width</span> <span class="sc">#\.</span><span class="p">))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">maybe-add</span> <span class="n">line</span> <span class="n">result</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Equality.html#(def._((quote._~23~25kernel)._equal~3f))" style="color: inherit">equal?</a></span> <span class="n">line</span> <span class="n">empty-line</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._null~3f))" style="color: inherit">null?</a></span> <span class="n">result</span><span class="p">))</span>
      <span class="n">result</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" style="color: inherit">cons</a></span> <span class="n">line</span> <span class="n">result</span><span class="p">)))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">merge-block</span> <span class="n">block</span> <span class="n">x</span> <span class="n">y</span> <span class="n">filled-lines</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="n">loop</span> <span class="p">([</span><span class="n">bdepth</span> <span class="n">y</span><span class="p">]</span>
             <span class="p">[</span><span class="n">block</span> <span class="n">block</span><span class="p">]</span>
             <span class="p">[</span><span class="n">fdepth</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">field-height</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._length))" style="color: inherit">length</a></span> <span class="n">filled-lines</span><span class="p">))]</span>
             <span class="p">[</span><span class="n">filled</span> <span class="n">filled-lines</span><span class="p">]</span>
             <span class="p">[</span><span class="n">result</span> <span class="o">'</span><span class="p">()])</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._cond))" style="color: inherit">cond</a></span> <span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span> <span class="n">bdepth</span> <span class="n">fdepth</span><span class="p">)</span>
           <span class="c1">;; Block row is above filled lines, create new filled lines at the</span>
           <span class="c1">;; top.</span>
           <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="p">([</span><span class="n">line</span> <span class="p">(</span><span class="n">block-row-&gt;filled-line</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._car))" style="color: inherit">car</a></span> <span class="n">block</span><span class="p">)</span> <span class="n">x</span><span class="p">)])</span>
             <span class="p">(</span><span class="n">loop</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">bdepth</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cdr))" style="color: inherit">cdr</a></span> <span class="n">block</span><span class="p">)</span>
                   <span class="n">fdepth</span> <span class="n">filled</span>
                   <span class="p">(</span><span class="n">maybe-add</span> <span class="n">line</span> <span class="n">result</span><span class="p">))))</span>
          <span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="n">bdepth</span> <span class="n">fdepth</span><span class="p">)</span>
           <span class="c1">;; Filled lines are above the block row, just add them to the</span>
           <span class="c1">;; result, no merging is needed</span>
           <span class="p">(</span><span class="n">loop</span> <span class="n">y</span> <span class="n">block</span>
                 <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">fdepth</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cdr))" style="color: inherit">cdr</a></span> <span class="n">filled</span><span class="p">)</span>
                 <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" style="color: inherit">cons</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._car))" style="color: inherit">car</a></span> <span class="n">filled</span><span class="p">)</span> <span class="n">result</span><span class="p">)))</span>
          <span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e~3d))" style="color: inherit">&gt;=</a></span> <span class="n">fdepth</span> <span class="n">field-height</span><span class="p">)</span>
           <span class="c1">;; Filled lines depth is now greater than the field depth -- we&#39;re</span>
           <span class="c1">;; done.</span>
           <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/list..rkt)._reverse))" style="color: inherit">reverse</a></span> <span class="n">result</span><span class="p">))</span>
          <span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._null~3f))" style="color: inherit">null?</a></span> <span class="n">block</span><span class="p">)</span>
           <span class="c1">;; We&#39;re done with the block rows, just add the remaining filled</span>
           <span class="c1">;; lines</span>
           <span class="p">(</span><span class="n">loop</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">bdepth</span><span class="p">)</span> <span class="n">block</span>
                 <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">fdepth</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cdr))" style="color: inherit">cdr</a></span> <span class="n">filled</span><span class="p">)</span>
                 <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" style="color: inherit">cons</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._car))" style="color: inherit">car</a></span> <span class="n">filled</span><span class="p">)</span> <span class="n">result</span><span class="p">)))</span>
          <span class="p">(</span><span class="no">#t</span>
           <span class="c1">;; The block row is at the same level as a filled line.  Merge</span>
           <span class="c1">;; them, to create a new line</span>
           <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let*))" style="color: inherit">let*</a></span> <span class="p">([</span><span class="n">bline</span> <span class="p">(</span><span class="n">block-row-&gt;filled-line</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._car))" style="color: inherit">car</a></span> <span class="n">block</span><span class="p">)</span> <span class="n">x</span><span class="p">)]</span>
                  <span class="p">[</span><span class="n">line</span> <span class="p">(</span><span class="n">merge-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._car))" style="color: inherit">car</a></span> <span class="n">filled</span><span class="p">)</span> <span class="n">bline</span><span class="p">)])</span>
             <span class="p">(</span><span class="n">loop</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">bdepth</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cdr))" style="color: inherit">cdr</a></span> <span class="n">block</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">fdepth</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cdr))" style="color: inherit">cdr</a></span> <span class="n">filled</span><span class="p">)</span>
                   <span class="p">(</span><span class="n">maybe-add</span> <span class="n">line</span> <span class="n">result</span><span class="p">)))))))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h3 id="updating-the-application">Updating the Application</h3>

<p>We can now update the interactive application to add support for filling lines at the bottom, rather than just discarding the blocks. First, we need to track the filled lines, in addition to the current block, as part of the program state, and <code>start-game</code> will need to initialize this state correctly (since <code>start-game</code> can be called multiple times, to re-start a game):</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">filled-lines</span> <span class="o">'</span><span class="p">())</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">start-game</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">filled-lines</span> <span class="o">'</span><span class="p">())</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">current-block</span> <span class="no">#f</span><span class="p">)</span>
  <span class="p">(</span><span class="n">spawn-new-block</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">canvas</span> <span class="n">focus</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">frame</span> <span class="n">show</span> <span class="no">#t</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Next, we need to update <code>spawn-new-block</code> to merge the previous block into the filled lines. Since the playing field is now filling up, the &ldquo;end of game&rdquo; condition also needs to be handled, this is where a new block can no longer be spawned as it would immediately collide with the filled lines. The <code>current-block</code> will be set to <code>#f</code> when this occurs, and all the other functions will need to check this, they can no longer assume that <code>current-block</code> is always a tetris block.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">spawn-new-block</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="n">current-block</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">filled-lines</span> <span class="p">(</span><span class="n">merge-block</span> <span class="n">current-block</span> <span class="n">block-x</span> <span class="n">block-y</span> <span class="n">filled-lines</span><span class="p">)))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">block-count</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">block-count</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">current-block</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list-ref))" style="color: inherit">list-ref</a></span>
                       <span class="n">all-blocks</span>
                       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._modulo))" style="color: inherit">modulo</a></span> <span class="n">block-count</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._length))" style="color: inherit">length</a></span> <span class="n">all-blocks</span><span class="p">))))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">block-y</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">block-x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._exact-truncate))" style="color: inherit">exact-truncate</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="n">field-width</span> <span class="mi">2</span><span class="p">)</span> <span class="mi">2</span><span class="p">)))</span>

  <span class="c1">;; Playing field is full.  Game Over.</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="p">(</span><span class="n">block-collision?</span> <span class="n">current-block</span> <span class="n">block-x</span> <span class="n">block-y</span> <span class="n">filled-lines</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">current-block</span> <span class="no">#f</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The <code>on-tetris-tick</code> function will now need to check for collisions before moving a block down:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">on-tetris-tick</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="n">current-block</span>                   <span class="c1">; will be #f at the end of the game</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">inside?</span> <span class="p">(</span><span class="n">inside-playing-field?</span> <span class="n">current-block</span> <span class="n">block-x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">block-y</span><span class="p">)))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">collision?</span> <span class="p">(</span><span class="n">block-collision?</span> <span class="n">current-block</span> <span class="n">block-x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">block-y</span><span class="p">)</span> <span class="n">filled-lines</span><span class="p">))</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="n">inside?</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._not))" style="color: inherit">not</a></span> <span class="n">collision?</span><span class="p">))</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">block-y</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">block-y</span><span class="p">))</span>
        <span class="p">(</span><span class="n">spawn-new-block</span><span class="p">))</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">canvas</span> <span class="n">refresh</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The <code>on-tetris-paint</code> function will need to also paint the filled lines, this means just using <code>filled-lines-&gt;pict</code> and displaying the pict at the correct location:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">on-tetris-paint</span> <span class="n">canvas</span> <span class="n">dc</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">dc</span> <span class="n">clear</span><span class="p">)</span>

  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._unless))" style="color: inherit">unless</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._null~3f))" style="color: inherit">null?</a></span> <span class="n">filled-lines</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">depth</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">field-height</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._length))" style="color: inherit">length</a></span> <span class="n">filled-lines</span><span class="p">))</span> <span class="n">square-size</span><span class="p">))</span>
    <span class="p">(</span><span class="n">draw-pict</span> <span class="p">(</span><span class="n">filled-lines-&gt;pict</span> <span class="n">filled-lines</span><span class="p">)</span> <span class="n">dc</span> <span class="mi">0</span> <span class="n">depth</span><span class="p">))</span>

  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="n">current-block</span>                   <span class="c1">; will be #f at the end of the game</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="n">block-x</span> <span class="n">square-size</span><span class="p">))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">y</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="n">block-y</span> <span class="n">square-size</span><span class="p">))</span>
    <span class="p">(</span><span class="n">draw-pict</span> <span class="p">(</span><span class="n">block-&gt;pict</span> <span class="n">current-block</span><span class="p">)</span> <span class="n">dc</span> <span class="n">x</span> <span class="n">y</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The <code>on-tetris-event</code> will need to handle the case when the <code>current-block</code> is <code>#f</code>, and the functions that rotate and move blocks need to be updated to check if the new block position would collide with the filled lines:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">on-tetris-event</span> <span class="n">event</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="n">current-block</span>                   <span class="c1">; will be #f at the end of the game</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/case.html#(form._((lib._racket/private/more-scheme..rkt)._case))" style="color: inherit">case</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">event</span> <span class="n">get-key-code</span><span class="p">)</span>
      <span class="p">((</span><span class="n">left</span><span class="p">)</span> <span class="p">(</span><span class="n">on-left-right-move</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" style="color: inherit">sub1</a></span><span class="p">))</span>
      <span class="p">((</span><span class="n">right</span><span class="p">)</span> <span class="p">(</span><span class="n">on-left-right-move</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span><span class="p">))</span>
      <span class="p">((</span><span class="n">up</span><span class="p">)</span> <span class="p">(</span><span class="n">on-rotation</span> <span class="n">rotate-clockwise</span><span class="p">))</span>
      <span class="p">((</span><span class="n">down</span><span class="p">)</span> <span class="p">(</span><span class="n">on-rotation</span> <span class="n">rotate-counter-clockwise</span><span class="p">)))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">canvas</span> <span class="n">refresh</span><span class="p">)))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">on-rotation</span> <span class="n">rotate-function</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">candidate</span> <span class="p">(</span><span class="n">rotate-function</span> <span class="n">current-block</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((quote._~23~25kernel)._define-values))" style="color: inherit">define-values</a></span> <span class="p">(</span><span class="n">min-x</span> <span class="n">min-y</span> <span class="n">max-x</span> <span class="n">max-y</span><span class="p">)</span> <span class="p">(</span><span class="n">block-bounding-box</span> <span class="n">candidate</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._cond))" style="color: inherit">cond</a></span>
    <span class="c1">; rotating the block would make it collide, don&#39;t change it</span>
    <span class="p">((</span><span class="n">block-collision?</span> <span class="n">candidate</span> <span class="n">block-x</span> <span class="n">block-y</span> <span class="n">filled-lines</span><span class="p">)</span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" style="color: inherit">void</a></span><span class="p">))</span>
    <span class="c1">;; rotating the block would make it go below the field bottom, don&#39;t</span>
    <span class="c1">;; change it.</span>
    <span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e~3d))" style="color: inherit">&gt;=</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">block-y</span> <span class="n">max-y</span><span class="p">)</span> <span class="n">field-height</span><span class="p">)</span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" style="color: inherit">void</a></span><span class="p">))</span>
    <span class="p">(</span><span class="no">#t</span>
     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">x</span> <span class="p">(</span><span class="n">adjust-x-position</span> <span class="n">candidate</span> <span class="n">block-x</span> <span class="n">block-y</span><span class="p">))</span>
     <span class="c1">;; Bringing the block inside the playing field might make it collide, so</span>
     <span class="c1">;; we need to check again for collisions.</span>
     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._unless))" style="color: inherit">unless</a></span> <span class="p">(</span><span class="n">block-collision?</span> <span class="n">candidate</span> <span class="n">x</span> <span class="n">block-y</span> <span class="n">filled-lines</span><span class="p">)</span>
       <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">current-block</span> <span class="n">candidate</span><span class="p">)</span>
       <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">block-x</span> <span class="n">x</span><span class="p">)))))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">on-left-right-move</span> <span class="n">direction</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="p">(</span><span class="n">inside-playing-field?</span> <span class="n">current-block</span> <span class="p">(</span><span class="n">direction</span> <span class="n">block-x</span><span class="p">)</span> <span class="n">block-y</span><span class="p">)</span>
             <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._not))" style="color: inherit">not</a></span> <span class="p">(</span><span class="n">block-collision?</span> <span class="n">current-block</span> <span class="p">(</span><span class="n">direction</span> <span class="n">block-x</span><span class="p">)</span> <span class="n">block-y</span> <span class="n">filled-lines</span><span class="p">)))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">block-x</span> <span class="p">(</span><span class="n">direction</span> <span class="n">block-x</span><span class="p">))))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The application now starts to resemble a Tetris game, and you can find it in <a href="https://gist.github.com/alex-hhh/4d1b07c1672edf8f62e08a1a5012b923">this GitHub Gist</a>. If you got this far into the blog post, the remaining parts are easy, so there is no reason not to complete it.</p>

<div class="figure"><img src="/img/a035/tetris-play-2.gif" alt="Accumulating Blocks at the Bottom of the Play Field" />
 <p class="caption">Accumulating Blocks at the Bottom of the Play Field</p></div>

<h2 id="collapsing-the-complete-lines">Collapsing the Complete Lines</h2>

<p>The last task for a complete Tetris game is to remove the completed lines from the playing field. A line is complete if it contains no empty squares, which are represented by the dot (.) character:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._define/contract))" style="color: inherit">define/contract</a></span> <span class="p">(</span><span class="n">full-line?</span> <span class="n">line</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">valid-filled-line?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._boolean~3f))" style="color: inherit">boolean?</a></span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/and))" style="color: inherit">for/and</a></span> <span class="p">([</span><span class="n">char</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-string))" style="color: inherit">in-string</a></span> <span class="n">line</span><span class="p">)])</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._not))" style="color: inherit">not</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Equality.html#(def._((quote._~23~25kernel)._equal~3f))" style="color: inherit">equal?</a></span> <span class="sc">#\.</span> <span class="n">char</span><span class="p">))))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>With <code>full-line?</code> written, the completed lines can be &ldquo;collapsed&rdquo; simply by removing them from the list of filled lines:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">remove-full-lines</span> <span class="n">filled-lines</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/base..rkt)._listof))" style="color: inherit">listof</a></span> <span class="n">valid-filled-line?</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/base..rkt)._listof))" style="color: inherit">listof</a></span> <span class="n">valid-filled-line?</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" style="color: inherit">for/list</a></span> <span class="p">([</span><span class="n">line</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span> <span class="n">filled-lines</span><span class="p">)]</span> <span class="kd">#:unless</span> <span class="p">(</span><span class="n">full-line?</span> <span class="n">line</span><span class="p">))</span>
    <span class="n">line</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>As with other functions in this blog posts, these functions have tests associated with them, which you can check out in the completed application, linked below.</p>

<h3 id="completing-the-application">Completing the Application</h3>

<p>The only update is to the <code>spawn-new-block</code> which will remove filled lines after a block is merged. Since the game is now complete, <code>spawn-new-block</code> has also been updated to pick a random piece from the list of blocks, instead of cycling through the blocks:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">spawn-new-block</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="n">current-block</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">filled-lines</span> <span class="p">(</span><span class="n">merge-block</span> <span class="n">current-block</span> <span class="n">block-x</span> <span class="n">block-y</span> <span class="n">filled-lines</span><span class="p">))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">filled-lines</span> <span class="p">(</span><span class="n">remove-full-lines</span> <span class="n">filled-lines</span><span class="p">)))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">candidate</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/private/base..rkt)._random))" style="color: inherit">random</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._length))" style="color: inherit">length</a></span> <span class="n">all-blocks</span><span class="p">)))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">current-block</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list-ref))" style="color: inherit">list-ref</a></span> <span class="n">all-blocks</span> <span class="n">candidate</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">block-y</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">block-x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._exact-truncate))" style="color: inherit">exact-truncate</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="n">field-width</span> <span class="mi">2</span><span class="p">)</span> <span class="mi">2</span><span class="p">)))</span>
  <span class="c1">;; Playing field is full.  Game Over.</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="p">(</span><span class="n">block-collision?</span> <span class="n">current-block</span> <span class="n">block-x</span> <span class="n">block-y</span> <span class="n">filled-lines</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">current-block</span> <span class="no">#f</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>So there it is, a Tetris game implemented in about 700 lines of Racket code, together with comments and unit tests. You can find the final program in <a href="https://gist.github.com/alex-hhh/2ceb76ef29e964ae00e06edaa389b75c">this GitHub Gist</a>. The program is still missing several features that would make it a user friendly game, perhaps the most important one is that it does not keep score. This, and other aspects will be discussed in a future blog post.</p>

<div class="figure"><img src="/img/a035/tetris-play-3.gif" alt="Collapsing Completed Lines" />
 <p class="caption">Collapsing Completed Lines</p></div>

<h2 id="final-thoughts">Final Thoughts</h2>

<p>If you are an experienced programmer, you may have noticed that the implementation presented here is very inefficient. The chosen implementation favored simplicity and validation (to catch defects early) as much as possible. Unfortunately, simplicity and verification are usually done at the expense of performance. Let&rsquo;s see what the performance problems are:</p>

<ul>
 <li>
  <p>the <code>valid-block?</code> function is inefficient: it scans a full list and scans  each string inside this list looking for characters in another list.</p></li>
 <li>
  <p>this <code>valid-block</code> is used in a lot of function contracts, so it is called  all the time to verify arguments and return values, even though &ldquo;we know&rdquo;  that the program is correct.</p></li>
 <li>
  <p><code>rotate-clockwise</code> constructs new strings and lists every time it is called,  and has a contract on it.</p></li>
 <li>
  <p><code>rotate-counter-clockwise</code> is worse: it calls <code>rotate-clockwise</code> three times  than discards two intermediate results. Contracts are also checked on each  intermediate calls.</p></li>
 <li>
  <p>every time we display something, a pict is created, either by <code>block-&gt;pict</code>  or <code>filled-lines-&gt;pict</code>, the pict object is drawn on the canvas, than  discarded.</p></li>
 <li>
  <p>did I mention that all functions have contracts which call inefficient  functions?</p></li></ul>

<p>This program is fast enough for a Tetris game, but since most programmers are worried about performance, it is worth discussing it here. What would you do if the program would indeed need a performance boost?</p>

<p>The firsts reaction is to address the immediate problem: contracts are slow, so we disable them. After all, &ldquo;we know&rdquo; that the program is correct and nobody wants a slow program. Perhaps you would also try to implement <code>rotate-counter-clockwise</code> more efficiently, struggling with some list and string manipulation. But sometimes, it is worth taking a step back and looking at the big picture. And in the case of Tetris, the big picture is very small indeed, here is in its entirety:</p>

<div class="figure"><img src="/img/a035/all-tetris-blocks.png" alt="Tetris Blocks and Their Rotations" />
 <p class="caption">Tetris Blocks and Their Rotations</p></div>

<p>The key observation is that there are only 28 possible combinations for all the Tetris blocks. This means that all block rotations can be pre-calculated, together with the pict corresponding to each one as well as the bounding box for collision checks. To implement block rotations, all we would have to to is move up and down in the table. To draw the blocks we simply keep the current pict around until we need it. Even filled lines only change when a block is merged, so a pict for them can be pre-calculated. This type of optimization would be many times faster than the best you could achieve by removing contracts or hand optimizing code, and you still get to keep the simplicity and verification code. Something to think about.</p>
  <footer>
    <div class="fine-print">© Alex Harsányi, licensed under
      <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>
      , and there's a <a href="/Cookies.html">cookie policy</a>.
    </div>
    <div class="row justify-content-center">
      <nav aria-label="Page Navigation">
        <ul class="pagination">
          <li class="page-item">
            <a class="page-link" href="/2020/02/dual-axis-plots.html"
               aria-label="Previous">
              <span aria-hidden="true">&larr; Dual Axis Plots</span>
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="/2020/03/a-game-of-tetris-2.html"
               aria-label="Next">
              <span aria-hidden="true">A Game of Tetris (user interface) &rarr;</span>
            </a>
          </li>
        </ul>
      </nav>
    </div>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.identifier = undefined;
        this.page.url = undefined;
        this.page.title = undefined;
        this.page.category_id = undefined;
      };
      var disqus_shortname = 'alex-hhh-github-com';
      (function() {
          var dsq = document.createElement('script');
          dsq.type = 'text/javascript';
          dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          dsq.setAttribute('data-timestamp', +new Date());
          (document.head || document.body).appendChild(dsq);
      })();
    </script>
    <noscript>
      Please enable JavaScript to view the
      <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
  </footer>
</article>
        </div>
        <div id="sidebar-content" class="col-md-3">
          <!-- will be filled in dynamically by custom.js -->
        </div>

      </div>

    </div>
    <!-- </body> JS -->
  <!-- NOTE: jQuery must be loaded first -->
  <script type="text/javascript" src="/js/jquery-3.4.1.min.js"></script>
  <script type="text/javascript" src="/js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="/js/custom.js"></script>
  </body>
</html>