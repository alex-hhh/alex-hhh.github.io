<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <title>Space Invaders</title>
    <meta name="description" content="in which we attempt to recreate a classic game using the Racket graphical facilities and exploring classes and objects....">
    <meta name="author"      content="Alex Harsányi">
    <meta name="keywords"    content="games in racket, racket">
    <meta name="viewport"    content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/img/favicon.svg">
    <link rel="canonical" href="https://alex-hhh.github.io/2020/11/space-invaders.html">
    <link rel="next" href="/2020/10/world-map-using-plot.html">

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css/pygments.css">
    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Condensed|Roboto+Mono&display=swap" rel="stylesheet">
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml"
          href="/feeds/all.atom.xml" title="Atom Feed">
    <link rel="alternate" type="application/rss+xml"
          href="/feeds/all.rss.xml" title="RSS Feed">
    <!-- JS -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-110325732-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-110325732-1');
    </script>
  </head>
  <body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
      <div class="container">
        <a href="/index.html" class="navbar-brand">Alex Harsányi</a>

        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
                data-target="#navbar_collapse" aria-controls="navbar_collapse"
                aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbar_collapse">
          <ul class="navbar-nav mr-auto">

            <li class="nav-item dropdown">
              <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">
                Tags <b class="caret"></b></a>
              <ul class="dropdown-menu" role="menu" id="tags-menu-content">
                <!-- will be filled in dynamically by custom.js -->
              </ul>
            </li>
            <li>
              <a class="nav-link" href="/About.html">About</a>
            </li> 
            <li>
              <a class="nav-link" href="/tags/arduino.html">Arduino</a>
            </li> 
            <li>
              <a class="nav-link" href="/tags/racket.html">Racket</a>
            </li> 
            <li>
              <a class="nav-link" href="/tags/activitylog2.html">ActivityLog2</a>
            </li> 
          </ul>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="row">

        <!-- Main column -->
        <!-- NOTE: there is a bug in the web server template renderer which
             indents all items inside if blocks.  This means that we cannot
             put the contents inside an if block, as all the <pre> tags will
             be indented.
          -->
        <div id="content" class=col-md-9>





          <article>
  <header>
    <h1>Space Invaders</h1>
    <p class='date-and-tags'>
<time datetime="2020-11-28" pubdate="true">2020-11-28</time> :: <span class="tags"><a href="/tags/games-in-racket.html">games in racket</a>, <a href="/tags/racket.html">racket</a></span></p>
  </header>

<p>&hellip; in which we attempt to recreate a classic game using the <a href="https://www.racket-lang.org">Racket</a> graphical facilities and exploring classes and objects.</p>
<!-- more-->

<p>Space Invaders is a fairly popular game, with many implementations. Here we will implement a simple version with space ships moving and descending and a cannon shooting them. The game could be extended with other features, but this is already a very long blog post&hellip; By the way, if you are in a hurry, you can go directly to the <a href="https://gist.github.com/alex-hhh/da11a5e937960e69dc473be131be732d">the source code</a> for the game.</p>

<div class="figure"><img src="/img/a044/the-game.png" alt="" />
 <p class="caption"></p></div>

<h2 id="meet-the-aliens">Meet the Aliens</h2>

<div class="figure"><img src="/img/a044/the-aliens.svg" alt="the aliens" />
 <p class="caption">the aliens</p></div>

<p>We cannot have a Space Invader game without invaders, so let&rsquo;s design these first. Usually, the graphics resources for games are created using specialized programs, but for a simple game like Space Invaders, we can just write the models as strings and write a some Racket functions to convert them into pictures. This is the same technique used in the <a href="/2020/03/a-game-of-tetris.html">A Game Of Tetris</a> blog post. For example, here is the definition for the first alien, which we&rsquo;ll call Zabrak:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8
9</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">zabrak-frame-a</span>
  <span class="o">'</span><span class="p">(</span><span class="s2">"   ZZZ   "</span>
    <span class="s2">" ZZZZZZZ "</span>
    <span class="s2">"ZZZZZZZZZ"</span>
    <span class="s2">"Z  ZZZ  Z"</span>
    <span class="s2">"ZZZZZZZZZ"</span>
    <span class="s2">"  Z   Z  "</span>
    <span class="s2">" Z ZZZ Z "</span>
    <span class="s2">"Z       Z"</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>We can convert the above list of strings into a picture is just a few lines of code: each &ldquo;Z&rdquo; character is converted into a square, while the space characters are left empty. <code>row-&gt;squares</code> will convert a single string into a picture and <code>block-&gt;pict</code> combines the resulting pictures into a single block and applies the color to the blocks:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" style="color: inherit">require</a></span> <span class="n">pict</span> <span class="n">racket/draw</span> <span class="n">racket/gui</span><span class="p">)</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">block-&gt;pict</span> <span class="n">block</span> <span class="kd">#:color</span> <span class="p">(</span><span class="n">color</span> <span class="s2">"steelblue"</span><span class="p">))</span>
  <span class="p">(</span><span class="n">colorize</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" style="color: inherit">apply</a></span> <span class="n">vc-append</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._map))" style="color: inherit">map</a></span> <span class="n">row-&gt;squares</span> <span class="n">block</span><span class="p">))</span> <span class="n">color</span><span class="p">))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">square-size</span> <span class="mi">5</span><span class="p">)</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">row-&gt;squares</span> <span class="n">row</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">items</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" style="color: inherit">for/list</a></span> <span class="p">([</span><span class="n">char</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-string))" style="color: inherit">in-string</a></span> <span class="n">row</span><span class="p">)])</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Equality.html#(def._((quote._~23~25kernel)._equal~3f))" style="color: inherit">equal?</a></span> <span class="n">char</span> <span class="sc">#\Z</span><span class="p">)</span>
          <span class="p">(</span><span class="n">filled-rectangle</span> <span class="n">square-size</span> <span class="n">square-size</span><span class="p">)</span>
          <span class="p">(</span><span class="n">ghost</span> <span class="p">(</span><span class="n">rectangle</span> <span class="n">square-size</span> <span class="n">square-size</span><span class="p">)))))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" style="color: inherit">apply</a></span> <span class="n">hc-append</span> <span class="n">items</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The end result can be displayed directly into the DrRacket REPL, allowing us to quickly get an idea of how the image will look like and make any necessary tweaks. We can design the look of our game graphics before we even get to write any of the actual game code:</p>

<div class="figure"><img src="/img/a044/zabrak-frame-a.png" alt="" />
 <p class="caption"></p></div>

<p>The aliens in the game will be animated, having their antennas and legs move. This can be achieved by defining separate frames for each animation step:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8
9</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">zabrak-frame-a</span>     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">zabrak-frame-b</span>     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">zabrak-frame-c</span>
  <span class="o">'</span><span class="p">(</span><span class="s2">"   ZZZ   "</span>               <span class="o">'</span><span class="p">(</span><span class="s2">"   ZZZ   "</span>              <span class="o">'</span><span class="p">(</span><span class="s2">"   ZZZ   "</span>
    <span class="s2">" ZZZZZZZ "</span>                 <span class="s2">" ZZZZZZZ "</span>                <span class="s2">" ZZZZZZZ "</span>
    <span class="s2">"ZZZZZZZZZ"</span>                 <span class="s2">"ZZZZZZZZZ"</span>                <span class="s2">"ZZZZZZZZZ"</span>
    <span class="s2">"Z  ZZZ  Z"</span>                 <span class="s2">"Z  ZZZ  Z"</span>                <span class="s2">"Z  ZZZ  Z"</span>
    <span class="s2">"ZZZZZZZZZ"</span>                 <span class="s2">"ZZZZZZZZZ"</span>                <span class="s2">"ZZZZZZZZZ"</span>
    <span class="s2">"  Z   Z  "</span>                 <span class="s2">"  Z   Z  "</span>                <span class="s2">"  Z   Z  "</span>
    <span class="s2">" Z ZZZ Z "</span>                 <span class="s2">" Z ZZZ Z "</span>                <span class="s2">" Z ZZZ Z "</span>
    <span class="s2">"Z       Z"</span><span class="p">))</span>               <span class="s2">" Z     Z "</span><span class="p">))</span>              <span class="s2">"  Z   Z  "</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>We can visualize all the frames by applying <code>block-&gt;pict</code> on each of them, although it is difficult to see that the common parts overlap correctly and only the intended parts move:</p>

<div class="figure"><img src="/img/a044/zabrak-all-frames.png" alt="" />
 <p class="caption"></p></div>

<h3 id="animations-in-the-repl">Animations in the REPL</h3>

<p>While the DrRacket REPL can display pictures directly, it cannot display animations. However, we can extend the REPL to support this: The REPL recognizes special objects, called &ldquo;snips&rdquo; which are objects that can display anything in the REPL. Snips can be used for a lot of cool things, such as using them directly in games, such as <a href="/2020/06/ishido.html">Ishido</a> and <a href="/2018/10/chess-game-using-racket-s-pasteboard.html">Chess Game Interface</a>, but also at providing complex visualizations in the REPL, for example an <a href="/2019/09/map-snip.html">interactive map</a>. Here we&rsquo;ll write a simple snip to animate some pictures.</p>

<p>The <code>animation-snip-class</code> is an object which is used to deserialize snips &mdash; we don&rsquo;t use this feature directly, but the Racket GUI system requires one such object to be defined for every type of snip class. The code is mostly boilerplate, but one such object needs to be defined for every type of snip used by the application, and each such object needs to have a different class name set using <code>set-classname</code>:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">animation-snip-class</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objcreation.html#(def._((lib._racket/private/class-internal..rkt)._make-object))" style="color: inherit">make-object</a></span>
   <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">snip-class%</span>
     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._super-new))" style="color: inherit">super-new</a></span><span class="p">)</span>
     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span> <span class="n">set-classname</span> <span class="s2">"animation-snip-class"</span><span class="p">))))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The <code>animation-snip%</code> class is the actual snip and derives from the <code>snip%</code> class from the Racket GUI libraries. When constructed, it receives a list of pictures, <code>picts</code>, which are the individual frames of the animation, as well as an <code>interval</code>, in milliseconds, which defines the time between changing pictures. It has the following member variables and methods:</p>

<ul>
 <li>
  <p>The <code>width</code> and <code>height</code> members of the snip define the width and height of  the entire snip, being the maximum of all the pictures &mdash; this allows using  different sized pictures for the animation.</p></li>
 <li>
  <p><code>index</code> represents the current picture being displayed &mdash; a snip cannot  simply draw when it wants to, instead the system will invoke its <code>draw</code>  method at unspecified intervals, so it must be ready to draw its current  state at any time.</p></li>
 <li>
  <p>the <code>on-refresh</code> method is invoked periodically from a timer (see <code>timer%</code>  creation below), and will increment the frame and tell the snip  administrator that this snip needs to be redrawn &mdash; this is how a snip can  inform the system that it has changed.</p></li>
 <li>
  <p>the <code>copy</code> method creates a copy of the snip, this is required for snips  which are used directly in the DrRacket REPL, in this case, the  implementation is simple: it creates and returns new animation snip with the  same pictures and refresh interval.</p></li>
 <li>
  <p>the <code>get-extent</code> method is invoked by the system to determine the size of  the snip &mdash; it is used to know how much space to reserve for it, so it lines  up nicely with other things in the REPL.</p></li>
 <li>
  <p>the <code>draw</code> method is invoked by the system to actually draw the snip. While  the snip can draw anywhere it wants, it should usually draw at the passed  <code>x</code>, <code>y</code> coordinates, and not extend past the width and height it has  supplied to <code>get-extent</code>. In the animation snip case, the draw method uses  <code>draw-pict</code> (provided by the <code>pict</code> library), to draw the current picture.</p></li></ul>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">animation-snip%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">snip%</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._init-field))" style="color: inherit">init-field</a></span> <span class="n">picts</span> <span class="p">[</span><span class="n">interval</span> <span class="mi">500</span><span class="p">])</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._super-new))" style="color: inherit">super-new</a></span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span> <span class="n">set-snipclass</span> <span class="n">animation-snip-class</span><span class="p">)</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">width</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" style="color: inherit">apply</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._map))" style="color: inherit">map</a></span> <span class="n">pict-width</span> <span class="n">picts</span><span class="p">)))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">height</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" style="color: inherit">apply</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._map))" style="color: inherit">map</a></span> <span class="n">pict-height</span> <span class="n">picts</span><span class="p">)))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">index</span> <span class="mi">0</span><span class="p">)</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">on-refresh</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">index</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._modulo))" style="color: inherit">modulo</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">index</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._length))" style="color: inherit">length</a></span> <span class="n">picts</span><span class="p">)))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">admin</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span> <span class="n">get-admin</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="n">admin</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">admin</span> <span class="n">needs-update</span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span> <span class="mi">0</span> <span class="mi">0</span> <span class="n">width</span> <span class="n">height</span><span class="p">)))</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">timer</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">timer%</span> <span class="p">[</span><span class="n">interval</span> <span class="n">interval</span><span class="p">]</span> <span class="p">[</span><span class="n">notify-callback</span> <span class="n">on-refresh</span><span class="p">]))</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">copy</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">animation-snip%</span> <span class="p">[</span><span class="n">picts</span> <span class="n">picts</span><span class="p">]</span> <span class="p">[</span><span class="n">interval</span> <span class="n">interval</span><span class="p">]))</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">get-extent</span> <span class="n">dc</span> <span class="n">x</span> <span class="n">y</span> <span class="n">w</span> <span class="n">h</span> <span class="n">descent</span> <span class="n">space</span> <span class="n">lspace</span> <span class="n">rspace</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="n">w</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/boxes.html#(def._((quote._~23~25kernel)._set-box!))" style="color: inherit">set-box!</a></span> <span class="n">w</span> <span class="n">width</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="n">h</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/boxes.html#(def._((quote._~23~25kernel)._set-box!))" style="color: inherit">set-box!</a></span> <span class="n">h</span> <span class="n">height</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="n">descent</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/boxes.html#(def._((quote._~23~25kernel)._set-box!))" style="color: inherit">set-box!</a></span> <span class="n">descent</span> <span class="mf">0.0</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="n">space</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/boxes.html#(def._((quote._~23~25kernel)._set-box!))" style="color: inherit">set-box!</a></span> <span class="n">space</span> <span class="mf">0.0</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="n">lspace</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/boxes.html#(def._((quote._~23~25kernel)._set-box!))" style="color: inherit">set-box!</a></span> <span class="n">lspace</span> <span class="mf">0.0</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="n">rspace</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/boxes.html#(def._((quote._~23~25kernel)._set-box!))" style="color: inherit">set-box!</a></span> <span class="n">rspace</span> <span class="mf">0.0</span><span class="p">)))</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">draw</span> <span class="n">dc</span> <span class="n">x</span> <span class="n">y</span> <span class="o">.</span> <span class="n">other</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">pict</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list-ref))" style="color: inherit">list-ref</a></span> <span class="n">picts</span> <span class="n">index</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">ox</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">width</span> <span class="p">(</span><span class="n">pict-width</span> <span class="n">pict</span><span class="p">))</span> <span class="mf">0.5</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">oy</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">height</span> <span class="p">(</span><span class="n">pict-height</span> <span class="n">pict</span><span class="p">))</span> <span class="mf">0.5</span><span class="p">))</span>
      <span class="p">(</span><span class="n">draw-pict</span> <span class="n">pict</span> <span class="n">dc</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">x</span> <span class="n">ox</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">y</span> <span class="n">oy</span><span class="p">)))</span>
    <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The <code>animation-snip%</code> can be used directly, but object creation can be verbose, so we can define a more convenient <code>animate</code> function which creates this snip:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">animate</span> <span class="n">picts</span> <span class="kd">#:interval</span> <span class="p">[</span><span class="n">interval</span> <span class="mi">500</span><span class="p">])</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">animation-snip%</span> <span class="p">[</span><span class="n">picts</span> <span class="n">picts</span><span class="p">]</span> <span class="p">[</span><span class="n">interval</span> <span class="n">interval</span><span class="p">]))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>To visualize the actual animation, we can simply call <code>animate</code> with the list of the pictures provided by <code>block-&gt;pict</code>. Even though only three frames have been defined for this alien, the actual animation needs to go though the steps A, B, C, B before it cycles back to the first frame. This is something that is not easy to pick up if the animation frames are listed side-by-side, but it is immediately obvious once the animation is played.</p>

<div class="figure"><img src="/img/a044/zabrak.gif" alt="" />
 <p class="caption"></p></div>

<p>The <code>animation-snip%</code> itself will not be used in the game, but it is a useful tool in designing the game animations themselves. With the <code>animation-snip%</code> done, the rest of the aliens can be designed:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">zabrak-color</span> <span class="s2">"Steel Blue"</span><span class="p">)</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">zabrak-pict-a</span> <span class="p">(</span><span class="n">block-&gt;pict</span> <span class="n">zabrak-frame-a</span> <span class="kd">#:color</span> <span class="n">zabrak-color</span><span class="p">))</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">zabrak-pict-b</span> <span class="p">(</span><span class="n">block-&gt;pict</span> <span class="n">zabrak-frame-b</span> <span class="kd">#:color</span> <span class="n">zabrak-color</span><span class="p">))</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">zabrak-pict-c</span> <span class="p">(</span><span class="n">block-&gt;pict</span> <span class="n">zabrak-frame-c</span> <span class="kd">#:color</span> <span class="n">zabrak-color</span><span class="p">))</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">zabrak-animation</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span> <span class="n">zabrak-pict-a</span> <span class="n">zabrak-pict-b</span> <span class="n">zabrak-pict-c</span> <span class="n">zabrak-pict-b</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<div class="figure"><img src="/img/a044/all-aliens.gif" alt="" />
 <p class="caption"></p></div>

<p>You can design your own aliens: pictures for alien models can be easily found with an Internet search, and if you are unsure how to name the aliens, Wikipedia has a page listing <a href="https://en.wikipedia.org/wiki/List_of_fictional_alien_species:_Z">alien species names</a>. Finally, if you want to just have a look a the ones I defined, they are available in the <a href="https://gist.github.com/alex-hhh/da11a5e937960e69dc473be131be732d">game source</a>.</p>

<h2 id="prepare-the-arena">Prepare the Arena</h2>

<p>The Space Invaders game involves several &ldquo;actors&rdquo;: the alien ships moving across the screen, the canon moving left and right in response to user input and shooting lasers and the lasers hitting space ships. These actors need to be able to draw the object in the game window, respond to keyboard input and interact witch each other (for example, when a laser shot hits a space ship). The actors will also need a common &ldquo;clock&rdquo;, which measures the passage of time &mdash; this will be used both to drive animations and move objects across the screen.</p>

<p>We will need to write some code to manage the shared access to these resources and provide a common interface for the actors. This code is relatively generic: it does not know anything about the game or the game rules itself and could be reused to implement other games. For more serious games, this would be called a &ldquo;game engine&rdquo; but our code is too simple to deserve that name, so we will not use it here, instead we will call it an &ldquo;arena&rdquo;.</p>

<h3 id="the-scene">The Scene</h3>

<p>All the game actors can be kept in a global list named <code>scene</code>, with the <code>add-actor</code> and <code>remove-actor</code> functions added as a convenience. Actors such as space ships will be added at the start of the game, but other actors, like laser shots will be added during the game. Finally, actors can also be removed during the game, for example a space ship which was hit by a laser shot.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">scene</span> <span class="o">'</span><span class="p">())</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">add-actor</span> <span class="n">actor</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">actors</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" style="color: inherit">cons</a></span> <span class="n">actor</span> <span class="n">scene</span><span class="p">)))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">remove-actor</span> <span class="n">actor</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">actors</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/list..rkt)._remove))" style="color: inherit">remove</a></span> <span class="n">actor</span> <span class="n">scene</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h3 id="the-gui">The GUI</h3>

<p>The game itself will be displayed in a window, which, in Racket GUI is a <code>frame%</code>. Frame objects also receive keyboard events and by overriding the <code>on-subwindow-char</code> method we can intercept these and send them to all the actors in the scene. The frame will also be notified when the window is closed, via the <code>on-close</code> method and we use this opportunity to set the <code>game-outcome</code> to <code>'abandoned</code>. The game loop described below will monitor this variable to know when to exit the game.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">game-outcome</span> <span class="o">'</span><span class="ss">undecided</span><span class="p">)</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">the-frame</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">frame%</span>
         <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._super-new))" style="color: inherit">super-new</a></span> <span class="p">[</span><span class="n">label</span> <span class="s2">"Space Invaders"</span><span class="p">]</span> <span class="p">[</span><span class="n">width</span> <span class="mi">1024</span><span class="p">]</span> <span class="p">[</span><span class="n">height</span> <span class="mi">768</span><span class="p">])</span>
         <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/augride))" style="color: inherit">define/augride</a></span> <span class="p">(</span><span class="n">on-close</span><span class="p">)</span>
           <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">game-outcome</span> <span class="o">'</span><span class="ss">abandoned</span><span class="p">))</span>
         <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">on-subwindow-char</span> <span class="n">receiver</span> <span class="n">event</span><span class="p">)</span>
           <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span> <span class="p">([</span><span class="n">o</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span> <span class="n">scene</span><span class="p">)])</span>
             <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">o</span> <span class="n">keyboard-event</span> <span class="n">event</span><span class="p">))</span>
           <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._super))" style="color: inherit">super</a></span> <span class="n">on-subwindow-char</span> <span class="n">receiver</span> <span class="n">event</span><span class="p">)))))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>A somewhat unusual technique is used to create <code>the-frame%</code> in the code above: we create a class derived from <code>frame%</code> using <code>class</code>, than immediately instantiate that derived class and assign the resulting object to <code>the-frame</code>. In other languages, this is a two step process, but in Racket, they can be combined:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">our-frame%</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">frame%</span> <span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" style="color: inherit">...</a></span><span class="p">))</span>  <span class="c1">;; Create/Define the subclass</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">the-frame</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">our-frame%</span> <span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" style="color: inherit">...</a></span><span class="p">))</span> <span class="c1">;; Create an object of the subclass</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Drawing for the game will happen in a <code>canvas%</code> instance, but we also need to derive from the <code>canvas%</code> class and override the <code>on-size</code> method, so we are informed when the size of the canvas changes, for example when the window is resized. We could also override <code>on-paint</code> for painting onto the canvas, but instead we use the <code>paint-callback</code> init member to provide the paint function.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8
9</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">the-canvas</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">canvas%</span>
         <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._super-new))" style="color: inherit">super-new</a></span> <span class="p">[</span><span class="n">parent</span> <span class="n">the-frame</span><span class="p">]</span> <span class="p">[</span><span class="n">paint-callback</span> <span class="n">on-canvas-paint</span><span class="p">])</span>
         <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">on-size</span> <span class="n">_width</span> <span class="n">_height</span><span class="p">)</span>
           <span class="c1">;; _width and _height are for the entire widget area</span>
           <span class="c1">;; determine drawing area instead.</span>
           <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((quote._~23~25kernel)._define-values))" style="color: inherit">define-values</a></span> <span class="p">(</span><span class="n">w</span> <span class="n">h</span><span class="p">)</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span> <span class="n">get-client-size</span><span class="p">))</span>
           <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span> <span class="p">([</span><span class="n">o</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span> <span class="n">scene</span><span class="p">)])</span>
             <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">o</span> <span class="n">canvas-size-changed</span> <span class="n">w</span> <span class="n">h</span><span class="p">))))))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The <code>on-canvas-paint</code> callback simply forwards the paint request to every actor in the scene:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">on-canvas-paint</span> <span class="n">canvas</span> <span class="n">dc</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span> <span class="p">([</span><span class="n">o</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span> <span class="n">scene</span><span class="p">)])</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">o</span> <span class="n">paint</span> <span class="n">canvas</span> <span class="n">dc</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h3 id="the-game-loop">The Game Loop</h3>

<p>We have the mechanisms to draw actors onto the canvas and receive keyboard events from the system, what is left is to update the actors as time passes. Technically, each actor could start its own thread to update itself, but in a game, we want movements to be synchronized perfectly: all actors should see the exact same timestamps. This means that the game time needs to be explicitly measured in one place and this time communicated to all actors. The game loop is where all this happens.</p>

<p>The game loop starts with a small initialization sequence: sets the game outcome to <code>'undecided</code> and shows the game window, giving it the keyboard focus. Next it determines the current time, by calling <code>current-inexact-milliseconds</code>. The game time will be measured from this moment in time.</p>

<p>Games also have a &ldquo;frame rate&rdquo;, which is the number of updates done in a second. Typically, this value is the same as the monitor refresh rate ensuring that the game will be updated once for each display refresh. How to set the frame rate and sync the game loop with monitor refreshes is a complex topic, here we&rsquo;ll just set the frame rate to 60 as this is a good approximation of what most monitors use. If your computer is slow, you may also want to set the frame rate to a lower value, for example 30.</p>

<p>Frame rate cannot be used directly in the game loop, instead we need to calculate the <code>frame-time</code>, which is the amount of time each &ldquo;update slice&rdquo; should take. This value is simply the inverse of the frame rate. We multiply it by 1000.0 to convert the value to milliseconds.</p>

<p>The game loop itself performs the following steps:</p>

<ul>
 <li>It determines the <code>game-time</code> which is the difference between the current  time and the start time.</li>
 <li>For each actor in the scene, it calls their <code>update</code> method with the current  game time. The actors are responsible for updating their internal state.</li>
 <li>It sends a <code>refresh</code> request to the canvas. In response to this request,  the canvas will, at some later time and in a separate thread, call the paint  callback invoking each actors <code>paint</code> method.</li>
 <li>it determines the time it took to perform all the previous steps, this is  the <code>update-duration</code></li>
 <li>If the update duration is less than the frame time, it sleeps for the  residual time.</li>
 <li>the game loop exists when it detects that the <code>game-outcome</code> is <code>'abandoned</code>  &mdash; this value is set when the user closes the window.</li></ul>

<p>By sleeping the residual time, the game loop ensures that it does not update objects faster than necessary, since updates can only be seen when the monitor is refreshed. Also, by measuring the actual time and passing it to the actors, the game movements will be less affected by variations in execution time: each loop, the objects will update based on the duration of that loop, not by a fixed amount:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">run-game-loop</span> <span class="kd">#:frame-rate</span> <span class="p">[</span><span class="n">frame-rate</span> <span class="mi">60</span><span class="p">])</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">game-outcome</span> <span class="o">'</span><span class="ss">undecided</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">the-frame</span> <span class="n">show</span> <span class="no">#t</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">the-frame</span> <span class="n">focus</span><span class="p">)</span>

  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">start-timestamp</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/time.html#(def._((quote._~23~25kernel)._current-inexact-milliseconds))" style="color: inherit">current-inexact-milliseconds</a></span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">frame-time</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="mf">1.0</span> <span class="n">frame-rate</span><span class="p">)</span> <span class="mf">1000.0</span><span class="p">))</span>

  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="n">loop</span> <span class="p">()</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">now</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/time.html#(def._((quote._~23~25kernel)._current-inexact-milliseconds))" style="color: inherit">current-inexact-milliseconds</a></span><span class="p">))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">game-time</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">now</span> <span class="n">start-timestamp</span><span class="p">))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span> <span class="p">([</span><span class="n">o</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span> <span class="n">scene</span><span class="p">)])</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">o</span> <span class="n">update</span> <span class="n">game-time</span><span class="p">))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">the-canvas</span> <span class="n">refresh</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">update-duration</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/time.html#(def._((quote._~23~25kernel)._current-inexact-milliseconds))" style="color: inherit">current-inexact-milliseconds</a></span><span class="p">)</span> <span class="n">now</span><span class="p">))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">remaining-time</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">frame-time</span> <span class="n">update-duration</span><span class="p">))</span>
    <span class="p">(</span><span class="n">sleep/yield</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span> <span class="mi">0</span> <span class="n">remaining-time</span><span class="p">)</span> <span class="mf">1000.0</span><span class="p">))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._unless))" style="color: inherit">unless</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Equality.html#(def._((quote._~23~25kernel)._equal~3f))" style="color: inherit">equal?</a></span> <span class="n">game-outcome</span> <span class="o">'</span><span class="ss">abandoned</span><span class="p">)</span>
      <span class="p">(</span><span class="n">loop</span><span class="p">))))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>That is all that is required for managing actors in the game. The code above will distribute time updates and key presses to actors and arrange for their drawing on the canvas, but other that that, has no concept of a &ldquo;Space Invader&rdquo; game and could be reused for other games as well.</p>

<h3 id="the-actors">The Actors</h3>

<p>Running the game loop itself will produce an empty canvas, because we have no actors yet, so we&rsquo;ll work on that task next. Before we do that, we need to clarify what exactly is an actor.</p>

<p>The arena will manage actors which are the entities that make up a particular game. The arena expects each actor to be an object, since it uses the <code>send</code> function to send messages to it, and to implement the <code>keyboard-event</code>, <code>canvas-size-changed</code>, <code>paint</code> and <code>update</code> messages or methods. We can codify this information with an interface, and we can also add contracts to each method, thus ensuring not only that an actor implements a method, but it also accepts the correct number and types of arguments. Racket uses the prefix <code>&lt;%&gt;</code> for interfaces, but there is nothing special about the name <code>actor&lt;%&gt;</code>, we could have easily called it <code>actor-interface</code>.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" style="color: inherit">require</a></span> <span class="n">racket/contract</span><span class="p">)</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">actor&lt;%&gt;</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createinterface.html#(form._((lib._racket/private/class-internal..rkt)._interface))" style="color: inherit">interface</a></span> <span class="p">()</span>
    <span class="p">[</span><span class="n">keyboard-event</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/Object_and_Class_Contracts.html#(form._((lib._racket/class..rkt)._-~3em))" style="color: inherit">-&gt;m</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Object_and_Class_Contracts.html#(def._((lib._racket/class..rkt)._is-a~3f/c))" style="color: inherit">is-a?/c</a></span> <span class="n">key-event%</span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/private/misc..rkt)._any/c))" style="color: inherit">any/c</a></span><span class="p">)]</span>
    <span class="p">[</span><span class="n">canvas-size-changed</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/Object_and_Class_Contracts.html#(form._((lib._racket/class..rkt)._-~3em))" style="color: inherit">-&gt;m</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._number~3f))" style="color: inherit">number?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._number~3f))" style="color: inherit">number?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/private/misc..rkt)._any/c))" style="color: inherit">any/c</a></span><span class="p">)]</span>
    <span class="p">[</span><span class="n">paint</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/Object_and_Class_Contracts.html#(form._((lib._racket/class..rkt)._-~3em))" style="color: inherit">-&gt;m</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Object_and_Class_Contracts.html#(def._((lib._racket/class..rkt)._is-a~3f/c))" style="color: inherit">is-a?/c</a></span> <span class="n">canvas%</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Object_and_Class_Contracts.html#(def._((lib._racket/class..rkt)._is-a~3f/c))" style="color: inherit">is-a?/c</a></span> <span class="n">dc&lt;%&gt;</span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/private/misc..rkt)._any/c))" style="color: inherit">any/c</a></span><span class="p">)]</span>
    <span class="p">[</span><span class="n">update</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/Object_and_Class_Contracts.html#(form._((lib._racket/class..rkt)._-~3em))" style="color: inherit">-&gt;m</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._positive~3f))" style="color: inherit">positive?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/private/misc..rkt)._any/c))" style="color: inherit">any/c</a></span><span class="p">)]))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Having just an interface will force all actors to implement these methods whether they need them or not. For the &ldquo;Space Invaders&rdquo; game, we know that only the cannon will need keyboard events, and rest of our actors will just have an empty <code>keyboard-event</code> method. It is simpler to provide an actor base class which provides default implementations of these methods, so actual actors implement only what they need.</p>

<p>What should we put in a common actor class? We could simply provide default implementations for all the methods in the actor interface, but we can do a bit more than that.</p>

<p>The <code>paint</code> method for most actors will display a bitmap at some coordinates, so we can provide a <code>bitmap</code>, <code>x</code> and <code>y</code> fields so derived classes can only set those, and the paint method will display the bitmap. For most actors this means that they won&rsquo;t need to implement a paint method at all.</p>

<p>The <code>update</code> method receives the &ldquo;game time&rdquo; as an argument, this is an increasing time with a reference to an unspecified start time (the start time is available in the game loop, but not accessible to actors). However, there are two types of updates that we need to perform:</p>

<ul>
 <li>
  <p>for actors which move, they need the time since the last call to update, to  calculate the movement amount since they were last updated.</p></li>
 <li>
  <p>for actors which are animated, they need the time from when they were  created</p></li></ul>

<p>We can write an update method which tracks both types of times, and call <code>update/delta-time</code> and <code>update/life-time</code> methods which derived objects can override to receive the either the delta time or the life time.</p>

<p>The <code>actor%</code> class below implements all this functionality:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">actor%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class*))" style="color: inherit">class*</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/createclass.html#(def._((lib._racket/private/class-internal..rkt)._object~25))" style="color: inherit">object%</a></span> <span class="p">(</span><span class="n">actor&lt;%&gt;</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._init-field))" style="color: inherit">init-field</a></span> <span class="p">[</span><span class="n">bitmap</span> <span class="no">#f</span><span class="p">]</span> <span class="p">[</span><span class="n">x</span> <span class="mi">0</span><span class="p">]</span> <span class="p">[</span><span class="n">y</span> <span class="mi">0</span><span class="p">])</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._field))" style="color: inherit">field</a></span> <span class="p">[</span><span class="n">creation-time</span> <span class="no">#f</span><span class="p">]</span> <span class="p">[</span><span class="n">last-time</span> <span class="no">#f</span><span class="p">])</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._super-new))" style="color: inherit">super-new</a></span><span class="p">)</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span> <span class="p">(</span><span class="n">paint</span> <span class="n">canvas</span> <span class="n">dc</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="n">bitmap</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">width</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">bitmap</span> <span class="n">get-width</span><span class="p">))</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">height</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">bitmap</span> <span class="n">get-height</span><span class="p">))</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">top-left-x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="n">width</span> <span class="mi">2</span><span class="p">)))</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">top-left-y</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">y</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="n">height</span> <span class="mi">2</span><span class="p">)))</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">dc</span> <span class="n">draw-bitmap</span> <span class="n">bitmap</span> <span class="n">top-left-x</span> <span class="n">top-left-y</span><span class="p">)))</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span> <span class="p">(</span><span class="n">update</span> <span class="n">game-time</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="n">creation-time</span>
          <span class="p">(</span><span class="n">update/life-time</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">game-time</span> <span class="n">creation-time</span><span class="p">))</span>
          <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">creation-time</span> <span class="n">game-time</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="n">last-time</span>
        <span class="p">(</span><span class="n">update/delta-time</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">game-time</span> <span class="n">last-time</span><span class="p">)))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">last-time</span> <span class="n">game-time</span><span class="p">))</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span> <span class="p">(</span><span class="n">keyboard-event</span> <span class="n">e</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" style="color: inherit">void</a></span><span class="p">))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span> <span class="p">(</span><span class="n">canvas-size-changed</span> <span class="n">w</span> <span class="n">h</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" style="color: inherit">void</a></span><span class="p">))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span> <span class="p">(</span><span class="n">update/life-time</span> <span class="n">lifetime</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" style="color: inherit">void</a></span><span class="p">))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span> <span class="p">(</span><span class="n">update/delta-time</span> <span class="n">dt</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" style="color: inherit">void</a></span><span class="p">))</span>
    <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h2 id="set-up-the-defenses">Set up the Defenses</h2>

<p>Preparing the arena involved writing a lot of code without seeing any results, so let&rsquo;s implement the first actor: the cannon. This is an object which moves at the bottom of the screen based on user input.</p>

<h3 id="the-cannon">The Cannon</h3>

<p>Just as with the aliens, we need to define the cannon picture itself, but, since there will be no animation for the canon, we only need to define one frame:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8
9</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">cannon-color</span> <span class="s2">"Dark Slate Gray"</span><span class="p">)</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">cannon-frame-a</span>
  <span class="o">'</span><span class="p">(</span><span class="s2">"      ZZ      "</span>
    <span class="s2">"  ZZZZZZZZZZ  "</span>
    <span class="s2">"  ZZZZZZZZZZ  "</span>
    <span class="s2">"ZZZZZZZZZZZZZZ"</span><span class="p">))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">cannon-pict</span> <span class="p">(</span><span class="n">block-&gt;pict</span> <span class="n">cannon-frame-a</span> <span class="kd">#:color</span> <span class="n">cannon-color</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The cannon will need to check keyboard events for the left and right keys and move the picture in response to these events, taking special care not to move it past the left and right limits of the actual window.</p>

<ul>
 <li>the cannon has a <code>speed</code> field, which can be specified at object creation  time (because it is an init-field). This determines how fast the canon  moves. The speed is in drawing units / millisecond.</li>
 <li>it initializes the <code>bitmap</code> field in the parent class to the cannon bitmap  by using <code>pict-&gt;bitmap</code> to convert a picture to a bitmap. Once set, this  bitmap will never change for the lifetime of the object</li>
 <li>the class has a few internal fields of its own: <code>direction</code> is the movement  direction, which can be left, right or none if the cannon does not move;  <code>left-limit</code> and <code>right-limit</code> are the extents of the left and right  movement.</li></ul>

<p>The class also implements the <code>keyboard-event</code>, <code>canvas-size-changed</code> and <code>update/delta-time</code> methods:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">cannon%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">actor%</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._init-field))" style="color: inherit">init-field</a></span> <span class="p">[</span><span class="n">speed</span> <span class="mf">0.1</span><span class="p">])</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._super-new))" style="color: inherit">super-new</a></span> <span class="p">[</span><span class="n">bitmap</span> <span class="p">(</span><span class="n">pict-&gt;bitmap</span> <span class="n">cannon-pict</span><span class="p">)])</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">direction</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">; -1 -- left, 0 -- none, 1 -- right</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((quote._~23~25kernel)._define-values))" style="color: inherit">define-values</a></span> <span class="p">(</span><span class="n">left-limit</span> <span class="n">right-limit</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._values))" style="color: inherit">values</a></span> <span class="mi">0</span> <span class="mi">100</span><span class="p">))</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">keyboard-event</span> <span class="n">event</span><span class="p">)</span>
      <span class="c1">;; ...</span>
      <span class="p">)</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">canvas-size-changed</span> <span class="n">new-width</span> <span class="n">new-height</span><span class="p">)</span>
      <span class="c1">;; ...</span>
      <span class="p">)</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">update/delta-time</span> <span class="n">dt</span><span class="p">)</span>
      <span class="c1">;; ...</span>
      <span class="p">)</span>
    <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Keyboard event handling for the cannon means that we look for the left and right key presses and set the movement direction accordingly. The GUI event system sends keyboard events for both key presses and releases, and we need to handle both. Why not just update the position of the canon instead of recording the movement direction? The problem is that keyboard press events are sent periodically and the repeat rate of the keyboard, which is different than the update rate of the game &mdash; incrementing the position on key press events would make the cannon jump from position to position.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">cannon%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">actor%</span>
    <span class="c1">;; Other cannon% members are also available</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">keyboard-event</span> <span class="n">event</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/case.html#(form._((lib._racket/private/more-scheme..rkt)._case))" style="color: inherit">case</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">event</span> <span class="n">get-key-code</span><span class="p">)</span>
        <span class="p">((</span><span class="n">release</span><span class="p">)</span>
         <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/base..rkt)._member))" style="color: inherit">member</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">event</span> <span class="n">get-key-release-code</span><span class="p">)</span> <span class="o">'</span><span class="p">(</span><span class="ss">left</span> <span class="ss">right</span><span class="p">))</span>
           <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">direction</span> <span class="mi">0</span><span class="p">)))</span>
        <span class="p">((</span><span class="n">left</span><span class="p">)</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">direction</span> <span class="mi">-1</span><span class="p">))</span>
        <span class="p">((</span><span class="n">right</span><span class="p">)</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">direction</span> <span class="mi">1</span><span class="p">))))</span>
    <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The cannon is also interested in canvas size changes, since it needs to update the left and right limits of movement as the window size changes. The <code>canvas-size-changed</code> method receives the new canvas size, and the method also needs access to the bitmap itself, thus the <code>inherit</code> field declaration. It will also update the <code>y</code> field so the cannon is always placed at the bottom and the <code>x</code> field to make sure that it is still inside the window.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">cannon%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">actor%</span>
    <span class="c1">;; Other cannon% members are also available</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._inherit-field))" style="color: inherit">inherit-field</a></span> <span class="n">bitmap</span> <span class="n">x</span> <span class="n">y</span><span class="p">)</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">canvas-size-changed</span> <span class="n">new-width</span> <span class="n">new-height</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">width</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">bitmap</span> <span class="n">get-width</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">height</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">bitmap</span> <span class="n">get-height</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">left-limit</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="n">width</span> <span class="mi">2</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">right-limit</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">new-width</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="n">width</span> <span class="mi">2</span><span class="p">)))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">y</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">new-height</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="n">height</span> <span class="mi">2</span><span class="p">)))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span> <span class="n">left-limit</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._min))" style="color: inherit">min</a></span> <span class="n">right-limit</span> <span class="n">x</span><span class="p">))))</span>
    <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Finally, the cannon will need to update its position, and to do that we&rsquo;ll use the <code>update/delta-time</code> method since it only needs to adjust the position based on the time passed since the last call to update. The method computes the distance moved as the speed multiplied by time and adjust the X position of the parent <code>actor%</code> accordingly, making sure that the position is still inside the playing field:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">cannon%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">actor%</span>
    <span class="c1">;; Other cannon% members are also available</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._inherit-field))" style="color: inherit">inherit-field</a></span> <span class="n">x</span><span class="p">)</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">update/delta-time</span> <span class="n">dt</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">distance</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="n">direction</span> <span class="n">speed</span> <span class="n">dt</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span> <span class="n">left-limit</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._min))" style="color: inherit">min</a></span> <span class="n">right-limit</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">x</span> <span class="n">distance</span><span class="p">)))))</span>
    <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>To see it in action, we need to create a cannon, add it as an actor to the arena and run the game loop:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="n">add-actor</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">cannon%</span><span class="p">))</span>
<span class="p">(</span><span class="n">run-game-loop</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<div class="figure"><img src="/img/a044/cannon-move.gif" alt="" />
 <p class="caption"></p></div>

<h3 id="firing-laser-shots">Firing Laser Shots</h3>

<p>The cannon can fire laser shots upwards and these can also be modeled as actors. First, here is the picture for a laser shot, a simple vertical beam:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">laser-shot-frame</span>
  <span class="o">'</span><span class="p">(</span><span class="s2">"Z"</span>
    <span class="s2">"Z"</span>
    <span class="s2">"Z"</span>
    <span class="s2">"Z"</span><span class="p">))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">laser-shot-pict</span> <span class="p">(</span><span class="n">block-&gt;pict</span> <span class="n">laser-shot-frame</span> <span class="kd">#:color</span> <span class="n">cannon-color</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The laser shot moves at a constant speed upwards, but it ignores key presses or window size changes. It is initialized with the correct bitmap and only has a <code>update/delta-time</code> method which updates its <code>y</code> (vertical position) bases on the time that passed. When the vertical position is less than 0, which means the object is now outside the window, the laser shot simply removes itself from the scene using <code>remove-actor</code>:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">laser-shot%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">actor%</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._init-field))" style="color: inherit">init-field</a></span> <span class="p">[</span><span class="n">speed</span> <span class="mf">0.5</span><span class="p">])</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._super-new))" style="color: inherit">super-new</a></span> <span class="p">[</span><span class="n">bitmap</span> <span class="p">(</span><span class="n">pict-&gt;bitmap</span> <span class="n">laser-shot-pict</span><span class="p">)])</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._inherit-field))" style="color: inherit">inherit-field</a></span> <span class="n">y</span><span class="p">)</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">update/delta-time</span> <span class="n">dt</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">distance</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="n">speed</span> <span class="n">dt</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">y</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">y</span> <span class="n">distance</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span> <span class="n">y</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1">;; The laser shot has left the arena</span>
        <span class="p">(</span><span class="n">remove-actor</span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span><span class="p">)))</span>
  <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Laser shots are created by the cannon object when the user presses the keyboard. It is tempting to create these actors in the <code>keyboard-event</code> method, but it looks nicer if they are actually created in the update method, since than the initial position of the laser shot will be in sync with the position of the cannon. Here are the updated <code>keyboard-event</code> and <code>update/delta-time</code> methods: when the space key is pressed, the <code>shoot?</code> variable is set to true and the update method will create a new <code>laser-shot%</code> object and add it as an actor to the arena. Other than creating these objects, the cannon does not manage them in any way: the laser shots know how to move upwards and when to &ldquo;expire&rdquo;:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">cannon%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">actor%</span>
    <span class="c1">;; Rest of the cannon class definition is unchanged...</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">shoot?</span> <span class="no">#f</span><span class="p">)</span>

    <span class="c1">;; Updated to handle the "space" key</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">keyboard-event</span> <span class="n">event</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/case.html#(form._((lib._racket/private/more-scheme..rkt)._case))" style="color: inherit">case</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">event</span> <span class="n">get-key-code</span><span class="p">)</span>
        <span class="p">((</span><span class="n">release</span><span class="p">)</span>
         <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/base..rkt)._member))" style="color: inherit">member</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">event</span> <span class="n">get-key-release-code</span><span class="p">)</span> <span class="o">'</span><span class="p">(</span><span class="ss">left</span> <span class="ss">right</span><span class="p">))</span>
           <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">direction</span> <span class="mi">0</span><span class="p">)))</span>
        <span class="p">((</span><span class="n">left</span><span class="p">)</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">direction</span> <span class="mi">-1</span><span class="p">))</span>
        <span class="p">((</span><span class="n">right</span><span class="p">)</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">direction</span> <span class="mi">1</span><span class="p">))</span>
        <span class="p">((</span><span class="sc">#\space</span><span class="p">)</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">shoot?</span> <span class="no">#t</span><span class="p">))))</span>

    <span class="c1">;; Updated to create laser-shot% objects</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">update/delta-time</span> <span class="n">dt</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">distance</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="n">direction</span> <span class="n">speed</span> <span class="n">dt</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span> <span class="n">left-limit</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._min))" style="color: inherit">min</a></span> <span class="n">right-limit</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">x</span> <span class="n">distance</span><span class="p">))))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="n">shoot?</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">shoot?</span> <span class="no">#f</span><span class="p">)</span>              <span class="c1">; reset it</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">height</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">bitmap</span> <span class="n">get-height</span><span class="p">))</span>
        <span class="p">(</span><span class="n">add-actor</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">laser-shot%</span> <span class="p">[</span><span class="n">x</span> <span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">y</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">y</span> <span class="n">height</span><span class="p">)]))))</span>
    <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>And this is all that is required for the cannon to have shooting capabilities:</p>

<div class="figure"><img src="/img/a044/cannon-shot.gif" alt="" />
 <p class="caption"></p></div>

<h2 id="assemble-the-fleet">Assemble the Fleet</h2>

<p>With the defenses prepared, we need to have something to shoot at. The invaders fleet is composed of five rows containing 11 space ships each. We already have the pictures for the animations of the alien ships, we now need to create the actors which represent these in the scene.</p>

<p>There is an interesting design decision before us about what we will represent as an actor in our game: the individual space ship or the fleet? Each individual space ship has its own animation and will need to check for collisions with the laser and explode, however all space ships move as part of a fleet &mdash; for example all space ships will need to change direction when the left-most or right-most ships reached the edge of the screen, regardless of where the other ships are.</p>

<div class="figure"><img src="/img/a044/the-fleet.png" alt="" />
 <p class="caption"></p></div>

<p>We can actually implement both the space ships and the fleet as actors: the fleet will be an &ldquo;invisible&rdquo; actor, meaning it will not paint anything, but will maintain the direction and speed of all space ships, while each individual space ship will display the animation and be part of a fleet. Of course, the two actors will need to know about each other.</p>

<h3 id="the-fleet">The Fleet</h3>

<p>The <code>fleet%</code> will manage all the space ships in the game, so it will need to keep a list of all of them. There are additional <code>add-ship</code> and <code>remove-ship</code> methods to manage this list. The <code>add-ship</code> method will be used at the start of the game when the fleet is assembled, while <code>remove-ship</code> will be used whenever a space ship is hit and destroyed. <code>remove-ship</code> is also responsible for setting the game outcome to <code>'win</code> when there are no more ships left.</p>

<p>The ships themselves will need to know which fleet they are part of, since their position is relative to the fleet position. When adding a new ship, the ship is informed of the fleet they are part of by calling <code>set-the-fleet</code> method.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">fleet%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">actor%</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._super-new))" style="color: inherit">super-new</a></span><span class="p">)</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">ships</span> <span class="o">'</span><span class="p">())</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span> <span class="p">(</span><span class="n">add-ship</span> <span class="n">ship</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">ship</span> <span class="n">set-the-fleet</span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">ships</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" style="color: inherit">cons</a></span> <span class="n">ship</span> <span class="n">ships</span><span class="p">)))</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span> <span class="p">(</span><span class="n">remove-ship</span> <span class="n">ship</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">ships</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/list..rkt)._remove))" style="color: inherit">remove</a></span> <span class="n">ship</span> <span class="n">ships</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">ship</span> <span class="n">set-the-fleet</span> <span class="no">#f</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._null~3f))" style="color: inherit">null?</a></span> <span class="n">ships</span><span class="p">)</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">game-outcome</span> <span class="o">'</span><span class="ss">win</span><span class="p">)))</span>

    <span class="c1">;; Other fleet methods and member variables here...</span>
    <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The fleet is responsible for the movement of the ships: all ships move to the left until the left-most ship reaches the left edge of the screen, than they move down a certain height, than start moving right until the right most ship reaches the right edge and so on. To do all this work, the <code>fleet%</code> needs to keep track of a lot of state, which is shown below:</p>

<ul>
 <li>
  <p><code>movement-speed</code> represents the speed at which the fleet moves, the value is  in drawing units (pixels) per millisecond. It is an initialization  variable, meaning that it can be set at construction time, although we also  provide a default value.</p></li>
 <li>
  <p><code>x</code> and <code>y</code> represent the coordinates of the entire fleet, more precisely  the top left corner of the entire fleet. Since each individual ship needs  this information (and it changes every game loop), the <code>get-coordinates</code>  method provides access to these coordinates.</p></li>
 <li>
  <p><code>movement-direction</code> is the direction in which the fleet is moving, being  either <code>'left</code>, <code>'right</code> or <code>'down</code> &mdash; left and right are obvious, but we  also use a down movement, so the animation is smooth when the fleet drops a  row.</p></li>
 <li>
  <p><code>right-movement-limit</code>, <code>left-movement-limit</code> and <code>down-movement-limit</code>  represent the limits of the arena: left and right edges where the fleet must  turn and the lower level of the playing field &mdash; when the fleet reaches this  height it has completed the invasion. These values depend on the size of  the game window, so they are set by <code>canvas-size-changed</code>, and also  dynamically updated, if the user resizes the window during the game.</p></li>
 <li>
  <p><code>drop-height</code> represents the amount the fleet drops when it turns at the  edges of the screen. It should be the height of a ship, but we provide the  <code>set-drop-height</code> method to be able to set this value externally.</p></li>
 <li>
  <p>Finally, <code>drop-limit</code> represents the movement limit when the fleet moves  down &mdash; this is dynamically updated each time the fleet moves down a row.</p></li></ul>

<p>Most of these variables are initialized to some arbitrary values, but they will be updated to correct values once the fleet is added to the scene and the game begins.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">fleet%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">actor%</span>
    <span class="c1">;; Ship management methods unchanged...</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._init-field))" style="color: inherit">init-field</a></span> <span class="p">[</span><span class="n">movement-speed</span> <span class="mf">0.1</span><span class="p">])</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">x</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">y</span> <span class="mi">0</span><span class="p">)</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span> <span class="p">(</span><span class="n">get-coordinates</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._values))" style="color: inherit">values</a></span> <span class="n">x</span> <span class="n">y</span><span class="p">))</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">movement-direction</span> <span class="o">'</span><span class="ss">left</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">left-movement-limit</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">right-movement-limit</span> <span class="mi">100</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">down-movement-limit</span> <span class="mi">100</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">drop-height</span> <span class="mi">100</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">drop-limit</span> <span class="mi">100</span><span class="p">)</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span> <span class="p">(</span><span class="n">set-drop-height</span> <span class="n">h</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">drop-height</span> <span class="n">h</span><span class="p">))</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">canvas-size-changed</span> <span class="n">new-width</span> <span class="n">new-height</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">left-movement-limit</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">right-movement-limit</span> <span class="n">new-width</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">down-movement-limit</span> <span class="n">new-height</span><span class="p">))</span>

    <span class="c1">;; Other fleet methods and member variables here...</span>
    <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The main job of the <code>fleet%</code> is to update its position and, since we want to move the fleet incrementally, we&rsquo;ll override the <code>update/delta-time</code> method to change position based on the movement direction and the movement speed. This method is also responsible for changing direction when the fleet reaches an edge of the window, but, since this is more complex, we&rsquo;ll move it into a separate method, <code>maybe-change-direction</code>.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">fleet%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">actor%</span>
    <span class="c1">;; Other fleed methods and variables unchanged</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">update/delta-time</span> <span class="n">dt</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">distance</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="n">movement-speed</span> <span class="n">dt</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/case.html#(form._((lib._racket/private/more-scheme..rkt)._case))" style="color: inherit">case</a></span> <span class="n">movement-direction</span>
        <span class="p">((</span><span class="n">left</span><span class="p">)</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">x</span> <span class="n">distance</span><span class="p">)))</span>
        <span class="p">((</span><span class="n">right</span><span class="p">)</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">x</span> <span class="n">distance</span><span class="p">)))</span>
        <span class="p">((</span><span class="n">down</span><span class="p">)</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">y</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">y</span> <span class="n">distance</span><span class="p">))))</span>

      <span class="p">(</span><span class="n">maybe-change-direction</span><span class="p">))</span>

    <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The <code>fleet%</code> will also change direction when the space ships reach the edges of the screen. This is somewhat complicated by the fact that the screen area occupied by the fleet changes as ships are destroyed. To know when to change direction, we&rsquo;ll need a helper method, <code>get-bounding-box</code> which calculates the left, right, top and bottom limits of the entire fleet &mdash; technically, the top limit is unused, but it is still part of the bounding box of the fleet. <code>get-bounding-box</code> works by asking each individual ship for its bounding box and joining them together.</p>

<p>The job of the <code>maybe-change-direction</code> function is to obtain the bounding box for the entire fleet and check if any of its edges is past the relevant movement limit. It has a separate case for each movement direction, for example, if the current movement direction is <code>'left</code> and the left side of the bounding box is less than the <code>left-movement-limit</code>, it changes direction to <code>'down</code> and updates the <code>drop-limit</code>. The case where the movement direction is <code>'down</code> it also checks if the bottom of the fleet reached the <code>down-movement-limit</code>, in which case the game outcome is set to <code>'lose</code>, as the invasion was successful.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">fleet%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">actor%</span>
    <span class="c1">;; Other fleet methods and variables unchanged</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/private))" style="color: inherit">define/private</a></span> <span class="p">(</span><span class="n">get-bounding-box</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/fold))" style="color: inherit">for/fold</a></span> <span class="p">([</span><span class="n">left</span> <span class="no">#f</span><span class="p">]</span> <span class="p">[</span><span class="n">right</span> <span class="no">#f</span><span class="p">]</span> <span class="p">[</span><span class="n">top</span> <span class="no">#f</span><span class="p">]</span> <span class="p">[</span><span class="n">bottom</span> <span class="no">#f</span><span class="p">])</span>
                <span class="p">([</span><span class="n">ship</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span> <span class="n">ships</span><span class="p">)])</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((quote._~23~25kernel)._define-values))" style="color: inherit">define-values</a></span> <span class="p">(</span><span class="n">l</span> <span class="n">r</span> <span class="n">t</span> <span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">ship</span> <span class="n">get-bounding-box</span><span class="p">))</span>
        <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._values))" style="color: inherit">values</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="n">left</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._min))" style="color: inherit">min</a></span> <span class="n">left</span> <span class="n">l</span><span class="p">)</span> <span class="n">l</span><span class="p">)</span>
                <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="n">right</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span> <span class="n">right</span> <span class="n">r</span><span class="p">)</span> <span class="n">r</span><span class="p">)</span>
                <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="n">top</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._min))" style="color: inherit">min</a></span> <span class="n">top</span> <span class="n">t</span><span class="p">)</span> <span class="n">t</span><span class="p">)</span>
                <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="n">bottom</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span> <span class="n">bottom</span> <span class="n">b</span><span class="p">)</span> <span class="n">b</span><span class="p">))))</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/private))" style="color: inherit">define/private</a></span> <span class="p">(</span><span class="n">maybe-change-direction</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((quote._~23~25kernel)._define-values))" style="color: inherit">define-values</a></span> <span class="p">(</span><span class="n">left</span> <span class="n">right</span> <span class="n">top</span> <span class="n">bottom</span><span class="p">)</span> <span class="p">(</span><span class="n">get-bounding-box</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/case.html#(form._((lib._racket/private/more-scheme..rkt)._case))" style="color: inherit">case</a></span> <span class="n">movement-direction</span>
        <span class="p">((</span><span class="n">left</span><span class="p">)</span>
         <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="n">left</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span> <span class="n">left</span> <span class="n">left-movement-limit</span><span class="p">))</span>
           <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">movement-direction</span> <span class="o">'</span><span class="ss">down</span><span class="p">)</span>
           <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">drop-limit</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">top</span> <span class="n">drop-height</span><span class="p">))))</span>
        <span class="p">((</span><span class="n">right</span><span class="p">)</span>
         <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="n">right</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="n">right</span> <span class="n">right-movement-limit</span><span class="p">))</span>
           <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">movement-direction</span> <span class="o">'</span><span class="ss">down</span><span class="p">)</span>
           <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">drop-limit</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">top</span> <span class="n">drop-height</span><span class="p">))))</span>
        <span class="p">((</span><span class="n">down</span><span class="p">)</span>
         <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="n">bottom</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="n">bottom</span> <span class="n">down-movement-limit</span><span class="p">))</span>
             <span class="c1">;; Invasion successful</span>
             <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" style="color: inherit">begin</a></span>
               <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">movement-speed</span> <span class="mi">0</span><span class="p">)</span>
               <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">game-outcome</span> <span class="o">'</span><span class="ss">lose</span><span class="p">))</span>
             <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="n">top</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="n">top</span> <span class="n">drop-limit</span><span class="p">))</span>
               <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">movement-direction</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="n">left</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span> <span class="n">left</span> <span class="mi">0</span><span class="p">))</span> <span class="o">'</span><span class="ss">right</span> <span class="o">'</span><span class="ss">left</span><span class="p">)))))))</span>
    <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Since the fleet expects all objects it manages to have a <code>set-the-fleet</code> and <code>get-bounding-box</code> method, we can define an interface to codify this information. This can be used by other actors, and the Racket contract system to verify that the actor objects we define can be used with the <code>fleet%</code> class:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">fleet-member&lt;%&gt;</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createinterface.html#(form._((lib._racket/private/class-internal..rkt)._interface))" style="color: inherit">interface</a></span> <span class="p">()</span>
    <span class="p">[</span><span class="n">set-the-fleet</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/Object_and_Class_Contracts.html#(form._((lib._racket/class..rkt)._-~3em))" style="color: inherit">-&gt;m</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/base..rkt)._or/c))" style="color: inherit">or/c</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Object_and_Class_Contracts.html#(def._((lib._racket/class..rkt)._is-a~3f/c))" style="color: inherit">is-a?/c</a></span> <span class="n">fleet%</span><span class="p">)</span> <span class="no">#f</span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/private/misc..rkt)._any/c))" style="color: inherit">any/c</a></span><span class="p">)]</span>
    <span class="p">[</span><span class="n">get-bounding-box</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/Object_and_Class_Contracts.html#(form._((lib._racket/class..rkt)._-~3em))" style="color: inherit">-&gt;m</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._values))" style="color: inherit">values</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._real~3f))" style="color: inherit">real?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._real~3f))" style="color: inherit">real?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._real~3f))" style="color: inherit">real?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._real~3f))" style="color: inherit">real?</a></span><span class="p">))]))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h3 id="the-space-ships">The Space Ships</h3>

<p>Having the fleet ready, we need to populate it with some space ships. The game has five rows of 11 alien ships each, and, while the actual images used for the aliens are different for each row, their behavior is the same: the ships have a position within a fleet, so we need to draw them to that position, and they also have a sequence of picture frames representing the animations.</p>

<p>The animation for each alien ship can be captured in a structure, which holds the sequence of frames in that animation and the refresh interval. For convenience, we will also store the width and height plus the base color of each alien ship (the base color will come in handy a bit later):</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define-struct.html#(form._((lib._racket/private/base..rkt)._struct))" style="color: inherit">struct</a></span> <span class="n">sprite</span> <span class="p">(</span><span class="n">bitmaps</span>
                <span class="n">frame-time</span>
                <span class="n">width</span>
                <span class="n">height</span>
                <span class="n">color</span><span class="p">)</span> <span class="kd">#:transparent</span><span class="p">)</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">sprite-frame-count</span> <span class="n">s</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._length))" style="color: inherit">length</a></span> <span class="p">(</span><span class="n">sprite-bitmaps</span> <span class="n">s</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Defining a structure will also define several functions to access the structure members defined, such as <code>sprite-bitmaps</code>, <code>sprite-frame-time</code>, and so on. Sometimes it is useful to define additional helper functions with the same naming convention, such as <code>sprite-frame-count</code> which returns the number of frames in the animation.</p>

<p>We can also define a helper function to construct these sprites, making sure the structure is consistent: all pictures are converted to bitmaps and the width and height is correctly calculated.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">make-sprite</span> <span class="n">picts</span> <span class="n">color</span> <span class="kd">#:refresh-interal</span> <span class="p">(</span><span class="n">frame-time</span> <span class="mi">500</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">width</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" style="color: inherit">apply</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._map))" style="color: inherit">map</a></span> <span class="n">pict-width</span> <span class="n">picts</span><span class="p">)))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">height</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" style="color: inherit">apply</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._map))" style="color: inherit">map</a></span> <span class="n">pict-height</span> <span class="n">picts</span><span class="p">)))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">bitmaps</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" style="color: inherit">for/list</a></span> <span class="p">([</span><span class="n">p</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span> <span class="n">picts</span><span class="p">)])</span>
      <span class="p">(</span><span class="n">pict-&gt;bitmap</span> <span class="n">p</span> <span class="o">'</span><span class="ss">smoothed</span> <span class="kd">#:make-bitmap</span> <span class="n">make-screen-bitmap</span><span class="p">)))</span>
  <span class="p">(</span><span class="n">sprite</span> <span class="n">bitmaps</span> <span class="n">frame-time</span> <span class="n">width</span> <span class="n">height</span> <span class="n">color</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>We can now define the animations for our alien ships. Here is the one for the first alien ship, the rest of them are available in the <a href="https://gist.github.com/alex-hhh/da11a5e937960e69dc473be131be732d">game source</a>.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">zabrak-animation</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span> <span class="n">zabrak-pict-a</span> <span class="n">zabrak-pict-b</span> <span class="n">zabrak-pict-c</span> <span class="n">zabrak-pict-b</span><span class="p">))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">zabrak</span> <span class="p">(</span><span class="n">make-sprite</span> <span class="n">zabrak-animation</span> <span class="n">zabrak-color</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>A <code>space-ship%</code> is an <code>actor%</code> which can be part of a <code>fleet%</code>, so it also implements the <code>fleet-member&lt;%&gt;</code> interface. Below is the first part of the definition: when constructing a <code>space-ship%</code>, the sprite and the position within the fleet needs to be provided (<code>pos-x</code> and <code>pos-y</code>). The object also keeps a reference to the fleet it is part of, since it will need to compute its position on the screen from the fleet position and its own coordinates.</p>

<p>The <code>set-the-fleet</code> method implementation is trivial: it just keeps the reference to the fleet, while <code>get-bounding-box</code> will calculate the space occupied by this space ship from the fleet position, its own position within the fleet and the dimensions of the sprite:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">space-ship%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class*))" style="color: inherit">class*</a></span> <span class="n">actor%</span> <span class="p">(</span><span class="n">fleet-member&lt;%&gt;</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._init-field))" style="color: inherit">init-field</a></span> <span class="n">sprite</span> <span class="n">pos-x</span> <span class="n">pos-y</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._field))" style="color: inherit">field</a></span> <span class="p">[</span><span class="n">the-fleet</span> <span class="no">#f</span><span class="p">])</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._super-new))" style="color: inherit">super-new</a></span><span class="p">)</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span> <span class="p">(</span><span class="n">set-the-fleet</span> <span class="n">f</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">the-fleet</span> <span class="n">f</span><span class="p">))</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span> <span class="p">(</span><span class="n">get-bounding-box</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">top-left-x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">pos-x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="p">(</span><span class="n">sprite-width</span> <span class="n">sprite</span><span class="p">)</span> <span class="mi">2</span><span class="p">)))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">top-left-y</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">pos-y</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="p">(</span><span class="n">sprite-height</span> <span class="n">sprite</span><span class="p">)</span> <span class="mi">2</span><span class="p">)))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((quote._~23~25kernel)._define-values))" style="color: inherit">define-values</a></span> <span class="p">(</span><span class="n">dx</span> <span class="n">dy</span><span class="p">)</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="n">the-fleet</span>
            <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">the-fleet</span> <span class="n">get-coordinates</span><span class="p">)</span>
            <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._values))" style="color: inherit">values</a></span> <span class="mi">0</span> <span class="mi">0</span><span class="p">)))</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._values))" style="color: inherit">values</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">dx</span> <span class="n">top-left-x</span><span class="p">)</span>
              <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">dx</span> <span class="n">top-left-x</span> <span class="p">(</span><span class="n">sprite-width</span> <span class="n">sprite</span><span class="p">))</span>
              <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">dy</span> <span class="n">top-left-y</span><span class="p">)</span>
              <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">dy</span> <span class="n">top-left-y</span> <span class="p">(</span><span class="n">sprite-height</span> <span class="n">sprite</span><span class="p">))))</span>

    <span class="c1">;; Other space-ship% methods defined...</span>
  <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The update function for the space ship will need to update the animation frames only: its position within the fleet never changes, and the fleet is responsible for calculating the position on the screen, and moving the space ships. The animation is done by calculating the frame to be displayed, <code>frame-index</code>, based on the amount of time passed since the object was created and the frame time defined for the sprite itself. Since we use the time since the actor was created, we override the <code>update/life-time</code> method:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">space-ship%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class*))" style="color: inherit">class*</a></span> <span class="n">actor%</span> <span class="p">(</span><span class="n">fleet-member&lt;%&gt;</span><span class="p">)</span>
    <span class="c1">;; Other space-ship% methods remain unchanged ...</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">frame-index</span> <span class="mi">0</span><span class="p">)</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">update/life-time</span> <span class="n">life-time</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">frame-time</span> <span class="p">(</span><span class="n">sprite-frame-time</span> <span class="n">sprite</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">frame-count</span> <span class="p">(</span><span class="n">sprite-frame-count</span> <span class="n">sprite</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">steps</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._exact-truncate))" style="color: inherit">exact-truncate</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="n">life-time</span> <span class="n">frame-time</span><span class="p">)))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">frame-index</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._modulo))" style="color: inherit">modulo</a></span> <span class="n">steps</span> <span class="n">frame-count</span><span class="p">)))</span>

   <span class="c1">;; More  space-ship% methods defined...</span>
  <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Drawing the space ship is done by updating the bitmap and the position in the base <code>actor%</code> class, since the actor does the actual drawing. We just override the <code>paint</code> method to calculate the screen position of the space ship from the fleet coordinates and the actual bitmap from the <code>frame-index</code> which was updated in the <code>update/life-time</code> method. Once all these are set up, we call the paint method in the parent class using <code>(super paint canvas dc)</code>.</p>

<p>Why not update the <code>bitmap</code>, <code>x</code> and <code>y</code> values from the update method? The problem is that we have no control over the order in which updates are called for the actors. When update is called for a space ship, the update for the fleet might not be called yet, so the fleet position is not correct yet. When <code>paint</code> is called, all updates are completed.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">space-ship%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class*))" style="color: inherit">class*</a></span> <span class="n">actor%</span> <span class="p">(</span><span class="n">fleet-member&lt;%&gt;</span><span class="p">)</span>
    <span class="c1">;; Other space-ship% methods remain unchanged ...</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._inherit-field))" style="color: inherit">inherit-field</a></span> <span class="n">bitmap</span> <span class="n">x</span> <span class="n">y</span><span class="p">)</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">paint</span> <span class="n">canvas</span> <span class="n">dc</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((quote._~23~25kernel)._define-values))" style="color: inherit">define-values</a></span> <span class="p">(</span><span class="n">dx</span> <span class="n">dy</span><span class="p">)</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="n">the-fleet</span>
            <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">the-fleet</span> <span class="n">get-coordinates</span><span class="p">)</span>
            <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._values))" style="color: inherit">values</a></span> <span class="mi">0</span> <span class="mi">0</span><span class="p">)))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">pos-x</span> <span class="n">dx</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">y</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">pos-y</span> <span class="n">dy</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">bitmap</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list-ref))" style="color: inherit">list-ref</a></span> <span class="p">(</span><span class="n">sprite-bitmaps</span> <span class="n">sprite</span><span class="p">)</span> <span class="n">frame-index</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._super))" style="color: inherit">super</a></span> <span class="n">paint</span> <span class="n">canvas</span> <span class="n">dc</span><span class="p">))</span>
<span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>To help creating a nicely aligned block of space ships for our fleet, we can write a helper function to calculate the position of each ship, create the space ships and add them both to the scene and to the fleet:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">create-space-ships</span>
         <span class="n">fleet</span>
         <span class="p">[</span><span class="n">invaders</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span> <span class="n">zabrak</span> <span class="n">zakdorn</span> <span class="n">zaldan</span> <span class="n">zalkon</span> <span class="n">zarbi</span><span class="p">)]</span>
         <span class="p">[</span><span class="n">columns</span> <span class="mi">11</span><span class="p">])</span>

  <span class="c1">;; Find the width and height of each alien ship, the final cell size will be</span>
  <span class="c1">;; the maximum one, so all align nicely.</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">width</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" style="color: inherit">apply</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._map))" style="color: inherit">map</a></span> <span class="n">sprite-width</span> <span class="n">invaders</span><span class="p">)))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">height</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" style="color: inherit">apply</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._map))" style="color: inherit">map</a></span> <span class="n">sprite-height</span> <span class="n">invaders</span><span class="p">)))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">spacing</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="m">1/5</span> <span class="n">width</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="m">1/5</span> <span class="n">height</span><span class="p">)))</span>

  <span class="c1">;; Note that the coordinates of of the space ship is in the center of the</span>
  <span class="c1">;; image!</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for*))" style="color: inherit">for*</a></span> <span class="p">([(</span><span class="n">sprite</span> <span class="n">row</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-indexed))" style="color: inherit">in-indexed</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span> <span class="n">invaders</span><span class="p">))]</span>
         <span class="p">[</span><span class="n">column</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-range))" style="color: inherit">in-range</a></span> <span class="n">columns</span><span class="p">)])</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">space-ship</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">space-ship%</span>
           <span class="p">[</span><span class="n">sprite</span> <span class="n">sprite</span><span class="p">]</span>
           <span class="p">[</span><span class="n">pos-x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="n">column</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">width</span> <span class="n">spacing</span><span class="p">))</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="m">1/2</span> <span class="n">width</span><span class="p">))]</span>
           <span class="p">[</span><span class="n">pos-y</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="n">row</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">height</span> <span class="n">spacing</span><span class="p">))</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="m">1/2</span> <span class="n">height</span><span class="p">))]))</span>
    <span class="p">(</span><span class="n">add-actor</span> <span class="n">space-ship</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">fleet</span> <span class="n">add-ship</span> <span class="n">space-ship</span><span class="p">))</span>

  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">fleet</span> <span class="n">set-drop-height</span> <span class="n">height</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>With the fleet and space ships ready, let&rsquo;s see them in action:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">fleet</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">fleet%</span><span class="p">))</span>
<span class="p">(</span><span class="n">add-actor</span> <span class="n">fleet</span><span class="p">)</span>
<span class="p">(</span><span class="n">create-space-ships</span> <span class="n">fleet</span><span class="p">)</span>
<span class="p">(</span><span class="n">run-game-loop</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<div class="figure"><img src="/img/a044/fleet-moving.gif" alt="" />
 <p class="caption"></p></div>

<h2 id="begin-the-invasion">Begin the Invasion</h2>

<p>We have a fleet and we have a cannon that can shoot lasers, but if you put both together, you will notice that the lasers don&rsquo;t hit anything.</p>

<p>The <code>update/delta-time</code> method in the <code>laser-shot%</code> class would remove the actor when the shot reaches the top of the screen. We keep that functionality, since this is the case where nothing was hit by this shot, but the laser shot will also need to check if it hit any space ships. It does that by iterating over all the space ships in the scene and checking if the tip of the object is inside the bounding box of the space ship &mdash; this is not an exact collision test, since the ships are not rectangles, but it is sufficient for this game.</p>

<p>If the laser shot hits a space ship, it sends the <code>destroy</code> message to the space ship than the laser shot removes itself from the scene, since it completed its purpose:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">laser-shot%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">actor%</span>
    <span class="c1">;; Rest of the laser shot class is the same...</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">update/delta-time</span> <span class="n">dt</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">distance</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="n">speed</span> <span class="n">dt</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">y</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">y</span> <span class="n">distance</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span> <span class="n">y</span> <span class="mi">0</span><span class="p">)</span>
          <span class="c1">;; The laser shot has left the arena</span>
          <span class="p">(</span><span class="n">remove-actor</span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span><span class="p">)</span>
          <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="p">((</span><span class="n">tip-x</span> <span class="n">x</span><span class="p">)</span>
                <span class="p">(</span><span class="n">tip-y</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">y</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">bitmap</span> <span class="n">get-height</span><span class="p">)</span> <span class="mi">2</span><span class="p">))))</span>
            <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/or))" style="color: inherit">for/or</a></span> <span class="p">([</span><span class="n">o</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" style="color: inherit">in-list</a></span> <span class="n">scene</span><span class="p">)]</span> <span class="kd">#:when</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objectutils.html#(def._((lib._racket/private/class-internal..rkt)._is-a~3f))" style="color: inherit">is-a?</a></span> <span class="n">o</span> <span class="n">space-ship%</span><span class="p">))</span>
              <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((quote._~23~25kernel)._define-values))" style="color: inherit">define-values</a></span> <span class="p">(</span><span class="n">left</span> <span class="n">right</span> <span class="n">top</span> <span class="n">bottom</span><span class="p">)</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">o</span> <span class="n">get-bounding-box</span><span class="p">))</span>
              <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">hit?</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="n">x</span> <span class="n">left</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span> <span class="n">x</span> <span class="n">right</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="n">y</span> <span class="n">top</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span> <span class="n">y</span> <span class="n">bottom</span><span class="p">)))</span>
              <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="n">hit?</span>
                <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">o</span> <span class="n">destroy</span><span class="p">)</span>
                <span class="p">(</span><span class="n">remove-actor</span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span><span class="p">))</span>
              <span class="n">hit?</span><span class="p">))))</span>
    <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The <code>destroy</code> method for the <code>space-ship%</code> could simply remove the space ship from the scene and the fleet, but we can improve the game by adding explosions. These will be animated pictures, or sprites, just like the individual aliens, but these sprites need to be the same color as the destroyed space ship. The animation frames are defined the same way as for the aliens themselves (see the <a href="https://gist.github.com/alex-hhh/da11a5e937960e69dc473be131be732d">game source</a> for the actual definitions), but we add a helper method to construct sprites of different color.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">make-explosion-sprite</span> <span class="n">color</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">picts</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" style="color: inherit">for/list</a></span> <span class="p">([</span><span class="n">z</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span> <span class="n">explosion-frame-a</span> <span class="n">explosion-frame-b</span>
                        <span class="n">explosion-frame-c</span> <span class="n">explosion-frame-d</span>
                        <span class="n">explosion-frame-e</span> <span class="n">explosion-frame-f</span><span class="p">)])</span>
      <span class="p">(</span><span class="n">block-&gt;pict</span> <span class="n">z</span> <span class="kd">#:color</span> <span class="n">color</span><span class="p">)))</span>
  <span class="p">(</span><span class="n">make-sprite</span> <span class="n">picts</span> <span class="n">color</span> <span class="kd">#:refresh-interal</span> <span class="mi">100</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>An <code>explosion%</code> object will replace a space ship in the fleet, so it needs to be a <code>fleet-member&lt;%&gt;</code>. The constructor accepts a color, plus a position in the fleet, the position of the space ship that was just hit. The paint method is similar to the space ship paint method, but the update method is slightly different: unlike a space ship, which will cycle through the animation frames, an explosion will remove itself from the scene and the fleet once all the animation frames are played out:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">explosion%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class*))" style="color: inherit">class*</a></span> <span class="n">actor%</span> <span class="p">(</span><span class="n">fleet-member&lt;%&gt;</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._init-field))" style="color: inherit">init-field</a></span> <span class="n">color</span> <span class="n">pos-x</span> <span class="n">pos-y</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._super-new))" style="color: inherit">super-new</a></span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._field))" style="color: inherit">field</a></span> <span class="p">[</span><span class="n">the-fleet</span> <span class="no">#f</span><span class="p">])</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span> <span class="p">(</span><span class="n">set-the-fleet</span> <span class="n">f</span><span class="p">)</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">the-fleet</span> <span class="n">f</span><span class="p">))</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">sprite</span> <span class="p">(</span><span class="n">make-explosion-sprite</span> <span class="n">color</span><span class="p">))</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span> <span class="p">(</span><span class="n">get-bounding-box</span><span class="p">)</span>
      <span class="c1">;; Same implementation as for space-ship%</span>
      <span class="p">)</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">frame-index</span> <span class="mi">0</span><span class="p">)</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">update/life-time</span> <span class="n">life-time</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">frame-time</span> <span class="p">(</span><span class="n">sprite-frame-time</span> <span class="n">sprite</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">frame-index</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._exact-truncate))" style="color: inherit">exact-truncate</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="n">life-time</span> <span class="n">frame-time</span><span class="p">)))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e~3d))" style="color: inherit">&gt;=</a></span> <span class="n">frame-index</span> <span class="p">(</span><span class="n">sprite-frame-count</span> <span class="n">sprite</span><span class="p">))</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">the-fleet</span> <span class="n">remove-ship</span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span><span class="p">)</span>
        <span class="p">(</span><span class="n">remove-actor</span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span><span class="p">)))</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">paint</span> <span class="n">canvas</span> <span class="n">dc</span><span class="p">)</span>
      <span class="c1">;; Same implementation as for space-ship%</span>
      <span class="p">)</span>
    <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The only remaining thing is to implement the <code>destroy</code> method in the <code>space-ship%</code> class: the explosion is created and added to the fleet and the scene and the ship removes itself from the fleet and the scene:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">space-ship%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class*))" style="color: inherit">class*</a></span> <span class="n">actor%</span> <span class="p">(</span><span class="n">fleet-member&lt;%&gt;</span><span class="p">)</span>
    <span class="c1">;; Other space ship methods unchanged...</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span> <span class="p">(</span><span class="n">destroy</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">explosion</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">explosion%</span>
                             <span class="p">[</span><span class="n">color</span> <span class="p">(</span><span class="n">sprite-color</span> <span class="n">sprite</span><span class="p">)]</span>
                             <span class="p">[</span><span class="n">pos-x</span> <span class="n">pos-x</span><span class="p">]</span>
                             <span class="p">[</span><span class="n">pos-y</span> <span class="n">pos-y</span><span class="p">]))</span>
      <span class="p">(</span><span class="n">add-actor</span> <span class="n">explosion</span><span class="p">)</span>
      <span class="p">(</span><span class="n">remove-actor</span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">the-fleet</span> <span class="n">add-ship</span> <span class="n">explosion</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">the-fleet</span> <span class="n">remove-ship</span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span><span class="p">))</span>
   <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Note how the task of hitting space ships is split between several actors: the <code>laser-shot%</code> checks for collisions and informs the <code>space-ship%</code> that it was destroyed, the <code>space-ship%</code> constructs and registers an <code>explosion%</code> in the same position as it used to be and the <code>explosion%</code> will remove itself once all its animation frames have been played. Let&rsquo;s see it in action:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="n">add-actor</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">cannon%</span><span class="p">))</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">fleet</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">fleet%</span><span class="p">))</span>
<span class="p">(</span><span class="n">add-actor</span> <span class="n">fleet</span><span class="p">)</span>
<span class="p">(</span><span class="n">create-space-ships</span> <span class="n">fleet</span><span class="p">)</span>
<span class="p">(</span><span class="n">run-game-loop</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<div class="figure"><img src="/img/a044/game-demo.gif" alt="" />
 <p class="caption"></p></div>

<h2 id="unfinished-business">Unfinished Business</h2>

<p>If you just want to play Space Invaders, you can find plenty of game implementations which are readily available and have more features and better graphics. Hopefully you are here because you are interested in <a href="https://www.racket-lang.org/">Racket</a> and if this is the case, you can take the <a href="https://gist.github.com/alex-hhh/da11a5e937960e69dc473be131be732d">source code</a>, study it and improve it. Below are some ideas on what to do next:</p>

<p>The <strong>game graphics</strong> are pretty basic, but these can be improved by simply overriding the <code>paint</code> method of various actors. Since these use the racket drawing functionality, there are many possible implementations.</p>

<p><strong>Game reset and game over</strong> is handled incompletely. While the win/lose condition is detected and the source code also displays an overlay when the game is over, trying to run the game again by calling <code>run-game-loop</code> will not work, since either there will be no space ships if the game was won or the fleet would be at the bottom if the game was lost.</p>

<p>What is a game without a <strong>game score</strong>? Each space ship could have a points value which is added to a score when the ship is destroyed. Displaying the score could be done by implementing a <code>game-score%</code> actor, whose paint method shows the score in the corner of the screen.</p>

<p>Ships could be made to <strong>move faster</strong> by increasing game speed as ships are destroyed. This can be done in the <code>fleet%</code> object by calculating the speed as a function of the number of remaining ships.</p>

<p>A more complex task would be to <strong>have ships drop bombs</strong>. The <code>fleet%</code> would need to coordinate which ships can drop them, since only ships that don&rsquo;t have anyone below them can drop the bombs, but the bombs can be implemented as actors just like the <code>laser-shot%</code> object.</p>

<p>And of course, if you are up to the task, you could try implementing <strong>bunkers</strong> which are actors that protect the cannon by &ldquo;absorbing&rdquo; some of the bombs and taking damage themselves, being partially destroyed.</p>

<p>Enjoy.</p>
  <footer>
    <div class="fine-print">© Alex Harsányi, licensed under
      <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>
      , and there's a <a href="/Cookies.html">cookie policy</a>.
    </div>
    <div class="row justify-content-center">
      <nav aria-label="Page Navigation">
        <ul class="pagination">
          <li class="page-item">
            <a class="page-link" href="/2020/10/world-map-using-plot.html"
               aria-label="Previous">
              <span aria-hidden="true">&larr; Rendering the World Map Using the Racket Plot Package</span>
            </a>
          </li>

        </ul>
      </nav>
    </div>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.identifier = undefined;
        this.page.url = undefined;
        this.page.title = undefined;
        this.page.category_id = undefined;
      };
      var disqus_shortname = 'alex-hhh-github-com';
      (function() {
          var dsq = document.createElement('script');
          dsq.type = 'text/javascript';
          dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          dsq.setAttribute('data-timestamp', +new Date());
          (document.head || document.body).appendChild(dsq);
      })();
    </script>
    <noscript>
      Please enable JavaScript to view the
      <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
  </footer>
</article>
        </div>
        <div id="sidebar-content" class="col-md-3">
          <!-- will be filled in dynamically by custom.js -->
        </div>

      </div>

    </div>
    <!-- </body> JS -->
  <!-- NOTE: jQuery must be loaded first -->
  <script type="text/javascript" src="/js/jquery-3.4.1.min.js"></script>
  <script type="text/javascript" src="/js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="/js/custom.js"></script>
  </body>
</html>