<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <title>Racket Data Frame Package</title>
    <meta name="description" content="A Racket implementation of a data frame structure, which allows efficient manipulation of data that is organized in rows and columns. It was originally written as part of the ActivityLog2 project, than moved into its own Racket package....">
    <meta name="author"      content="Alex Harsányi">
    <meta name="keywords"    content="racket">
    <meta name="viewport"    content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/img/favicon.svg">
    <link rel="canonical" href="https://alex-hhh.github.io/2018/08/racket-data-frame.html">
    <link rel="next" href="/2018/06/racket-map-widget.html">
    <link rel="prev" href="/2018/10/chess-game-using-racket-s-pasteboard.html">
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css/pygments.css">
    <link rel="stylesheet" type="text/css" href="/css/scribble.css">
    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Condensed|Roboto+Mono&display=swap" rel="stylesheet">
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml"
          href="/feeds/all.atom.xml" title="Atom Feed">
    <link rel="alternate" type="application/rss+xml"
          href="/feeds/all.rss.xml" title="RSS Feed">
    <!-- JS -->
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-110325732-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
      <div class="container">
        <a href="/index.html" class="navbar-brand">Alex Harsányi</a>

        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
                data-target="#navbar_collapse" aria-controls="navbar_collapse"
                aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbar_collapse">
          <ul class="navbar-nav mr-auto">

            <li class="nav-item dropdown">
              <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">
                Tags <b class="caret"></b></a>
              <ul class="dropdown-menu" role="menu" id="tags-menu-content">
                <!-- will be filled in dynamically by custom.js -->
              </ul>
            </li>
            <li>
              <a class="nav-link" href="/About.html">About</a>
            </li> 
            <li>
              <a class="nav-link" href="/tags/arduino.html">Arduino</a>
            </li> 
            <li>
              <a class="nav-link" href="/tags/racket.html">Racket</a>
            </li> 
            <li>
              <a class="nav-link" href="/tags/activitylog2.html">ActivityLog2</a>
            </li> 
          </ul>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="row">

        <!-- Main column -->
        <!-- NOTE: there is a bug in the web server template renderer which
             indents all items inside if blocks.  This means that we cannot
             put the contents inside an if block, as all the <pre> tags will
             be indented.
          -->
        <div id="content" class=col-md-9>





          <article>
  <header>
    <h1>Racket Data Frame Package</h1>
    <p class='date-and-tags'>
<time datetime="2018-08-05" pubdate="true">2018-08-05</time> :: <span class="tags"><a href="/tags/racket.html">racket</a></span></p>
  </header>

<p>A Racket implementation of a data frame structure, which allows efficient manipulation of data that is organized in rows and columns. It was originally written as part of the <a href="https://github.com/alex-hhh/ActivityLog2">ActivityLog2</a> project, than moved into its own Racket package.</p>
<!-- more-->

<p>You can install the package using <code>raco pkg install data-frame</code>, browse the <a href="http://docs.racket-lang.org/data-frame/index.html">reference documentation</a> or visit the project page on <a href="https://github.com/alex-hhh/data-frame">GitHub</a>. The examples below illustrate some more complex things that can be done with this package.</p>

<p>The data-frame package was developed to help analyzing fitness data recorded by Garmin devices. A fitness device, such as a bike computer or a running watch, will usually record data at 1 second interval. Each recording will contain information about the speed, GPS position, heart rate, cadence, power and several other parameters. A 2 hour bike ride will contain 7200 such data points and each data point will contain up to about 40 measurements. Someone serious about training will record more than 200 such activities each year. The size of this data set requires some careful thought about how to keep data in memory so it can be analyzed and visualized efficiently, and the data frame representation came out of this requirement.</p>

<h2 id="data-frame-object-overview">Data frame object overview</h2>

<p>The data in the data-frame object can be viewed as a 2 dimensional table with rows and columns. Each column is called a &ldquo;series&rdquo;, which consists of a name and the actual data. The package contains operations for selecting subsets of the data, both on rows and columns, efficient search and indexing, plus helper functions to calculate statistics values and generate various plots.</p>

<p>The following examples are from the ActivityLog2 application and all use a data frame loaded for a session, however data can also be loaded into the data frame from SQL databases using <code>df-read/sql</code> or from CSV files using <code>df-read/csv</code>. The following prelude is assumed, which will load the data frame for session id 1816 from the default database:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="kn">#lang </span><span class="nn">racket</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" style="color: inherit">require</a></span> <span class="s2">"al-interactive.rkt"</span><span class="p">)</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">sid</span> <span class="mi">1816</span><span class="p">)</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">df</span> <span class="p">(</span><span class="n">sid-&gt;df</span> <span class="n">sid</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>A simple way to get an overview of the contents of the data frame is the <code>df-describe</code> function, which shows all series in a data frame and some statistics values about each of them:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-describe</span> <span class="n">df</span><span class="p">)</span>
<span class="n">data-frame:</span> <span class="mi">39</span> <span class="n">series</span><span class="o">,</span> <span class="mi">4882</span> <span class="n">items</span>
<span class="n">properties:</span>
  <span class="n">is-lap-swim?</span>  <span class="no">#f</span>
  <span class="n">session-id</span>    <span class="mi">1816</span>
  <span class="n">sport</span>         <span class="o">#</span><span class="p">(</span><span class="mi">2</span> <span class="no">#f</span><span class="p">)</span>
  <span class="n">stop-points</span>   <span class="p">(</span><span class="mi">1480802649</span> <span class="mi">1480803106</span> <span class="mi">1480804370</span> <span class="mi">1480805370</span><span class="p">)</span>
  <span class="n">weight-series</span> <span class="n">timer</span>
  <span class="n">laps</span>          <span class="o">#</span><span class="p">(</span><span class="mi">1480802483</span> <span class="mi">1480802896</span> <span class="mi">1480803311</span> <span class="mi">1480803693</span> <span class="mi">1480804096</span> <span class="mi">14808</span>
<span class="ss">series:</span>
              <span class="ss">NAs</span>           <span class="ss"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._min))" style="color: inherit">min</a></span>           <span class="ss"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span>          <span class="ss">mean</span>        <span class="ss">stddev</span>
  <span class="ss">alt</span>           <span class="mi">0</span>          <span class="mf">-5.4</span>          <span class="mf">38.8</span>         <span class="mf">10.89</span>          <span class="mf">9.21</span>
  <span class="ss">cad</span>          <span class="mi">32</span>             <span class="mi">0</span>           <span class="mi">114</span>         <span class="mf">73.21</span>         <span class="mf">23.86</span>
  <span class="ss">calt</span>          <span class="mi">0</span>           <span class="mf">0.1</span>         <span class="mf">44.05</span>         <span class="mf">16.66</span>          <span class="mf">9.28</span>
  <span class="ss">distance</span>      <span class="mi">0</span>             <span class="mi">0</span>         <span class="mf">36.17</span>         <span class="mf">18.42</span>         <span class="mf">10.54</span>
  <span class="ss">dst</span>           <span class="mi">0</span>           <span class="mf">0.9</span>      <span class="mf">36171.06</span>       <span class="mf">18417.2</span>      <span class="mf">10535.92</span>
  <span class="ss">elapsed</span>       <span class="mi">0</span>           <span class="mf">0.5</span>        <span class="mf">4950.5</span>       <span class="mf">2491.93</span>       <span class="mf">1426.36</span>
  <span class="ss">grade</span>        <span class="mi">10</span>        <span class="mf">-38.38</span>         <span class="mf">18.26</span>          <span class="mf">0.45</span>          <span class="mf">3.19</span>
  <span class="ss">hr</span>            <span class="mi">0</span>            <span class="mi">91</span>           <span class="mi">169</span>        <span class="mf">144.02</span>         <span class="mf">12.28</span>

  <span class="ss">###</span> <span class="ss">MANY</span> <span class="ss">OTHER</span> <span class="ss">SERIES</span> <span class="ss">OMITTED</span> <span class="ss">###</span>

  <span class="ss">timestamp</span>     <span class="mi">0</span>  <span class="mf">1480802483.5</span>  <span class="mf">1480807433.5</span> <span class="mf">1480804974.93</span>       <span class="mf">1426.36</span>
<span class="ss">scratch.rkt&gt;</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h2 id="working-with-properties">Working with properties</h2>

<p>A data frame object can store properties, which are simple key value pairs. In ActivityLog2 these are used to store such things as the sport type, session it and lap timestamps, but they can be used to store any data about the series in the data frame</p>

<ul>
 <li><code>get-property-names</code> &mdash; returns a list of property names stored in the  object</li>
 <li><code>put-property</code>, <code>get-property</code> &mdash; are used to set and retrieve properties</li></ul>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-property-names</span> <span class="n">df</span><span class="p">)</span>
<span class="o">'</span><span class="p">(</span><span class="ss">is-lap-swim?</span> <span class="ss">session-id</span> <span class="ss">sport</span> <span class="ss">stop-points</span> <span class="ss">weight-series</span> <span class="ss">laps</span><span class="p">)</span>
<span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-get-property</span> <span class="n">df</span> <span class="o">'</span><span class="ss">session-id</span><span class="p">)</span>
<span class="mi">1816</span>
<span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-put-property</span> <span class="n">df</span> <span class="o">'</span><span class="ss">test-property</span> <span class="o">'</span><span class="ss">hello</span><span class="p">)</span>
<span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-get-property</span> <span class="n">df</span> <span class="o">'</span><span class="ss">test-property</span><span class="p">)</span>
<span class="o">'</span><span class="ss">hello</span>
<span class="n">scratch.rkt&gt;</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h2 id="working-with-series-names">Working with series names</h2>

<p>The following functions can be used to get information about what series are available in the data frame:</p>

<ul>
 <li><code>df-series-names</code> &mdash; returns a list of all the series names</li>
 <li><code>df-contains?</code> &mdash; returns #t if the data frame contains <em>all</em> of the specified  series</li>
 <li><code>df-contains/any?</code> &mdash; returns #t if the data frame contains <em>any</em> of the  specified series</li>
 <li><code>df-row-count</code> &mdash; returns the number of elements in each series of the data  frame (all series have the same number of elements)</li></ul>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-series-names</span> <span class="n">df</span><span class="p">)</span>
<span class="o">'</span><span class="p">(</span><span class="s2">"timer"</span> <span class="s2">"lpsmth"</span> <span class="s2">"rpppa"</span> <span class="s2">"rpps"</span> <span class="s2">"rppa"</span> <span class="s2">"hr"</span> <span class="s2">"lon"</span> <span class="s2">"lteff"</span>
  <span class="s2">"calt"</span> <span class="s2">"lat"</span> <span class="s2">"lppps"</span> <span class="s2">"lppa"</span> <span class="s2">"lppe"</span> <span class="s2">"elapsed"</span> <span class="s2">"pwr"</span> <span class="s2">"dst"</span>
  <span class="s2">"rpppe"</span> <span class="s2">"grade"</span> <span class="s2">"hr-zone"</span> <span class="s2">"lpps"</span> <span class="s2">"lpppe"</span> <span class="s2">"stride"</span> <span class="s2">"spd"</span>
  <span class="s2">"speed"</span> <span class="s2">"distance"</span> <span class="s2">"pwr-zone"</span> <span class="s2">"timestamp"</span> <span class="s2">"alt"</span> <span class="s2">"rpsmth"</span>
  <span class="s2">"lrbal"</span> <span class="s2">"pace"</span> <span class="s2">"cad"</span> <span class="s2">"rteff"</span> <span class="s2">"rppe"</span> <span class="s2">"rpco"</span> <span class="s2">"rppps"</span> <span class="s2">"hr-pct"</span>
  <span class="s2">"lpppa"</span> <span class="s2">"lpco"</span><span class="p">)</span>
<span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-contains?</span> <span class="n">df</span> <span class="s2">"timer"</span><span class="p">)</span>
<span class="no">#t</span>
<span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-contains?</span> <span class="n">df</span> <span class="s2">"lat"</span> <span class="s2">"lon"</span><span class="p">)</span>
<span class="no">#t</span>
<span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-contains?</span> <span class="n">df</span> <span class="s2">"non-existent"</span><span class="p">)</span>
<span class="no">#f</span>
<span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-contains?</span> <span class="n">df</span> <span class="s2">"timer"</span> <span class="s2">"non-existent"</span><span class="p">)</span>
<span class="no">#f</span>
<span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-contains/any?</span> <span class="n">df</span> <span class="s2">"timer"</span> <span class="s2">"non-existent"</span><span class="p">)</span>
<span class="no">#t</span>
<span class="n">scratch.rkt&gt;</span>  <span class="p">(</span><span class="n">df-row-count</span> <span class="n">df</span><span class="p">)</span>
<span class="mi">4882</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h2 id="accessing-the-data-using-df-select-and-df-select">Accessing the data using <code>df-select</code> and <code>df-select*</code></h2>

<p>The <code>df-select</code> and <code>df-select*</code> functions can be used to retrieve data from a data frame. The simplest method, is to just ask for the entire series. The following retrieves the entire set of heart rate values:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-select</span> <span class="n">df</span> <span class="s2">"hr"</span><span class="p">)</span>
<span class="o">'#</span><span class="p">(</span><span class="mf">89.0</span> <span class="mf">93.0</span> <span class="mf">94.0</span> <span class="mf">94.0</span> <span class="mf">94.0</span> <span class="ss"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" style="color: inherit">...</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Data can also be filtered. For example, the following retrieves only heart rate values greater than 150 BPM:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-select</span> <span class="n">df</span> <span class="s2">"hr"</span> <span class="kd">#:filter</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" style="color: inherit">lambda</a></span> <span class="p">(</span><span class="n">hr</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="n">hr</span> <span class="mi">150</span><span class="p">)))</span>
<span class="o">'#</span><span class="p">(</span><span class="mf">151.0</span> <span class="mf">152.0</span> <span class="mf">152.0</span> <span class="mf">151.0</span> <span class="mf">152.0</span> <span class="mf">152.0</span> <span class="mf">152.0</span> <span class="ss"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" style="color: inherit">...</a></span> <span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Finally, a subset of the data points can be retrieved by specifying start and end indexes (see below on how to retrieve useful indexes):</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-select</span> <span class="n">df</span> <span class="s2">"hr"</span> <span class="kd">#:start</span> <span class="mi">100</span> <span class="kd">#:stop</span> <span class="mi">105</span><span class="p">)</span>
<span class="o">'#</span><span class="p">(</span><span class="mf">123.0</span> <span class="mf">122.0</span> <span class="mf">123.0</span> <span class="mf">123.0</span> <span class="mf">123.0</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The <code>df-select*</code> function can be used to retrieve data from multiple series. It will return a vector containing a vector for each data point selected. For example, the code below can be used to retrieve the GPS track from a data series:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-select*</span> <span class="n">df</span> <span class="s2">"lat"</span> <span class="s2">"lon"</span> <span class="kd">#:filter</span> <span class="n">valid-only</span><span class="p">)</span>
<span class="o">'#</span><span class="p">(</span><span class="o">#</span><span class="p">(</span><span class="mf">-22.475327365100384</span> <span class="mf">118.560850918293</span><span class="p">)</span>
   <span class="o">#</span><span class="p">(</span><span class="mf">-22.475248826667666</span> <span class="mf">118.5613826662302</span><span class="p">)</span>
   <span class="o">#</span><span class="p">(</span><span class="mf">-22.475329376757145</span> <span class="mf">118.56146103702486</span><span class="p">)</span>
   <span class="o">#</span><span class="p">(</span><span class="mf">-22.475371956825256</span> <span class="mf">118.56151258572936</span><span class="p">)</span>
   <span class="o">#</span><span class="p">(</span><span class="mf">-22.475371873006225</span> <span class="mf">118.56151392683387</span><span class="p">)</span>
   <span class="o">#</span><span class="p">(</span><span class="mf">-22.475372292101383</span> <span class="mf">118.56153203174472</span><span class="p">)</span>
   <span class="ss"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" style="color: inherit">...</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h2 id="find-positions-using-df-index-of-and-df-index-of">Find positions using <code>df-index-of</code> and <code>df-index-of*</code></h2>

<p>The <code>df-index-of</code> and <code>df-index-of*</code> functions can be used to find the position where a value is stored in a data series &mdash; the data series will have to make sorted for this to work using <code>df-set-sorted</code>. <code>df-index-of</code> retrieves a single position, while <code>df-index-of**</code> retrieves multiple values at once.</p>

<p>The <code>laps</code> property contains a list of timestamps for the start of each lap in the activity:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-get-property</span> <span class="n">df</span> <span class="o">'</span><span class="ss">laps</span><span class="p">)</span>
<span class="o">'#</span><span class="p">(</span><span class="mi">1480802483</span> <span class="mi">1480802896</span> <span class="mi">1480803311</span> <span class="mi">1480803693</span> <span class="mi">1480804096</span> <span class="mi">1480804492</span>
   <span class="mi">1480804870</span> <span class="mi">1480805324</span> <span class="mi">1480805750</span> <span class="mi">1480806117</span> <span class="mi">1480806508</span> <span class="mi">1480806929</span>
   <span class="mi">1480807412</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Find the position where the second and third laps start:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-index-of</span> <span class="n">df</span> <span class="s2">"timestamp"</span> <span class="mi">1480802896</span><span class="p">)</span>
<span class="mi">392</span>
<span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-index-of</span> <span class="n">df</span> <span class="s2">"timestamp"</span> <span class="mi">1480803311</span><span class="p">)</span>
<span class="mi">785</span>
<span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-index-of*</span> <span class="n">df</span> <span class="s2">"timestamp"</span> <span class="mi">1480802896</span> <span class="mi">1480803311</span><span class="p">)</span>
<span class="o">'</span><span class="p">(</span><span class="mi">392</span> <span class="mi">785</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Extract heart rate data or the GPS track for the second lap:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-select</span> <span class="n">df</span> <span class="s2">"hr"</span> <span class="kd">#:start</span> <span class="mi">392</span> <span class="kd">#:end</span> <span class="mi">785</span><span class="p">)</span>
<span class="o">'#</span><span class="p">(</span><span class="mf">157.0</span> <span class="mf">157.0</span> <span class="mf">157.0</span> <span class="mf">158.0</span> <span class="mf">158.0</span> <span class="mf">158.0</span> <span class="mf">159.0</span> <span class="ss"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" style="color: inherit">...</a></span><span class="p">)</span>
<span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-select*</span> <span class="n">df</span> <span class="s2">"lat"</span> <span class="s2">"lon"</span> <span class="kd">#:start</span> <span class="mi">392</span> <span class="kd">#:end</span> <span class="mi">785</span><span class="p">)</span>
<span class="o">'</span><span class="p">(</span><span class="o">#</span><span class="p">(</span><span class="mf">-42.68540868535638</span> <span class="mf">146.59324564039707</span><span class="p">)</span>
  <span class="o">#</span><span class="p">(</span><span class="mf">-42.67952333204448</span> <span class="mf">146.58431304618716</span><span class="p">)</span> <span class="ss"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" style="color: inherit">...</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The same mechanism can be used to find the positions for distances, or time, etc. For example we could look up in the &ldquo;dst&rdquo; series the positions for the second KM in the activity. The returned positions could be used to retrieve the GPS track for the second KM of the activity:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-index-of*</span> <span class="n">df</span> <span class="s2">"dst"</span> <span class="mi">1000</span> <span class="mi">2000</span><span class="p">)</span>
<span class="o">'</span><span class="p">(</span><span class="mi">131</span> <span class="mi">271</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h2 id="retrieving-individual-values-using-df-ref-and-df-ref">Retrieving individual values using <code>df-ref</code> and <code>df-ref*</code></h2>

<p>The <code>df-ref</code> and <code>df-ref*</code> functions can be used to retrieve a single value from an index in a series or in multiple series (<code>df-ref*</code>). Using the examples above, to retrieve the heart rate at the start of the second lap:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-ref</span> <span class="n">df</span> <span class="mi">392</span> <span class="s2">"hr"</span><span class="p">)</span>
<span class="mf">157.0</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>And to retrieve the GPS location where the second lap starts:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-ref*</span> <span class="n">df</span> <span class="mi">392</span> <span class="s2">"lat"</span> <span class="s2">"lon"</span><span class="p">)</span>
<span class="o">'#</span><span class="p">(</span><span class="mf">-22.475329376757145</span> <span class="mf">118.56146103702486</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p><em>NOTE</em> unlike the <code>df-index-of</code>, <code>df-index-of*</code> functions, the <code>df-ref</code> and <code>df-ref*</code> methods have the index specified before the series names.</p>

<h2 id="lookups-using-df-lookup-and-df-lookup">Lookups using <code>df-lookup</code> and <code>df-lookup*</code></h2>

<p>The <code>df-index-of</code> and <code>df-ref</code> functions can be combined into a single function, <code>df-lookup</code>, which can be used to lookup a value in a base series and return the corresponding value in a second series. Continuing the example above, the heart rate for the start of a lap can be retrieved using a single call:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-lookup</span> <span class="n">df</span> <span class="s2">"timestamp"</span> <span class="s2">"hr"</span> <span class="mi">1480802896</span><span class="p">)</span>
<span class="mf">157.0</span>
<span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-lookup</span> <span class="n">df</span> <span class="s2">"timestamp"</span> <span class="o">'</span><span class="p">(</span><span class="s2">"lat"</span> <span class="s2">"lon"</span><span class="p">)</span> <span class="mi">1480802896</span><span class="p">)</span>
<span class="o">'#</span><span class="p">(</span><span class="mf">-22.475329376757145</span> <span class="mf">118.56146103702486</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Multiple values can be looked up using <code>df-lookup*</code>, which is analogous to <code>df-index-of*</code>:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-lookup*</span> <span class="n">df</span> <span class="s2">"timestamp"</span> <span class="s2">"hr"</span> <span class="mi">1480802896</span> <span class="mi">1480803311</span><span class="p">)</span>
<span class="o">'</span><span class="p">(</span><span class="mf">157.0</span> <span class="mf">133.0</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h2 id="iterating-over-values-using-df-map-df-for-each-and-df-fold">Iterating over values using <code>df-map</code>, <code>df-for-each</code> and <code>df-fold</code></h2>

<p>The <code>df-map</code>, <code>df-for-each</code> and <code>df-fold</code> functions are similar to the corresponding Racket built-in variants, but operate on the values of series. They take the following parameters:</p>

<ul>
 <li><code>base-series</code> is either a series name or a list of series names. The  iteration will happen over values in these series</li>
 <li><code>init-val</code> (used for <code>fold</code> only) is the initial value passed in</li>
 <li><code>fn</code> is a function called on each value.</li>
 <li><code>#:start</code> and <code>#:stop</code> allow specifying start and end positions for elements  that are iterated.</li></ul>

<p>The call back function can have one or two arguments for <code>df-map</code> and <code>df-for-each</code> and two or three arguments for <code>df-fold</code>.</p>

<p>To iterate over a single value at a time, use a function like <code>(lambda (VAL)
...)</code>, it will be passed in values from the series packed in a vector. To iterate over adjacent pairs of values, specify <code>(lambda (PREV-VAL VAL) ...)</code>, it will be passed in the current and previous set of values. The variants used for <code>fold</code> use the accumulator as a first argument: <code>(lambda (ACCUM VAL)
...)</code>, or <code>(lambda (ACCUM PREV-VAL VAL) ...)</code>.</p>

<p>For example, the following function can be used to calculate the work (in Joules) from the time and the power series. The function receives pairs of data points and determines the amount of work (power * delta-time) and adds it to the accumulated value:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">accum-work</span> <span class="n">prev-work</span> <span class="n">prev-val</span> <span class="n">val</span><span class="p">)</span>
  <span class="c1">;; for the first element, there will be no previous value</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="n">prev-val</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match-let))" style="color: inherit">match-let</a></span> <span class="p">(((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector))" style="color: inherit">vector</a></span> <span class="n">time1</span> <span class="n">power1</span><span class="p">)</span> <span class="n">prev-val</span><span class="p">)</span>
                  <span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector))" style="color: inherit">vector</a></span> <span class="n">time2</span> <span class="n">power2</span><span class="p">)</span> <span class="n">val</span><span class="p">))</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="n">time1</span> <span class="n">power1</span> <span class="n">time2</span> <span class="n">power2</span><span class="p">)</span> <span class="c1">; all values are valid</span>
            <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">prev-work</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="mf">0.5</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">power1</span> <span class="n">power2</span><span class="p">))</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">time2</span> <span class="n">time1</span><span class="p">)))</span>
            <span class="n">prev-work</span><span class="p">))</span>
      <span class="n">prev-work</span><span class="p">))</span>

<span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-fold</span> <span class="n">df</span> <span class="o">'</span><span class="p">(</span><span class="s2">"timer"</span> <span class="s2">"pwr"</span><span class="p">)</span> <span class="mi">0</span> <span class="n">accum-work</span><span class="p">)</span>
<span class="mf">796091.0</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h2 id="adding-new-series-using-df-add-derived-and-df-add-lazy">Adding new series using <code>df-add-derived</code> and <code>df-add-lazy</code></h2>

<p>The <code>df-add-derived</code> function can be used to add new series to the data frame, as computations from other series. It is used in session-df for example to create a &ldquo;distance&rdquo; series (which is either in KM or Miles") from the &ldquo;dst&rdquo; series which is in meters.</p>

<p>The function takes the following parameters:</p>

<ul>
 <li><code>name</code> &mdash; name of the new data series</li>
 <li><code>base-series</code> &mdash; is either a series name or a list of series names. The  iteration will happen over values in these series</li>
 <li><code>value-fn</code> &mdash; function to produce values for the new series it has the same  signature as the function passed to <code>map</code> or <code>for-each</code></li></ul>

<p>The example below, adds the accumulated work at each point in the bike ride:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">current-work</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">add-work</span> <span class="n">prev-val</span> <span class="n">val</span><span class="p">)</span>
  <span class="c1">;; for the first element, there will be no previous value</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="n">prev-val</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match-let))" style="color: inherit">match-let</a></span> <span class="p">(((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector))" style="color: inherit">vector</a></span> <span class="n">time1</span> <span class="n">power1</span><span class="p">)</span> <span class="n">prev-val</span><span class="p">)</span>
                <span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector))" style="color: inherit">vector</a></span> <span class="n">time2</span> <span class="n">power2</span><span class="p">)</span> <span class="n">val</span><span class="p">))</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="n">time1</span> <span class="n">power1</span> <span class="n">time2</span> <span class="n">power2</span><span class="p">)</span> <span class="c1">; all values are valid</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">current-work</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">current-work</span>
                              <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="mf">0.5</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">power1</span> <span class="n">power2</span><span class="p">))</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">time2</span> <span class="n">time1</span><span class="p">)))))))</span>
  <span class="n">current-work</span><span class="p">)</span>

<span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-add-derived</span> <span class="n">df</span> <span class="s2">"work"</span> <span class="o">'</span><span class="p">(</span><span class="s2">"timer"</span> <span class="s2">"pwr"</span><span class="p">)</span> <span class="n">add-work</span><span class="p">)</span>
<span class="n">scratch.rkt&gt;</span> <span class="p">(</span><span class="n">df-select</span> <span class="n">df</span> <span class="s2">"work"</span><span class="p">)</span>
<span class="o">'#</span><span class="p">(</span><span class="mi">0</span> <span class="mf">0.0</span> <span class="mf">0.0</span> <span class="mf">0.0</span> <span class="mf">50.0</span> <span class="mf">241.5</span> <span class="mf">553.0</span> <span class="mf">891.5</span> <span class="mf">1208.0</span> <span class="mf">1439.0</span> <span class="ss"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" style="color: inherit">...</a></span> <span class="mf">796091.0</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The <code>df-add-lazy</code> is the lazy version of the function: it adds a closure to the data frame and the data series will be created the first time it is referenced. Special care needs to be used with this function, especially if it captures local variables, as the environment in which the function runs might not be the same as the non-lazy version.</p>

<h2 id="other-functionality">Other functionality</h2>

<p>The package also contains functions that provide additional functionality:</p>

<ul>
 <li>statistics on data frame objects can be calculated using <code>df-statistics</code> and  <code>df-quantile</code>, these adapt the functions from <code>math/statistics</code> to work  directly with data frames</li>
 <li>histograms and histogram plots can be computed using <code>df-histogram</code> and  <code>histogram-renderer</code> (plus some other functions)</li>
 <li>various helpers for creating scatter plots, see <code>scatter-renderer</code> and  related functions.</li></ul>

<h3 id="least-squares-fitting">Least Squares Fitting</h3>

<p>The <code>df-least-squares-fit</code> function can be used to find a best fit function for some data in the data frame. It can find polynomial, exponential, logarithmic and power functions which closely match an input data set. To use it, you will need to specify the X and Y series names:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">fit</span> <span class="p">(</span><span class="n">df-least-squares-fit</span> <span class="n">df</span> <span class="s2">"xseries"</span> <span class="s2">"yseries"</span>
             <span class="kd">#:mode</span> <span class="o">'</span><span class="ss">polynomial</span> <span class="kd">#:polynomial-degree</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The resulting <code>fit</code> object acts as a function, so it can be plotted together with the input data set:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="n">plot</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span>
  <span class="p">(</span><span class="n">tick-grid</span><span class="p">)</span>
  <span class="p">(</span><span class="n">points</span> <span class="p">(</span><span class="n">df-select*</span> <span class="n">df</span> <span class="s2">"xseries"</span> <span class="s2">"yseries"</span><span class="p">))</span>
  <span class="p">(</span><span class="n">function</span> <span class="n">fit</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Here are some examples of fitting different data sets:</p>

<div id="myCarousel" class="carousel slide" data-ride="carousel"><!-- Indicators--> 
 <ol class="carousel-indicators">
  <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
  <li data-target="#myCarousel" data-slide-to="1"></li>
  <li data-target="#myCarousel" data-slide-to="2"></li>
  <li data-target="#myCarousel" data-slide-to="3"></li>
  <li data-target="#myCarousel" data-slide-to="4"></li>
  <li data-target="#myCarousel" data-slide-to="5"></li></ol> <!-- Wrapper for slides--> 
 <div class="carousel-inner">
  <div class="carousel-item active"><img class="rounded" src="/img/a016/linear-fit.svg" alt="Linear Fit" /></div> 
  <div class="carousel-item"><img class="rounded" src="/img/a016/second-fit.svg" alt="Second Degree Polynomial Fit" /></div> 
  <div class="carousel-item"><img class="rounded" src="/img/a016/third-fit.svg" alt="Third Degree Polynomial Fit" /></div> 
  <div class="carousel-item"><img class="rounded" src="/img/a016/exp-fit.svg" alt="Exponential Fit" /></div> 
  <div class="carousel-item"><img class="rounded" src="/img/a016/log-fit.svg" alt="Logarithmic Fit" /></div> 
  <div class="carousel-item"><img class="rounded" src="/img/a016/pow-fit.svg" alt="Power Function Fit" /></div></div> <!-- Left and right controls--> <a class="carousel-control-prev" href="#myCarousel" role="button" data-slide="prev"><span class="carousel-control-prev-icon" aria-hidden="true"></span> <span class="sr-only">Previous</span></a> <a class="carousel-control-next" href="#myCarousel" role="button" data-slide="next"><span class="carousel-control-next-icon" aria-hidden="true"></span> <span class="sr-only">Next</span></a></div>

<h3 id="re-working-the-map-widget-demo-to-use-data-frames">Re-working the map widget demo to use data frames</h3>

<p>The <a href="/2018/06/a-racket-gui-widget-to-display-maps-based-on-openstreetmap-tiles.html">map-widget</a> demo used a small library to load a GPX file containing the track that is shown on the map, but with the <code>data-frame</code> library this is supported directly.</p>

<p>The example below uses the following racket file as the base. This file is evaluated and the rest of the commands can be typed in at the prompt:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="kn">#lang </span><span class="nn">racket/gui</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" style="color: inherit">require</a></span> <span class="n">data-frame</span> <span class="n">map-widget</span> <span class="n">mrlib/snip-canvas</span> <span class="n">plot</span><span class="p">)</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">toplevel</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">frame%</span> <span class="p">[</span><span class="n">label</span> <span class="s2">"Map Demo"</span><span class="p">]</span> <span class="p">[</span><span class="n">width</span> <span class="mi">600</span><span class="p">]</span> <span class="p">[</span><span class="n">height</span> <span class="mi">400</span><span class="p">]))</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._map))" style="color: inherit">map</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">map-widget%</span> <span class="p">[</span><span class="n">parent</span> <span class="n">toplevel</span><span class="p">]))</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">toplevel</span> <span class="n">show</span> <span class="no">#t</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>A GPX file can be loaded in a data frame using <code>df-read/gpx</code>, and the resulting data frame can be inspected using <code>df-describe</code>:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="n">df-demo.rkt&gt;</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">df</span> <span class="p">(</span><span class="n">df-read/gpx</span> <span class="s2">"./tarn-shelf.gpx"</span><span class="p">))</span>
<span class="n">df-demo.rkt&gt;</span> <span class="p">(</span><span class="n">df-describe</span> <span class="n">df</span><span class="p">)</span>
<span class="n">data-frame:</span> <span class="mi">5</span> <span class="n">columns</span><span class="o">,</span> <span class="mi">16287</span> <span class="n">rows</span>
<span class="n">properties:</span>
  <span class="n">waypoints</span> <span class="p">((</span><span class="mi">1485442935</span> <span class="mf">-42.67913189716637</span> <span class="mf">146.58711176365614</span> <span class="mf">1126.94</span> <span class="n">Lap</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">laps</span>      <span class="p">(</span><span class="mi">1485442935</span> <span class="mi">1485444483</span> <span class="mi">1485445975</span> <span class="mi">1485447502</span> <span class="mi">1485449146</span> <span class="mi">1485450523</span>
  <span class="n">name</span>      <span class="n">Tarn</span> <span class="n">Shelf</span><span class="o">,</span> <span class="n">Mt</span> <span class="n">Field</span> <span class="n">NP</span> <span class="p">(</span><span class="n">Hiking</span><span class="p">)</span>
<span class="n">series:</span>
              <span class="n">NAs</span>           <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._min))" style="color: inherit">min</a></span>           <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._max))" style="color: inherit">max</a></span>          <span class="n">mean</span>        <span class="n">stddev</span>
  <span class="n">alt</span>           <span class="mi">0</span>        <span class="mf">854.93</span>       <span class="mf">1278.35</span>       <span class="mf">1089.94</span>        <span class="mf">122.06</span>
  <span class="n">dst</span>           <span class="mi">0</span>             <span class="mi">0</span>      <span class="mf">14903.55</span>       <span class="mf">7184.98</span>       <span class="mf">4192.82</span>
  <span class="n">lat</span>           <span class="mi">0</span>        <span class="mf">-42.69</span>        <span class="mf">-42.65</span>        <span class="mf">-42.67</span>          <span class="mf">0.01</span>
  <span class="n">lon</span>           <span class="mi">0</span>        <span class="mf">146.56</span>        <span class="mf">146.59</span>        <span class="mf">146.58</span>          <span class="mf">0.01</span>
  <span class="n">timestamp</span>     <span class="mi">0</span>    <span class="mi">1485470647</span>    <span class="mi">1485490648</span>  <span class="mf">1485480878.4</span>       <span class="mf">5984.35</span>
<span class="n">df-demo.rkt&gt;</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The data from the GPX file is loaded into 5 series containing the latitude, longitude, elevation and timestamp for each point. In addition, a distance series, &ldquo;dst&rdquo; is added representing the distance of each point from the start of the track, this will allow us to look up GPS positions based on distance.</p>

<p>The GPX track can be added to the map widget by selecting just the &ldquo;lat&rdquo; and &ldquo;lon&rdquo; using <code>df-select*</code>. You might need to center the map, to move it to the location where the track is using the <code>center-map</code> method of the map widget:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="n">df-demo.rkt&gt;</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._map))" style="color: inherit">map</a></span> <span class="n">add-track</span> <span class="p">(</span><span class="n">df-select*</span> <span class="n">df</span> <span class="s2">"lat"</span> <span class="s2">"lon"</span><span class="p">)</span> <span class="o">'</span><span class="ss">track</span><span class="p">)</span>
<span class="n">df-demo.rkt&gt;</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._map))" style="color: inherit">map</a></span> <span class="n">center-map</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>To put marker locations on the map, we need to find the GPS location of each mile. The <code>df-lookup</code> function can be used to find an element in a target series given a value in a source series, for example, the call <code>(df-lookup df
"dst" '("lat" "lon) 1609)</code> will return the GPS coordinates for the position at the first mile<sup><a href="#2018-08-05-racket-data-frame-footnote-1-definition" name="2018-08-05-racket-data-frame-footnote-1-return">1</a></sup> in the track. To find all the mile locations we can use a for loop:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="n">df-demo.rkt&gt;</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">total-distance</span> <span class="p">(</span><span class="n">df-ref</span> <span class="n">df</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" style="color: inherit">sub1</a></span> <span class="p">(</span><span class="n">df-row-count</span> <span class="n">df</span><span class="p">))</span> <span class="s2">"dst"</span><span class="p">))</span>
<span class="n">df-demo.rkt&gt;</span> <span class="n">total-distance</span>
<span class="mf">14903.545661638052</span>
<span class="n">df-demo.rkt&gt;</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">marker-locations</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" style="color: inherit">for/list</a></span> <span class="p">([</span><span class="n">mile</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-range))" style="color: inherit">in-range</a></span> <span class="mi">0</span> <span class="n">total-distance</span> <span class="mi">1609</span><span class="p">)])</span>
      <span class="p">(</span><span class="n">df-lookup</span> <span class="n">df</span> <span class="s2">"dst"</span> <span class="o">'</span><span class="p">(</span><span class="s2">"lat"</span> <span class="s2">"lon"</span><span class="p">)</span> <span class="n">mile</span><span class="p">)))</span>
<span class="n">df-demo.rkt&gt;</span> <span class="n">marker-locations</span>
<span class="o">'</span><span class="p">(</span><span class="o">#</span><span class="p">(</span><span class="mf">-42.68540868535638</span> <span class="mf">146.59324564039707</span><span class="p">)</span>
  <span class="o">#</span><span class="p">(</span><span class="mf">-42.67952333204448</span> <span class="mf">146.58431304618716</span><span class="p">)</span>
  <span class="o">#</span><span class="p">(</span><span class="mf">-42.67874247394502</span> <span class="mf">146.57109302468598</span><span class="p">)</span>
  <span class="o">#</span><span class="p">(</span><span class="mf">-42.67064957879484</span> <span class="mf">146.5663103107363</span><span class="p">)</span>
  <span class="o">#</span><span class="p">(</span><span class="mf">-42.65975930728018</span> <span class="mf">146.56189740635455</span><span class="p">)</span>
  <span class="o">#</span><span class="p">(</span><span class="mf">-42.65489989891648</span> <span class="mf">146.57579275779426</span><span class="p">)</span>
  <span class="o">#</span><span class="p">(</span><span class="mf">-42.65118286013603</span> <span class="mf">146.58114535734057</span><span class="p">)</span>
  <span class="o">#</span><span class="p">(</span><span class="mf">-42.65805283561349</span> <span class="mf">146.58975390717387</span><span class="p">)</span>
  <span class="o">#</span><span class="p">(</span><span class="mf">-42.67057556658983</span> <span class="mf">146.59253066405654</span><span class="p">)</span>
  <span class="o">#</span><span class="p">(</span><span class="mf">-42.68192206509411</span> <span class="mf">146.5928765013814</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Finally, the markers can be added to the map using the <code>add-marker</code> method on the map widget:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="n">df-demo.rkt&gt;</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">marker-color</span> <span class="p">(</span><span class="n">make-color</span> <span class="mi">0</span> <span class="mi">135</span> <span class="mi">36</span><span class="p">))</span>
<span class="n">df-demo.rkt&gt;</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span> <span class="p">([(</span><span class="n">position</span> <span class="n">index</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-indexed))" style="color: inherit">in-indexed</a></span> <span class="n">marker-locations</span><span class="p">)])</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._map))" style="color: inherit">map</a></span> <span class="n">add-marker</span> <span class="n">position</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._format))" style="color: inherit">format</a></span> <span class="s2">"Mile ~a"</span> <span class="n">index</span><span class="p">)</span> <span class="mi">1</span> <span class="n">marker-color</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>And this produces the following result:</p>

<div class="figure"><img src="/img/a016/map-demo.png" alt="" />
 <p class="caption"></p></div>

<p>An interactive elevation plot can also be added, and the data frame functions <code>df-select*</code>, <code>df-lookup</code> and, a more appropriate <code>df-lookup/interpolated</code> can be used to simplify the code. The entire example is available in this <a href="https://gist.github.com/alex-hhh/7304c2a09bf1b7ec8514c2523a827b05">GitHub Gist</a>.</p>

<h3 id="footnotes">Footnotes</h3>

<div class="footnotes">
 <ol>
  <li id="2018-08-05-racket-data-frame-footnote-1-definition" class="footnote-definition">
   <p>the &ldquo;dst&rdquo; series is in meters, so the first mile is at 1609 meters&nbsp;<a href="#2018-08-05-racket-data-frame-footnote-1-return">↩</a></p></li></ol></div>
  <footer>
    <div class="row justify-content-center">
      <nav aria-label="Page Navigation">
        <ul class="pagination">
          <li class="page-item">
            <a class="page-link" href="/2018/06/racket-map-widget.html"
               aria-label="Previous">
              <span aria-hidden="true">&larr; A Racket GUI Widget to display maps based on OpenStreetMap tiles</span>
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="/2018/10/chess-game-using-racket-s-pasteboard.html"
               aria-label="Next">
              <span aria-hidden="true">Chess Game Using Racket&rsquo;s Pasteboard &rarr;</span>
            </a>
          </li>
        </ul>
      </nav>
    </div>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.identifier = undefined;
        this.page.url = undefined;
        this.page.title = undefined;
        this.page.category_id = undefined;
      };
      var disqus_shortname = 'alex-hhh-github-com';
      (function() {
          var dsq = document.createElement('script');
          dsq.type = 'text/javascript';
          dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          dsq.setAttribute('data-timestamp', +new Date());
          (document.head || document.body).appendChild(dsq);
      })();
    </script>
    <noscript>
      Please enable JavaScript to view the
      <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
  </footer>
</article>
        </div>
        <div id="sidebar-content" class="col-md-3">
          <!-- will be filled in dynamically by custom.js -->
        </div>
      </div>
      <footer>
        <hr />
        <div class="fine-print">© Alex Harsányi, licensed under
          <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>
          , and there's a <a href="/Cookies.html">cookie policy</a>.
        </div>
      </footer>
    </div>
    <!-- </body> JS -->
  <!-- NOTE: jQuery must be loaded first -->
  <script type="text/javascript" src="/js/jquery-3.4.1.min.js"></script>
  <script type="text/javascript" src="/js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="/js/custom.js"></script>
  </body>
</html>