<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <title>Chess Game Using Racket's Pasteboard (part 3)</title>
    <meta name="description" content="The `pasteboard%`object is an editor of `snip%` objects and it implements some features that make sense for an editor: for example, you can select multiple snips and drag them around with the mouse, and you can move selected snips using the keyboard, you ...">
    <meta name="author"      content="Alex HarsÃ¡nyi">
    <meta name="keywords"    content="racket">
    <meta name="viewport"    content="width=device-width, initial-scale=1.0">
    <link rel="icon"      href="/favicon.ico">
    <link rel="canonical" href="https://alex-hhh.github.io/2018/10/chess-game-using-racket-s-pasteboard-part-3.html">
    <link rel="next" href="/2018/10/chess-game-using-racket-s-pasteboard-part-2.html">
    <link rel="prev" href="/2018/11/an-enhanced-text-field-gui-control-for-racket.html">
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css/pygments.css">
    <link rel="stylesheet" type="text/css" href="/css/scribble.css">
    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml"
          href="/feeds/all.atom.xml" title="Atom Feed">
    <link rel="alternate" type="application/rss+xml"
          href="/feeds/all.rss.xml" title="RSS Feed">
    <!-- JS -->
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-110325732-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <!-- A standard Twitter Bootstrap nav bar -->
    <header class="navbar navbar-default navbar-inverse"
            role="banner">
      <div class="container">
        <div class="navbar-header">
          <button type="button"
                  class="navbar-toggle"
                  data-toggle="collapse"
                  data-target=".our-nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="/index.html" class="navbar-brand">Alex Harsanyi</a>
        </div>
        <div class="collapse navbar-collapse our-nav-collapse"
             role="navigation">
          <ul class="nav navbar-nav">

            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                Tags <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="/index.html">All Posts</a></li>

<li><a href="/tags/activitylog2.html">activitylog2&nbsp;
  <small>(4)</small></a></li>

<li><a href="/tags/arduino.html">arduino&nbsp;
  <small>(3)</small></a></li>

<li><a href="/tags/bike-trainer.html">bike trainer&nbsp;
  <small>(1)</small></a></li>

<li><a href="/tags/racket.html">racket&nbsp;
  <small>(11)</small></a></li>

<li><a href="/tags/training-data-analysis.html">training data analysis&nbsp;
  <small>(5)</small></a></li>
              </ul>
            </li>
            <li>
              <a href="/About.html">About</a>
            </li> 
            <li>
              <a href="/tags/arduino.html">Arduino</a>
            </li> 
            <li>
              <a href="/tags/racket.html">Racket</a>
            </li> 
            <li>
              <a href="/tags/activitylog2.html">ActivityLog2</a>
            </li> 
          </ul>
        </div>
      </div>
    </header>
    <div class="container">
      <div class="row">

        <!-- Main column -->
        <!-- NOTE: there is a bug in the web server template renderer which
             indents all items inside if blocks.  This means that we cannot
             put the contents inside an if block, as all the <pre> tags will
             be indented.
          -->
        <div id="content" class=col-md-9>





          <article>
  <header>
    <h1>Chess Game Using Racket&rsquo;s Pasteboard (part 3)</h1>
    <p class='date-and-tags'>
<time datetime="2018-10-29" pubdate="true">2018-10-29</time> :: <span class="tags"><a href="/tags/racket.html">racket</a></span></p>
  </header>

<p>The <code>pasteboard%</code>object is an editor of <code>snip%</code> objects and it implements some features that make sense for an editor: for example, you can select multiple snips and drag them around with the mouse, and you can move selected snips using the keyboard, you can also add any kind of snip, not just chess pieces to the pasteboard. Since none of these features are useful or desirable for a chess board game we will look at how to disable them.</p>
<!-- more-->

<p>This is the last post in the series about implementing a chess board game using the Racket <code>pasteboard%</code>. If you haven&rsquo;t already done so, you might want to read the <a href="/2018/10/chess-game-using-racket-s-pasteboard.html">first blog post</a> and <a href="/2018/10/chess-game-using-racket-s-pasteboard-part-2.html">the second one</a> before reading this one.</p>

<h2 id="selecting-only-one-chess-piece-at-a-time">Selecting only one chess piece at a time</h2>

<p>By default, the <code>pasteboard%</code> will allow multiple snips to be selected and this can be done in two ways: dragging the mouse over a region of the canvas will select all snips in that region, and holding down shift while clicking on a snip will not remove the selection from the previous snip. This behavior is not suitable for a chess game, so we need to disable both ways of performing a multiple selection:</p>

<ul>
 <li>disabling drag selection is done by calling <code>set-area-selectable</code> with an  <code>#f</code> argument</li>
 <li>disabling multiple selection with the Shift key is done by overriding the  <code>after-select</code> method and un-selecting any other snips when a snip is  selected.</li></ul>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">chess-board%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">pasteboard%</span>
    <span class="c1">;; rest of the chess-board% definition remains unchanged...</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span> <span class="n">set-area-selectable</span> <span class="no">#f</span><span class="p">)</span> <span class="c1">; disable drag-select for the pasteboard</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/augment))" style="color: inherit">define/augment</a></span> <span class="p">(</span><span class="n">after-select</span> <span class="n">snip</span> <span class="n">on?</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="n">on?</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">other-selected-snips</span>
          <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="n">loop</span> <span class="p">((</span><span class="n">other</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span> <span class="n">find-next-selected-snip</span> <span class="no">#f</span><span class="p">))</span>
                     <span class="p">(</span><span class="n">result</span> <span class="o">'</span><span class="p">()))</span>
            <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="n">other</span>
                <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="p">((</span><span class="n">next</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span> <span class="n">find-next-selected-snip</span> <span class="n">other</span><span class="p">)))</span>
                  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._eq~3f))" style="color: inherit">eq?</a></span> <span class="n">snip</span> <span class="n">other</span><span class="p">)</span>
                      <span class="p">(</span><span class="n">loop</span> <span class="n">next</span> <span class="n">result</span><span class="p">)</span>
                      <span class="p">(</span><span class="n">loop</span> <span class="n">next</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" style="color: inherit">cons</a></span> <span class="n">other</span> <span class="n">result</span><span class="p">))))</span>
                <span class="n">result</span><span class="p">)))</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span> <span class="p">([</span><span class="n">snip</span> <span class="n">other-selected-snips</span><span class="p">])</span>
          <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span> <span class="n">remove-selected</span> <span class="n">snip</span><span class="p">)))</span>
      <span class="c1">;; Rest of the after-select definition remains unchanged...</span>
      <span class="p">)</span>

    <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>It is worth mentioning two things about the code that un-selects snips in <code>after-select</code>:</p>

<ul>
 <li>since selected snips are linked together using <code>find-next-selected-snip</code>, we  cannot immediately remove a selected snip without breaking that chain, so  the code collects all selected snips in the <code>other-selected-snips</code> list and  removes them separately. Technically, there will only be at most one other  selected snip, but the code is written such that it can un-select any number  of snips.</li>
 <li>Each time we remove a snip, the <code>after-select</code> method will be called for  that snip with the <code>on?</code> parameter set to <code>#f</code>, the code needs to be  prepared to handle these calls. Our code could be affected by this since it  sets the <code>opponent-move-locations</code> and <code>valid-move-locations</code> to the empty  list when a snip is unselected &mdash; however since we set the move locations  last for our snip, they will always be set for the selected snip.</li></ul>

<h2 id="moving-the-snip-in-front-when-dragging-it">Moving the snip in front when dragging it</h2>

<p>The snips are stored in the <code>pasteboard%</code> in a list, in the same order as they are added and they are also drawn on the canvas in this order. This drawing order is kept even when a snip is dragged with the mouse and this means that the snip will appear to drag under chess pieces which were added to the <code>pasteboard%</code> before this snip. To drag it above all other pieces, we need to move it to the front of the snip list.</p>

<p>We need to update <code>after-select</code> (again) to call <code>set-before</code> and place the selected chess piece in the front of the list. Our application does not rely on the order in which snips are stored in the <code>pasteboard%</code> so we don&rsquo;t need to do place the snip back in its place after it was moved.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">chess-board%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">pasteboard%</span>
    <span class="c1">;; rest of the chess-board% definition remains unchanged...</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/augment))" style="color: inherit">define/augment</a></span> <span class="p">(</span><span class="n">after-select</span> <span class="n">snip</span> <span class="n">on?</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="n">on?</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span> <span class="n">set-before</span> <span class="n">snip</span> <span class="no">#f</span><span class="p">)</span>
        <span class="c1">;; Rest of the after-select definition remains unchanged...</span>
      <span class="p">))</span>
    <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h2 id="disable-pasteboard-edits-with-the-keyboard-and-clipboard">Disable <code>pasteboard%</code> edits with the keyboard and clipboard</h2>

<p>The <code>pasteboard%</code> is configured as an editor and, as such, it is integrated with the keyboard and the clipboard. For example, you can select a snip than move it with the arrow keys or delete it by pressing Del or Backspace. If the application would have an edit menu, you could also Cut, Copy and Paste these snips. All this is undesired behavior in a chess game and we need to disable it.</p>

<p>To disable the Cut/Copy/Paste operations, we need to override the <code>can-do-edit-operation?</code> method to always return <code>#f</code>. This method is invoked to check if the pasteboard is ready to accept a CUT, COPY, PASTE or some other edit operation where the operation name is passed in as an argument. Since we won&rsquo;t support any, we will simply return <code>#f</code> in this method.</p>

<p>To disable the keyboard, we need to define a new <code>keymap%</code> instance mapping the unwanted keys to an &ldquo;ignore&rdquo; function. This keymap is than installed in the <code>pasteboard%</code> before the internal keymap so it effectively overrides these keys. Note that we could have implemented the &ldquo;up&rdquo;, &ldquo;down&rdquo;, &ldquo;left&rdquo; and &ldquo;right&rdquo; keys to move the piece square by square, by this is left as an exercise to the reader, instead we map them to the &ldquo;ignore&rdquo; function which is defined as a function that displays a message informing the user that the key is disabled &mdash; in a real program, this function would simply do nothing, but displaying a message is more useful in a demo program.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">chess-board%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">pasteboard%</span>
    <span class="c1">;; Rest of the chess-board% definition remains unchanged...</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">can-do-edit-operation?</span> <span class="n">op</span> <span class="n">recursive?</span><span class="p">)</span>
      <span class="no">#f</span><span class="p">)</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">on-disabled-key-event</span> <span class="n">data</span> <span class="n">event</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objectutils.html#(def._((lib._racket/private/class-internal..rkt)._is-a~3f))" style="color: inherit">is-a?</a></span> <span class="n">event</span> <span class="n">key-event%</span><span class="p">)</span>
          <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let*))" style="color: inherit">let*</a></span> <span class="p">((</span><span class="n">code</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">event</span> <span class="n">get-key-code</span><span class="p">))</span>
                 <span class="p">(</span><span class="n">key-name</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._cond))" style="color: inherit">cond</a></span> <span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/symbols.html#(def._((quote._~23~25kernel)._symbol~3f))" style="color: inherit">symbol?</a></span> <span class="n">code</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/symbols.html#(def._((quote._~23~25kernel)._symbol-~3estring))" style="color: inherit">symbol-&gt;string</a></span> <span class="n">code</span><span class="p">))</span>
                                 <span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._equal~3f))" style="color: inherit">equal?</a></span> <span class="n">code</span> <span class="sc">#\backspace</span><span class="p">)</span> <span class="s2">"backspace"</span><span class="p">)</span>
                                 <span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._equal~3f))" style="color: inherit">equal?</a></span> <span class="n">code</span> <span class="sc">#\rubout</span><span class="p">)</span> <span class="s2">"delete"</span><span class="p">)</span>
                                 <span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._equal~3f))" style="color: inherit">equal?</a></span> <span class="n">code</span> <span class="sc">#\space</span><span class="p">)</span> <span class="s2">"space"</span><span class="p">)</span>
                                 <span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._equal~3f))" style="color: inherit">equal?</a></span> <span class="n">code</span> <span class="sc">#\return</span><span class="p">)</span> <span class="s2">"return"</span><span class="p">)</span>
                                 <span class="p">(</span><span class="no">#t</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string))" style="color: inherit">string</a></span> <span class="n">code</span><span class="p">)))))</span>
            <span class="p">(</span><span class="n">set-message</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._format))" style="color: inherit">format</a></span> <span class="s2">"~a key is disabled"</span> <span class="n">key-name</span><span class="p">)))</span>
            <span class="p">(</span><span class="n">set-message</span> <span class="s2">"event is discarded"</span><span class="p">)))</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">k</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">keymap%</span><span class="p">))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">k</span> <span class="n">add-function</span> <span class="s2">"ignore"</span> <span class="n">on-disabled-key-event</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">k</span> <span class="n">map-function</span> <span class="s2">"up"</span> <span class="s2">"ignore"</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">k</span> <span class="n">map-function</span> <span class="s2">"down"</span> <span class="s2">"ignore"</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">k</span> <span class="n">map-function</span> <span class="s2">"left"</span> <span class="s2">"ignore"</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">k</span> <span class="n">map-function</span> <span class="s2">"right"</span> <span class="s2">"ignore"</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">k</span> <span class="n">map-function</span> <span class="s2">"del"</span> <span class="s2">"ignore"</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">k</span> <span class="n">map-function</span> <span class="s2">"backspace"</span> <span class="s2">"ignore"</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span> <span class="n">set-keymap</span> <span class="n">k</span><span class="p">)</span>
  <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>We could have disabled the unwanted keyboard events by overriding the <code>on-char</code> method &mdash; the <code>on-default-char</code> method is not useful for this purpose, as it is invoked only if the key press is not processed by a keymap. However, the <code>on-char</code> method performs some other functions and overriding it correctly is tricky and it is easy to get it wrong and break <code>pasteboard%</code> functionality. It is simpler and safer to use keymaps for this feature.</p>

<h2 id="changing-the-way-selected-chess-pieces-are-highlighted">Changing the way selected chess pieces are highlighted</h2>

<p>By default, the <code>pasteboard%</code> object will draw eight small squares around selected snips (you can see this selection in all the examples in this and previous blog posts), however, we can change the way selection looks.</p>

<p>The drawing of the squares around selected snips can be disabled using the <code>set-selection-visible</code> method, but this will not prevent selecting snips &mdash; snips are still selected, however there is no visual cue to this. We can however change the <code>chess-piece%</code> class to know that it is selected and draw itself in a different way &mdash; to keep this simple, the code is updated to draw selected pieces in red. A new flag <code>selected?</code> is added to this class and it can be set using the <code>set-selected</code> method, than, the <code>draw</code> method is updated to change the text foreground color to red if the chess piece is selected. The <code>set-selected</code> method will also need to inform the snip administrator that this snip has changed the way it is displayed and needs to be re-drawn, this is done using the <code>needs-update</code> method:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">chess-piece%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">snip%</span>
    <span class="c1">;; Rest of the `chess-piece%` definition remains unchanged...</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">selected?</span> <span class="no">#f</span><span class="p">)</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/public))" style="color: inherit">define/public</a></span> <span class="p">(</span><span class="n">set-selected</span> <span class="n">on?</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">selected?</span> <span class="n">on?</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="p">((</span><span class="n">admin</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span> <span class="n">get-admin</span><span class="p">)))</span>
        <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._when))" style="color: inherit">when</a></span> <span class="n">admin</span>
          <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">admin</span> <span class="n">needs-update</span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span> <span class="mi">0</span> <span class="mi">0</span> <span class="n">size</span> <span class="n">size</span><span class="p">))))</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/override))" style="color: inherit">define/override</a></span> <span class="p">(</span><span class="n">draw</span> <span class="n">dc</span> <span class="n">x</span> <span class="n">y</span> <span class="o">.</span> <span class="n">other</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">dc</span> <span class="n">set-font</span> <span class="n">font</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="n">selected?</span>
          <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">dc</span> <span class="n">set-text-foreground</span> <span class="s2">"red"</span><span class="p">)</span>
          <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">dc</span> <span class="n">set-text-foreground</span> <span class="s2">"black"</span><span class="p">))</span>
      <span class="c1">;; Rest of the drawing code remains unchanged...</span>
      <span class="p">)</span>
    <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The <code>chess-board%</code> definition is updated to disable the visible selection by calling <code>set-selection-visible</code> with an <code>#f</code> argument, and the <code>after-select</code> method is updated to inform the chess piece snip whether it was selected or unselected.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">chess-board%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">pasteboard%</span>
    <span class="c1">;; Rest of the chess-board% definition remains unchanged</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span> <span class="n">set-selection-visible</span> <span class="no">#f</span><span class="p">)</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/augment))" style="color: inherit">define/augment</a></span> <span class="p">(</span><span class="n">after-select</span> <span class="n">snip</span> <span class="n">on?</span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">snip</span> <span class="n">set-selected</span> <span class="n">on?</span><span class="p">)</span>
      <span class="c1">;; rest of the `after-select` definition remains unchanged...</span>
      <span class="p">)</span>
    <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h2 id="validating-chess-pieces-as-they-are-added-to-the-board">Validating chess pieces as they are added to the board</h2>

<p>The code, as written so far, has a lot of checks to ensure that the board remains in a consistent state when the user interacts with it, however, as a programmer, one can still create inconsistencies, for example by inserting two chess pieces at the same locations, or by trying to add some snips that are not chess pieces. We can prevent that by overriding the <code>can-insert?</code> method of the <code>pasteboard%</code> which will be called to validate a snip before it is inserted: if this method returns <code>#f</code> the snip will not be inserted in the pasteboard. On our case, we will check if the snip is an instance of <code>chess-piece%</code>, if it has a valid location and if that location is available on the board:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">chess-board%</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._class))" style="color: inherit">class</a></span> <span class="n">pasteboard%</span>
    <span class="c1">;; rest of the `chess-board%` definition remains unchanged...</span>

    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._define/augment))" style="color: inherit">define/augment</a></span> <span class="p">(</span><span class="n">can-insert?</span> <span class="n">snip</span> <span class="o">.</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._rest))" style="color: inherit">rest</a></span><span class="p">)</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span>                             <span class="c1">; We can insert a snip if...</span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objectutils.html#(def._((lib._racket/private/class-internal..rkt)._is-a~3f))" style="color: inherit">is-a?</a></span> <span class="n">snip</span> <span class="n">chess-piece%</span><span class="p">)</span>       <span class="c1">; ... it is an instance of chess-piece%</span>
       <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">snip</span> <span class="n">get-location</span><span class="p">)</span>        <span class="c1">; ... has a location </span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._not))" style="color: inherit">not</a></span> <span class="p">(</span><span class="n">piece-at-location</span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">snip</span> <span class="n">get-location</span><span class="p">)))))</span> <span class="c1">;; ... that location is empty</span>
    <span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The <code>pasteboard%</code> will not report an error if the program tries to insert a snip and <code>can-insert?</code> returns false, instead, the snip is simply not added to the <code>pasteboard%</code>. To check if an insert succeed or not, you can call the <code>is-owned?</code> method on the snip itself after the insert call, the method will return <code>#t</code> of the snip was inserted, and therefore now owned by the <code>pasteboard%</code> and <code>#f</code> if the snip was not inserted.</p>

<h2 id="the-final-chessboard-program">The final chessboard program</h2>

<p>You can find the final version of the program in this <a href="https://gist.github.com/alex-hhh/4817c4d0353e40b72108e7e753c3d0da">GitHub Gist</a>, the entire program, including comments is under 800 lines of code, and it has a lot of functionality for such a small program. In addition to that, the program does not use any external libraries: you can simply install <a href="https://racket-lang.org/">Racket</a> and run the program in DrRacket directly &mdash; it will also run on Linux, Mac OS and Windows without any modifications.</p>

<div class="figure"><img src="/img/a019/chess-board8low.gif" alt="" />
 <p class="caption"></p></div>

<p>This is not a complete program, and it is missing several features from being a complete chess game, but it is really intended to be used for exploring Racket GUI programming and pasteboard% use in particular, so feel free to copy, extend or otherwise experiment with this program.</p>
  <footer>
    <ul class="pager">
    <li class="previous">
      <a href="/2018/11/an-enhanced-text-field-gui-control-for-racket.html">&larr; <em>An enhanced text-field% GUI control for Racket</em></a>
    </li>
    <li class="next">
      <a href="/2018/10/chess-game-using-racket-s-pasteboard-part-2.html"><em>Chess Game Using Racket&rsquo;s Pasteboard (part 2)</em> &rarr;</a>
    </li>
    </ul>
    <script type="text/javascript">
      var disqus_shortname = 'alex-hhh-github-com';
      (function() {
          var dsq = document.createElement('script');
          dsq.type = 'text/javascript';
          dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <div id="disqus_thread"></div>
  </footer>
</article>
        </div>
        <!-- Side bar -->
        <div id="sidebar-content" class="col-md-3">
          <h3>Recent Posts</h3>
          <p><a href='/2019/02/racket-data-structures.html'>An Overview of Common Racket Data Structures</a> <small class='date-and-tags'>
        <time datetime="2019-02-14" pubdate="true">2019-02-14</time></small></p>
        <p><a href='/2019/02/data-visualization-dashboard.html'>Building a Data Visualization Dashboard in Racket</a> <small class='date-and-tags'>
        <time datetime="2019-02-09" pubdate="true">2019-02-09</time></small></p>
        <p><a href='/2018/11/an-enhanced-text-field-gui-control-for-racket.html'>An enhanced text-field% GUI control for Racket</a> <small class='date-and-tags'>
        <time datetime="2018-11-21" pubdate="true">2018-11-21</time></small></p>
        <p><a href='/2018/10/chess-game-using-racket-s-pasteboard-part-3.html'>Chess Game Using Racket&rsquo;s Pasteboard (part 3)</a> <small class='date-and-tags'>
        <time datetime="2018-10-29" pubdate="true">2018-10-29</time></small></p>
        <p><a href='/2018/10/chess-game-using-racket-s-pasteboard-part-2.html'>Chess Game Using Racket&rsquo;s Pasteboard (part 2)</a> <small class='date-and-tags'>
        <time datetime="2018-10-19" pubdate="true">2018-10-19</time></small></p>
        <p><a href='/2018/10/chess-game-using-racket-s-pasteboard.html'>Chess Game Using Racket&rsquo;s Pasteboard</a> <small class='date-and-tags'>
        <time datetime="2018-10-12" pubdate="true">2018-10-12</time></small></p>
        <p><a href='/2018/08/racket-data-frame.html'>Racket Data Frame Package</a> <small class='date-and-tags'>
        <time datetime="2018-08-05" pubdate="true">2018-08-05</time></small></p>
        <p><a href='/2018/06/racket-map-widget.html'>A Racket GUI Widget to display maps based on OpenStreetMap tiles</a> <small class='date-and-tags'>
        <time datetime="2018-06-12" pubdate="true">2018-06-12</time></small></p>
        <p><a href='/2018/05/workout-editor.html'>Running and Cycling Workout Editor</a> <small class='date-and-tags'>
        <time datetime="2018-05-27" pubdate="true">2018-05-27</time></small></p>
        <p><a href='/2018/05/arduino-433mhz-receiver.html'>Arduino 433Mhz Receiver &mdash; Reading Keyfobs</a> <small class='date-and-tags'>
        <time datetime="2018-05-19" pubdate="true">2018-05-19</time></small></p>
        <p><a href='/2018/03/interactive-overlays-with-the-racket-plot-package-update.html'>Interactive Overlays With the Racket Plot Package &mdash; Update</a> <small class='date-and-tags'>
        <time datetime="2018-03-20" pubdate="true">2018-03-20</time></small></p>
        <p><a href='/2018/03/arduino-inclinometer-improvements.html'>Arduino Inclinometer Improvements</a> <small class='date-and-tags'>
        <time datetime="2018-03-09" pubdate="true">2018-03-09</time></small></p>
        <p><a href='/2018/02/interactive-overlays-with-the-racket-plot-package.html'>Interactive Overlays With the Racket Plot Package</a> <small class='date-and-tags'>
        <time datetime="2018-02-03" pubdate="true">2018-02-03</time></small></p>
        <p><a href='/2018/01/changing-built-in-racket-packages.html'>Changing Built-in Racket Packages</a> <small class='date-and-tags'>
        <time datetime="2018-01-29" pubdate="true">2018-01-29</time></small></p>
        <p><a href='/2018/01/equipment-usage-and-costs.html'>Equipment Usage and Costs</a> <small class='date-and-tags'>
        <time datetime="2018-01-14" pubdate="true">2018-01-14</time></small></p>
        <p><a href='/2017/12/running-and-outdoor-temperature.html'>Running and Outdoor Temperature</a> <small class='date-and-tags'>
        <time datetime="2017-12-21" pubdate="true">2017-12-21</time></small></p>
        <p><a href='/2017/12/arduino-inclinometer.html'>Arduino Inclinometer</a> <small class='date-and-tags'>
        <time datetime="2017-12-09" pubdate="true">2017-12-09</time></small></p>
        <p><a href='/2017/11/fatigue-and-running-form.html'>Fatigue and Running Form</a> <small class='date-and-tags'>
        <time datetime="2017-11-28" pubdate="true">2017-11-28</time></small></p>
        <p><a href='/2017/11/quantifying-fatigue.html'>Quantifying Fatigue</a> <small class='date-and-tags'>
        <time datetime="2017-11-25" pubdate="true">2017-11-25</time></small></p>
        <p><a href='/2017/11/bike-trainer.html'>Bike Trainer</a> <small class='date-and-tags'>
        <time datetime="2017-11-14" pubdate="true">2017-11-14</time></small></p>
        </div>
      </div>
      <footer>
        <hr />
        <!-- <p><a href="https://twitter.com/racketlang"
                   class="twitter-follow-button"
                   data-show-count="false"
                   data-lang="en">
                  "Follow RacketLang"
                </a>
                <script type="text/javascript">
                  !function(d,s,id){
                      var js,fjs=d.getElementsByTagName(s)[0];
                      if(!d.getElementById(id)){
                          js=d.createElement(s);
                          js.id=id;
                          js.src="//platform.twitter.com/widgets.js";
                          fjs.parentNode.insertBefore(js,fjs);
                      }
                  }(document,"script","twitter-wjs");
                </script></p> -->
        <p>Site generated
          by <a href="https://github.com/greghendershott/frog">Frog</a>,
          the <strong>fr</strong>ozen bl<strong>og</strong>
          tool. Using <a href="http://twitter.github.com/bootstrap/index.html">Bootstrap</a>. Also
          available as <a href="/feeds/all.atom.xml">Atom</a>
          and <a href="/feeds/all.rss.xml">RSS</a> feeds. . There is also
          a <a href="/Cookies.html">cookie policy</a>.</p>
        <!-- <p><em>Your legal notice here</em>.</p> -->
      </footer>
    </div>
    <!-- </body> JS -->
    <script type="text/javascript" src="//code.jquery.com/jquery.min.js"></script>
    <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  </body>
</html>